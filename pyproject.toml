[tool.ruff]
line-length = 88
target-version = "py311"

[tool.ruff.lint]
# MAXIMUM AUTO-FIXABLE RULES ENABLED
# The goal is to fix as much as possible automatically.
# Rules are selected based on their auto-fix capabilities.
#
# Legend:
# - ALL FIXES: All issues from this plugin can be auto-fixed
# - MOST FIXES: Most issues can be auto-fixed
# - SOME FIXES: Some issues can be auto-fixed
# - NO FIXES: Issues require manual intervention (we still report them)
#
select = [
    # === ESSENTIAL (ALL FIXES) ===
    "F",      # Pyflakes - unused imports, undefined names, etc.
    "E",      # pycodestyle errors - whitespace, indentation, etc.
    "W",      # pycodestyle warnings - whitespace warnings
    "I",      # isort - import sorting
    "UP",     # pyupgrade - upgrade syntax to modern Python

    # === SIMPLIFICATION (MOST FIXES) ===
    "SIM",    # flake8-simplify - simplify code constructs
    "C4",     # flake8-comprehensions - better comprehensions
    "PIE",    # flake8-pie - misc improvements

    # === CODE QUALITY (SOME FIXES) ===
    "B",      # flake8-bugbear - likely bugs and design problems
    "RET",    # flake8-return - return statement issues
    "TCH",    # flake8-type-checking - move imports to TYPE_CHECKING
    "TID",    # flake8-tidy-imports - import hygiene
    "PERF",   # Perflint - performance anti-patterns
    "FURB",   # refurb - modernize code
    "LOG",    # flake8-logging - logging best practices
    "RUF",    # Ruff-specific rules - additional fixes

    # === ADDITIONAL QUALITY (MIXED FIXES) ===
    "A",      # flake8-builtins - don't shadow builtins
    "COM",    # flake8-commas - trailing comma enforcement
    "DTZ",    # flake8-datetimez - timezone-aware datetime
    "FA",     # flake8-future-annotations - __future__ annotations
    "ISC",    # flake8-implicit-str-concat - string concatenation
    "ICN",    # flake8-import-conventions - import aliases
    "G",      # flake8-logging-format - logging format strings
    "INP",    # flake8-no-pep420 - implicit namespace packages
    "PIE",    # flake8-pie - misc improvements
    "Q",      # flake8-quotes - quote consistency
    "RSE",    # flake8-raise - raise statement improvements
    "SLF",    # flake8-self - private member access
    "SLOT",   # flake8-slots - __slots__ enforcement
    "INT",    # flake8-gettext - i18n issues
    "PGH",    # pygrep-hooks - misc issues
    "PL",     # Pylint - comprehensive linting
    "FLY",    # flynt - f-string conversion
    "ASYNC",  # flake8-async - async issues
    "PYI",    # flake8-pyi - type stub issues

    # === TESTING (IF TESTS EXIST) ===
    "PT",     # flake8-pytest-style - pytest best practices

    # === UNCOMMON BUT USEFUL ===
    "ARG",    # flake8-unused-arguments - unused function args
    "PTH",    # flake8-use-pathlib - use pathlib instead of os.path
    "EM",     # flake8-errmsg - exception message best practices
    "TRY",    # tryceratops - exception handling best practices
    "N",      # pep8-naming - naming conventions
    "YTT",    # flake8-2020 - sys.version checks
]

# Ignore rules that are too aggressive, noisy, or not auto-fixable
ignore = [
    # Line length (handled by formatters)
    "E501",    # Line too long
    "W505",    # Doc line too long

    # Too opinionated for auto-fix
    "B008",    # Do not perform function calls in argument defaults
    "B904",    # Within an `except` clause, raise exceptions with `raise ... from`
    "RET504",  # Unnecessary assignment before return statement
    "PLR0913", # Too many arguments to function call
    "PLR2004", # Magic value used in comparison
    "PLR0911", # Too many return statements
    "PLR0912", # Too many branches
    "PLR0915", # Too many statements
    "PLW2901", # Outer loop variable overwritten by inner loop

    # Testing rules that are too strict
    "PT011",   # pytest.raises without match
    "PT012",   # pytest.raises with too broad exception

    # Naming - too noisy for existing codebases
    "N802",    # Function name should be lowercase
    "N803",    # Argument name should be lowercase
    "N806",    # Variable in function should be lowercase
    "N815",    # Variable in class scope should not be mixedCase
    "N816",    # Variable in global scope should not be mixedCase

    # Exception messages - can be too strict
    "EM101",   # Exception must not use a string literal
    "EM102",   # Exception must not use an f-string literal
    "TRY003",  # Avoid specifying long messages outside exception class

    # Imports - covered by other tools
    "INP001",  # Missing __init__.py (not always needed in Python 3)

    # Pylint - too noisy
    "PLR0904", # Too many public methods
    "PLC0415", # Import outside toplevel
    "PLW0603", # Using global statement

    # Self - can be noisy for internal access patterns
    "SLF001",  # Private member accessed

    # Slots - too invasive for existing code
    "SLOT000", # Subclasses of non-slot classes should not define slots
    "SLOT001", # Subclasses of non-slot classes should not define slots

    # Type checking - can cause issues
    "TCH001",  # Move application import into TYPE_CHECKING block
    "TCH002",  # Move third-party import into TYPE_CHECKING block
    "TCH003",  # Move standard library import into TYPE_CHECKING block

    # Path-related - too invasive
    "PTH123",  # open() should be replaced by Path.open()

    # Commas - can conflict with black
    "COM812",  # Trailing comma missing

    # ISC - can conflict with black
    "ISC001",  # Implicitly concatenated string literals on one line
]

# Allow autofix for all enabled rules when possible
[tool.ruff.lint.per-file-ignores]
# Tests can have more relaxed rules
"tests/**/*.py" = ["S101", "ARG", "PLR2004"]
# Scripts can use print
"scripts/**/*.py" = ["T201"]
# Init files can have unused imports (re-exports)
"__init__.py" = ["F401"]

[tool.ruff.lint.pycodestyle]
max-doc-length = 88

[tool.ruff.lint.isort]
# Make isort compatible with black
combine-as-imports = true
force-wrap-aliases = true
known-first-party = ["api", "core", "db", "routes", "tasks", "trips", "visits", "exports", "coverage", "analytics"]

[tool.ruff.lint.pylint]
max-args = 10
max-branches = 15
max-statements = 60

[tool.ruff.format]
# Format code and wrap lines (including comments) to 88 characters
docstring-code-line-length = 88
docstring-code-format = true
skip-magic-trailing-comma = false



[tool.vulture]
# Folders to ignore completely
exclude = [
    "venv",
    "node_modules",
    ".cursor",
    "__pycache__",
    "static",
    "scripts",
    "tests",
    "db/models.py",
    "db/schemas.py",
    "exports/models.py",
    "street_coverage/models.py",
    "trips/models.py",
    "whitelist.py"  # Don't scan the whitelist file itself as code
]

# Patterns to assume are always used (API routes, Tasks, Configs)
ignore_names = [
    "*_endpoint",
    "*_handler",
    "*_page",
    "*_route",
    "*_task",
    "*_last_check",
    "*_response_time_ms",
    "startup_event",
    "shutdown_event",
    "on_starting",   # Gunicorn
    "on_exit",       # Gunicorn
    "post_fork",     # Gunicorn
    "worker_abort",  # Gunicorn
    "Config",        # Pydantic/SQLAlchemy
    "Meta",          # Pydantic/SQLAlchemy
    "Settings",      # Pydantic/Beanie
    "model_config",  # Pydantic v2 config
    "indexes",       # Beanie index definitions
    "from_attributes",
    "total_in_viewport",
    "overall_healthy",
    "nominatim_data_timestamp",
    "nominatim_version",
    "valhalla_version",
    "WorkerSettings",
    "_state",
    "last_modified",
    "creator",
    "miles_since_last_fillup",
    "odometer_updated_at",
    "avgSpeed",
    "totalIdleDuration",
    "hardBrakingCounts",
    "hardAccelerationCounts",
    "endTimeZone",
    "fuelConsumed",
    "closed_reason",
    "driven_by_trip_id",
    "manually_marked",
    "marked_at",
    "nickName",
    "last_synced_at",
    "__getattr__",
    "__dir__",
]

# Decorators that imply runtime usage (FastAPI)
ignore_decorators = [
    "@router.*",
    "@app.*",
]

# Paths to scan (current directory)
paths = ["."]

# Minimum confidence (60% is default, 100% is very strict)
min_confidence = 60

[tool.pytest.ini_options]
testpaths = ["tests"]
addopts = "-ra --cov=core.api --cov=core.exceptions --cov=core.http.geocoding --cov=core.http.nominatim --cov=core.http.retry --cov=core.http.session --cov=core.http.valhalla --cov=core.math_utils --cov=db.aggregation --cov=db.models --cov=db.query --cov=core.date_utils --cov=exports.auth --cov=exports.models --cov=exports.serializers --cov=exports.services.export_service --cov=exports.services.export_writer --cov=routes.routing --cov=setup.services.bouncie_credentials --cov=setup.services.bouncie_oauth --cov=tracking.routes.webhooks --cov-report=term-missing --cov-report=lcov:coverage.lcov --cov-fail-under=80 -m 'not integration'"
asyncio_mode = "auto"
markers = [
  "integration: tests that require live Valhalla/Nominatim services",
]
