{% extends "base.html" %}

{% block title %}

 Coverage Management
{% endblock %}


{% block
head_content %}

  <meta name="mapbox-access-token" content="{{ MAPBOX_ACCESS_TOKEN }}" />

  <!-- Mapbox GL CSS -->
  <link rel="stylesheet" href="{{ CDN.mapbox_gl_css }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/coverage-management.css') | replace('http://', '//') }}?v={{ repo_version.commit_count }}" />
{% endblock %}


{% block content %}


  <div class="container-fluid">
    <div class="bento-grid" data-stagger>
      <div class="bento-span-12 widget" data-accent="amber">
        <div class="widget-header">
          <div>
            <h1 class="widget-title">
              <i class="fas fa-map-marked-alt" aria-hidden="true"></i>
            Coverage Management
            </h1>
            <div class="widget-meta">
            Track street coverage across your areas. Coverage updates automatically as
            you drive.
            </div>
          </div>
          <div class="d-flex flex-column align-items-md-end">
            <div class="text-secondary small mb-2">
Total Coverage Areas
            </div>
            <div class="display-4 fw-bold text-primary" id="total-areas-count">
0
            </div>
          </div>
        </div>
      </div>

      <!-- Alerts container -->
      <div class="bento-span-12" id="alerts-container">
      </div>

      <!-- Quick Actions -->
      <div class="bento-span-6">
        <div class="widget"
             data-accent="lime"
             data-bs-toggle="modal"
             data-bs-target="#addAreaModal"
             style="cursor: pointer">
          <div class="widget-body text-center">
            <i class="fas fa-plus-circle fa-2x mb-2"></i>
            <h5 class="card-title mt-2 mb-1">
Add New Area
            </h5>
            <p class="card-text small text-secondary mb-0">
            Start tracking a new location
            </p>
          </div>
        </div>
      </div>
      <div class="bento-span-6">
        <div class="widget" data-accent="sky" id="quick-refresh-all" style="cursor: pointer">
          <div class="widget-body text-center">
            <i class="fas fa-sync-alt fa-2x mb-2"></i>
            <h5 class="card-title mt-2 mb-1">
Refresh Data
            </h5>
            <p class="card-text small text-secondary mb-0">
Reload coverage statistics
            </p>
          </div>
        </div>
      </div>

      <!-- Coverage Areas Table -->
      <div class="bento-span-12 widget" data-accent="purple">
        <div class="widget-header">
          <h3 class="widget-title">
            <i class="fas fa-list" aria-hidden="true"></i>
          Coverage Areas
          </h3>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary"
                    id="refresh-table-btn"
                    data-bs-toggle="tooltip"
                    title="Refresh table">
              <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-sm btn-success"
                    data-bs-toggle="modal"
                    data-bs-target="#addAreaModal">
              <i class="fas fa-plus"></i> Add Area
            </button>
          </div>
        </div>
        <div class="widget-body">
          <div class="table-responsive-lg">
            <table class="table table-hover" id="coverage-areas-table">
              <thead>
                <tr>
                  <th>
Location
                  </th>
                  <th>
Status
                  </th>
                  <th>
Total Length
                  </th>
                  <th>
Driven
                  </th>
                  <th>
Coverage
                  </th>
                  <th>
Last Updated
                  </th>
                  <th>
Actions
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="7" class="text-center p-4">
                    <div class="spinner-border text-primary spinner-border-sm mb-2" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0 text-secondary">
Loading coverage areas...
                    </p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="coverage-error-panel"
               class="coverage-error-panel d-none"
               role="alert"
               aria-live="polite">
            <div class="coverage-error-header">
              <div class="coverage-error-title">
                <span class="coverage-error-icon">
                  <i class="fas fa-triangle-exclamation"></i>
                </span>
                <div>
                  <div id="coverage-error-title">
Coverage calculation error
                  </div>
                  <div class="coverage-error-area" id="coverage-error-area">
                  </div>
                </div>
              </div>
              <button type="button"
                      class="btn btn-sm btn-outline-secondary coverage-error-dismiss"
                      id="coverage-error-dismiss"
                      aria-label="Dismiss error details">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="coverage-error-body">
              <div class="coverage-error-label">
Error details
              </div>
              <pre class="coverage-error-message" id="coverage-error-message"></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Coverage Dashboard Section -->
      <div class="bento-span-12 widget"
           id="coverage-dashboard"
           data-accent="sky"
           style="display: none">
        <div class="widget-header">
          <h3 class="widget-title">
            <i class="fas fa-chart-line" aria-hidden="true"></i>
            <span id="dashboard-location-name" class="text-info">Select a location</span>
          </h3>
          <button class="btn btn-sm btn-outline-secondary" id="close-dashboard-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="widget-body">
          <div class="row">
            <!-- Stats Overview -->
            <div class="col-lg-3">
              <div class="card bg-darker mb-3">
                <div class="card-header">
                  <h4 class="h6 mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Statistics
                  </h4>
                </div>
                <div class="card-body">
                  <div class="stat-item mb-3">
                    <div class="stat-value h4" id="dashboard-total-length">
0 mi
                    </div>
                    <div class="stat-label text-secondary small">
Total Length
                    </div>
                  </div>
                  <div class="stat-item mb-3">
                    <div class="stat-value h4 text-success" id="dashboard-driven-length">
                    0 mi
                    </div>
                    <div class="stat-label text-secondary small">
Driven
                    </div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value h3 text-primary"
                         id="dashboard-coverage-percentage"
                         data-coverage-percent
                         data-value-flash>
                    0%
                    </div>
                    <div class="stat-label text-secondary small">
Coverage
                    </div>
                  </div>
                </div>
              </div>

              <!-- Segment Status -->
              <div class="card bg-darker">
                <div class="card-header">
                  <h4 class="h6 mb-0">
                    <i class="fas fa-road me-2"></i>Segments
                  </h4>
                </div>
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-success"><i class="fas fa-check-circle me-1"></i>Driven</span>
                    <span id="segments-driven">0</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-danger"><i class="fas fa-times-circle me-1"></i>Undriven</span>
                    <span id="segments-undriven">0</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span class="text-secondary"><i class="fas fa-ban me-1"></i>Undriveable</span>
                    <span id="segments-undriveable">0</span>
                  </div>
                </div>
              </div>

              <!-- Actions -->
              <div class="card bg-darker mt-3">
                <div class="card-header">
                  <h4 class="h6 mb-0">
                    <i class="fas fa-cogs me-2"></i>Actions
                  </h4>
                </div>
                <div class="card-body">
                  <button class="btn btn-info btn-sm w-100 mb-2" id="recalculate-coverage-btn">
                    <i class="fas fa-calculator me-1"></i>Recalculate Coverage
                  </button>
                  <button class="btn btn-outline-warning btn-sm w-100" id="rebuild-area-btn">
                    <i class="fas fa-sync me-1"></i>Rebuild from OSM
                  </button>
                </div>
              </div>
            </div>

            <!-- Map View -->
            <div class="col-lg-9">
              <div class="card bg-darker h-100">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h4 class="h6 mb-0">
                      <i class="fas fa-map me-2"></i>Coverage Map
                    </h4>
                    <div class="btn-group btn-group-sm" role="group">
                      <button class="btn btn-primary active" data-filter="all">
                      All
                      </button>
                      <button class="btn btn-outline-success" data-filter="driven">
                      Driven
                      </button>
                      <button class="btn btn-outline-danger" data-filter="undriven">
                      Undriven
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body p-0">
                  <div id="coverage-map" class="coverage-map-container">
                    <div class="map-loading d-flex justify-content-center align-items-center h-100">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading map...</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="card-footer">
                  <div class="map-legend d-flex gap-4 justify-content-center">
                    <div class="coverage-map-legend-item">
                      <div class="coverage-map-legend-swatch coverage-map-legend-swatch--undriven">
                      </div>
                      <small>Undriven</small>
                    </div>
                    <div class="coverage-map-legend-item">
                      <div class="coverage-map-legend-swatch coverage-map-legend-swatch--driven">
                      </div>
                      <small>Driven</small>
                    </div>
                    <div class="coverage-map-legend-item">
                      <div class="coverage-map-legend-swatch coverage-map-legend-swatch--undriveable">
                      </div>
                      <small>Undriveable</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Area Modal - Simplified -->
  <div class="modal fade" id="addAreaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-plus-circle me-2"></i>Add Coverage Area
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal">
          </button>
        </div>
        <div class="modal-body">
          <form id="add-area-form">
            <div class="mb-3">
              <label for="location-input" class="form-label">
 Location Name
              </label>
              <input type="text"
                     id="location-input"
                     class="form-control"
                     placeholder="e.g., Waco, TX"
                     required />
              <small class="form-text text-secondary">
              Enter a city, county, or state name
              </small>
            </div>
            <div class="mb-3">
              <label for="location-type" class="form-label">
 Area Type
              </label>
              <select id="location-type" class="form-select">
                <option value="city" selected>
City
                </option>
                <option value="county">
County
                </option>
                <option value="state">
State
                </option>
              </select>
            </div>

            <div class="coverage-validation" id="coverage-validation-panel">
              <div id="location-validation-status"
                   class="validation-status"
                   role="status"
                   aria-live="polite">
                <span class="status-icon">
                  <i class="fas fa-location-dot" aria-hidden="true"></i>
                </span>
                <span>Enter a location to validate.</span>
              </div>
              <div id="location-validation-note"
                   class="validation-note text-secondary small d-none">
              </div>
              <div id="location-validation-candidates"
                   class="validation-candidates"
                   role="listbox"
                   aria-label="Validation matches">
              </div>
              <div id="location-validation-confirmation"
                   class="alert alert-success validation-confirmation d-none"
                   role="status"
                   aria-live="polite">
              </div>
              <small class="form-text text-secondary mt-2">
              Validate and confirm the correct location before adding.
              </small>
            </div>
          </form>

          <div class="alert alert-info small" role="alert">
            <i class="fas fa-info-circle me-2"></i>
          After adding, the area will automatically:
            <ul class="mb-0 mt-2">
              <li>
Load street data from the local OSM extract
              </li>
              <li>
Calculate coverage from your existing trips
              </li>
              <li>
Update automatically as you drive
              </li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancel
          </button>
          <button type="button"
                  id="add-coverage-area"
                  class="btn btn-success"
                  disabled
                  aria-disabled="true">
            <i class="fas fa-plus me-1"></i>Add Area
          </button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}


{# Page scripts are loaded via route-loader + swup. #}
