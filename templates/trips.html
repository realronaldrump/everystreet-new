{% extends "base.html" %}

{% block title %}

Every Street - Trips
{% endblock %}

{% block extra_css %}

  <!-- Mapbox GL CSS -->
  <link rel="stylesheet" href="{{ CDN.mapbox_gl_css }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/features/map/index.css') | replace('http://', '//') }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/trips.css') | replace('http://', '//') }}" />
{% endblock %}


{% block content %}

  <div class="container-fluid px-4 py-3">
    <div class="bento-grid" data-stagger>
      <div class="bento-span-12 widget" data-accent="sky">
        <div class="widget-header">
          <div>
            <h1 class="widget-title">
              <i class="fas fa-road" aria-hidden="true"></i>
              Trips
            </h1>
            <div class="widget-meta">
              Review, filter, and manage your driving history.
            </div>
          </div>
        </div>
      </div>

      <div class="bento-span-12 widget trip-sync-widget" data-accent="amber">
        <div class="widget-header">
          <div>
            <h2 class="widget-title">
              <i class="fas fa-sync-alt" aria-hidden="true"></i>
              Trip Sync
            </h2>
            <div class="widget-meta">
              Refresh trips from your connected vehicle source.
            </div>
          </div>
          <div class="trip-sync-actions">
            <button class="btn btn-primary" id="sync-trips-btn">
              <i class="fas fa-sync"></i>
              Sync trips
            </button>
            <button class="btn btn-outline-secondary" id="sync-history-btn">
              <i class="fas fa-cloud-download-alt"></i>
              Import history
            </button>
            <a class="btn btn-outline-secondary" href="/settings#sync-settings">
              <i class="fas fa-sliders-h"></i>
              Sync settings
            </a>
          </div>
        </div>
        <div class="widget-body">
          <div class="trip-sync-status-row">
            <span class="trip-sync-pill"
                  id="trip-sync-pill"
                  data-state="idle"
                  data-tone="success">
              <i class="fas fa-check-circle"></i>
              <span>Up to date</span>
            </span>
            <span class="trip-sync-status-text" id="trip-sync-status-text">
              Trips are ready to explore.
            </span>
          </div>
          <div class="trip-sync-meta-row">
            <div class="trip-sync-meta">
              <span class="trip-sync-meta-label">Last updated</span>
              <span id="trip-sync-last-success">--</span>
            </div>
            <div class="trip-sync-meta">
              <span class="trip-sync-meta-label">Last attempt</span>
              <span id="trip-sync-last-attempt">--</span>
            </div>
          </div>
          <div class="trip-sync-error d-none" id="trip-sync-error">
            <div>
              <div class="trip-sync-error-title">
Action needed
              </div>
              <div class="trip-sync-error-message" id="trip-sync-error-message">
                Sync needs attention.
              </div>
            </div>
            <a class="btn btn-outline-light btn-sm"
               id="trip-sync-error-cta"
               href="/settings#sync-settings">
              Review
            </a>
          </div>
          <div class="trip-sync-empty d-none" id="trip-sync-empty">
            <div>
              <div class="trip-sync-empty-title">
No trips yet
              </div>
              <div class="trip-sync-empty-message">
                Sync trips to start building your history.
              </div>
            </div>
            <button class="btn btn-primary btn-sm" id="trip-sync-empty-btn">
              Sync trips
            </button>
          </div>
        </div>
      </div>

      <div class="bento-span-12 widget" data-accent="mint">
        <div class="widget-header">
          <div>
            <h2 class="widget-title">
              <i class="fas fa-sliders-h" aria-hidden="true"></i>
              Filters
            </h2>
            <div class="widget-meta">
              Choose vehicle, date window, and performance limits.
            </div>
          </div>
        </div>
        <div class="widget-body">
          <div id="active-filter-chips" class="filter-chip-row">
          </div>
          <div class="filter-grid grid gap-3 items-end md:grid-cols-2 lg:grid-cols-5">
            <div>
              <label for="trip-filter-vehicle" class="form-label">
Vehicle
              </label>
              <select id="trip-filter-vehicle" class="form-select">
                <option value="">
All vehicles
                </option>
              </select>
            </div>
            <div>
              <label class="form-label">
Distance (mi)
              </label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-road"></i></span>
                <input type="number"
                       class="form-control"
                       id="trip-filter-distance-min"
                       placeholder="Min"
                       step="0.1" />
                <span class="input-group-text">-</span>
                <input type="number"
                       class="form-control"
                       id="trip-filter-distance-max"
                       placeholder="Max"
                       step="0.1" />
              </div>
            </div>
            <div>
              <label class="form-label">
Max Speed (mph)
              </label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-tachometer-alt"></i></span>
                <input type="number"
                       class="form-control"
                       id="trip-filter-speed-min"
                       placeholder="Min"
                       step="1" />
                <span class="input-group-text">-</span>
                <input type="number"
                       class="form-control"
                       id="trip-filter-speed-max"
                       placeholder="Max"
                       step="1" />
              </div>
            </div>
            <div>
              <label class="form-label">
Fuel (gal)
              </label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-gas-pump"></i></span>
                <input type="number"
                       class="form-control"
                       id="trip-filter-fuel-min"
                       placeholder="Min"
                       step="0.01" />
                <span class="input-group-text">-</span>
                <input type="number"
                       class="form-control"
                       id="trip-filter-fuel-max"
                       placeholder="Max"
                       step="0.01" />
              </div>
            </div>
            <div class="flex items-center">
              <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" id="trip-filter-has-fuel" />
                <label class="form-check-label" for="trip-filter-has-fuel">
                Has Fuel
                </label>
              </div>
            </div>
          </div>
          <div class="filter-actions flex flex-wrap justify-between items-center gap-3">
            <div class="filter-helper-text" id="filter-helper-text">
            Adjust filters then apply to refresh results. Active filters appear as
            chips above.
            </div>
            <div class="flex gap-2">
              <button class="btn btn-primary" id="trip-filter-apply">
                <i class="fas fa-check"></i> Apply filters
              </button>
              <button class="btn btn-outline-secondary" id="trip-filter-reset">
                <i class="fas fa-undo"></i> Reset
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="bento-span-12 widget" data-accent="purple">
        <div class="widget-header">
          <div>
            <h2 class="widget-title">
              <i class="fas fa-table" aria-hidden="true"></i>
              Trip History
            </h2>
            <div class="widget-meta">
Manage trips, bulk actions, and details.
            </div>
          </div>
        </div>
        <div class="widget-body">
          <div class="trips-actions-bar">
            <label class="trips-select-all">
              <input type="checkbox" id="select-all-trips" />
              <span class="trips-select-all-text">Select All</span>
            </label>
            <div class="trips-actions-buttons">
              <button id="bulk-delete-trips-btn" class="btn btn-danger btn-sm" disabled>
                <i class="fas fa-trash"></i>
                <span class="btn-text">Delete Selected</span>
              </button>
              <button id="refresh-geocoding-btn" class="btn btn-primary btn-sm">
                <i class="fas fa-sync"></i>
                <span class="btn-text">Refresh Geocoding</span>
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table id="trips-table" class="table table-striped table-hover w-full">
              <thead>
                <tr>
                  <th class="col-checkbox">
                    <!-- Select all moved to action bar -->
                  </th>
                  <th data-sortable="true">
Trip
                  </th>
                  <th data-sortable="true">
Date
                  </th>
                  <th data-sortable="true">
Route
                  </th>
                  <th class="col-hide-mobile" data-sortable="true">
Performance
                  </th>
                  <th class="col-hide-mobile" data-sortable="true">
Fuel &amp; Cost
                  </th>
                  <th>
Actions
                  </th>
                </tr>
              </thead>
              <tbody>
                <!-- Data populated by DataTables -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Trip Details Modal -->
    <div class="modal fade" id="tripDetailsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h5 class="modal-title" id="tripModalTitle">
Trip Details
              </h5>
              <div class="text-secondary text-xs" id="tripModalSubtitle">
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
            </button>
          </div>
          <div class="modal-body p-0">
            <div class="grid gap-0 lg:grid-cols-12">
              <!-- Map Column -->
              <div class="lg:col-span-8 relative min-h-[400px] h-[60vh]">
                <div id="trip-modal-map" class="h-full w-full">
                </div>
                <div class="trip-playback-controls glass" aria-label="Trip playback controls">
                  <button class="btn btn-sm btn-primary" id="trip-playback-toggle" aria-pressed="false">
                    <i class="fas fa-play"></i>
                    <span>Play</span>
                  </button>
                  <div class="trip-playback-speed">
                    <label for="trip-playback-speed" class="form-label">
Speed
                    </label>
                    <input type="range"
                           class="form-range"
                           id="trip-playback-speed"
                           min="0.5"
                           max="3"
                           step="0.5"
                           value="1" />
                    <span id="trip-playback-speed-label" class="speed-label">1.0x</span>
                  </div>
                </div>
                <!-- Loading Overlay for Map -->
                <div id="trip-map-loading"
                     class="absolute inset-0 flex items-center justify-center bg-black/75 d-none"
                     style="z-index: 10">
                  <div class="text-center">
                    <div class="spinner-border text-primary mb-2" role="status">
                    </div>
                    <div>
Loading trip data...
                    </div>
                  </div>
                </div>
              </div>
              <!-- Details Column -->
              <div class="lg:col-span-4 p-4 overflow-auto max-h-[60vh]">
                <h6 class="text-uppercase text-secondary text-xs font-semibold mb-3">
Statistics
                </h6>

                <div class="flex items-center mb-4">
                  <div class="mr-3 text-center w-10">
                    <i class="fas fa-road fa-lg text-primary"></i>
                  </div>
                  <div>
                    <div class="text-xs text-secondary">
Distance
                    </div>
                    <div class="text-lg font-medium" id="modal-distance">
--
                    </div>
                  </div>
                </div>

                <div class="flex items-center mb-4">
                  <div class="mr-3 text-center w-10">
                    <i class="fas fa-clock fa-lg text-info"></i>
                  </div>
                  <div>
                    <div class="text-xs text-secondary">
Duration
                    </div>
                    <div class="text-lg font-medium" id="modal-duration">
--
                    </div>
                  </div>
                </div>

                <div class="flex items-center mb-4">
                  <div class="mr-3 text-center w-10">
                    <i class="fas fa-tachometer-alt fa-lg text-warning"></i>
                  </div>
                  <div>
                    <div class="text-xs text-secondary">
Max Speed
                    </div>
                    <div class="text-lg font-medium" id="modal-max-speed">
--
                    </div>
                  </div>
                </div>

                <div class="flex items-center mb-4">
                  <div class="mr-3 text-center w-10">
                    <i class="fas fa-gas-pump fa-lg text-danger"></i>
                  </div>
                  <div>
                    <div class="text-xs text-secondary">
Fuel Consumed
                    </div>
                    <div class="text-lg font-medium" id="modal-fuel">
--
                    </div>
                  </div>
                </div>

                <hr />

                <h6 class="text-uppercase text-secondary text-xs font-semibold mb-3">
Locations
                </h6>
                <div class="mb-3">
                  <div class="text-xs text-secondary mb-1">
Start
                  </div>
                  <div class="flex">
                    <i class="fas fa-map-marker-alt text-success mt-1 mr-2"></i>
                    <span id="modal-start-loc">--</span>
                  </div>
                </div>
                <div>
                  <div class="text-xs text-secondary mb-1">
End
                  </div>
                  <div class="flex">
                    <i class="fas fa-map-marker-alt text-danger mt-1 mr-2"></i>
                    <span id="modal-end-loc">--</span>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="tripSyncHistoryModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
Import trip history
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
            </button>
          </div>
          <div class="modal-body">
            <p class="text-secondary">
              Importing history fetches older trips in the background. You can keep using
              the app while it runs.
            </p>
            <label for="trip-sync-history-start" class="form-label">
Start date (optional)
            </label>
            <input type="datetime-local" class="form-control" id="trip-sync-history-start" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="trip-sync-history-confirm">
              Start import
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{% block extra_js %}

  <!-- Mapbox GL JS -->
  <script src="{{ CDN.mapbox_gl_js }}"></script>
  <script>
      window.MAPBOX_ACCESS_TOKEN = "{{ MAPBOX_ACCESS_TOKEN }}";
  </script>

  <script type="module"
          src="{{ url_for('static', path='js/pages/trips.js') | replace('http://', '//') }}"></script>
{% endblock %}
