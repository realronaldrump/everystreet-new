{% extends "base.html" %}

{% block title %}

Profile Settings
{% endblock %}

{% block extra_css %}

  <link rel="stylesheet"
        href="{{ url_for('static', path='css/settings.css') | replace('http://', '//') }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/profile.css') | replace('http://', '//') }}" />

{% endblock %}


{% block content %}

  <div class="container-fluid settings-container">
    <div class="bento-grid" data-stagger>
      <div class="bento-span-12 widget" data-accent="purple">
        <div class="widget-header">
          <h2 class="widget-title">
            <i class="fas fa-user-circle" aria-hidden="true"></i>
            Profile Settings
          </h2>
        </div>
      </div>

      <!-- Credentials Status Banner -->
      <div id="credentials-status-banner"
           class="credentials-status bento-span-12"
           style="display: none"
           role="status"
           aria-live="polite"
           aria-atomic="true">
        <i class="fas fa-info-circle"></i>
        <span id="credentials-status-text"></span>
      </div>

      <!-- Bouncie API Credentials -->
      <div class="settings-group bento-span-12">
      <h3 class="settings-group-title">
        <i class="fas fa-key"></i>
      Bouncie API Credentials
      </h3>
      <p class="text-muted small">
      Configure your Bouncie API credentials for trip fetching. These credentials
      are stored securely in the database and will be used for all API requests.
      </p>

      <form id="bouncieCredentialsForm" data-editing="false" aria-disabled="true">
        <div class="profile-edit-bar">
          <div class="profile-edit-state">
            <span id="profileEditStateLabel"
                  class="edit-state-pill"
                  role="status"
                  aria-live="polite">
            Read-only
            </span>
            <span id="profileEditDirty" class="edit-dirty-indicator" hidden>
            Unsaved changes
            </span>
          </div>
          <div class="profile-edit-actions">
            <button type="button"
                    class="btn btn-outline-primary view-only"
                    id="editProfileBtn"
                    aria-pressed="false">
              <i class="fas fa-pen"></i> Enable Editing
            </button>
            <button type="button" class="btn btn-secondary edit-only" id="cancelEditBtn" disabled>
              <i class="fas fa-undo"></i> Cancel
            </button>
            <button type="submit"
                    class="btn btn-primary edit-only"
                    id="saveCredentialsBtn"
                    disabled>
              <i class="fas fa-save"></i> Save Changes
            </button>
          </div>
        </div>
        <p class="form-text edit-help-text" id="editModeHelpText">
        Editing is locked to prevent accidental changes. Enable editing to update
        your credentials.
        </p>
        <fieldset id="profileEditableFields"
                  class="profile-edit-fields"
                  disabled
                  aria-describedby="editModeHelpText">
          <legend class="visually-hidden">
Bouncie credentials
          </legend>
          <!-- Client ID -->
          <div class="mb-3">
            <label for="clientId" class="form-label">
                                                                                                                                                                                                                                                                                                          Client ID <span class="text-danger">*</span>
          </label>
          <input type="text"
                 class="form-control credential-input"
                 id="clientId"
                 data-editable="true"
                 disabled
                 placeholder="Enter your Bouncie Client ID"
                 required />
          <div class="form-text">
          Your Bouncie application's client identifier
          </div>
        </div>

        <!-- Client Secret -->
        <div class="mb-3">
          <label for="clientSecret" class="form-label">
                                                                                                                                                                                                              Client Secret <span class="text-danger">*</span>
        </label>
        <div class="input-group">
          <input type="password"
                 class="form-control credential-input"
                 id="clientSecret"
                 data-editable="true"
                 disabled
                 placeholder="Enter your Bouncie Client Secret"
                 required />
          <button class="btn btn-outline-secondary"
                  type="button"
                  id="toggleClientSecret"
                  data-editable="true"
                  disabled>
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="form-text">
          Your Bouncie application's client secret (kept secure)
        </div>
      </div>

      <!-- Redirect URI -->
      <div class="mb-3">
        <label for="redirectUri" class="form-label">
                                                                                                                  Redirect URI <span class="text-danger">*</span>
      </label>
      <input type="url"
             class="form-control credential-input"
             id="redirectUri"
             data-editable="true"
             disabled
             placeholder="https://your-domain.com/callback"
             required />
      <div class="form-text">
          The OAuth callback URL configured in your Bouncie application
      </div>
    </div>

    <!-- Authorization Code -->
    <div class="mb-3">
      <label for="authorizationCode" class="form-label">
                                                                                                              Authorization Code <span class="text-danger">*</span>
    </label>
    <div class="input-group">
      <input type="password"
             class="form-control credential-input"
             id="authorizationCode"
             data-editable="true"
             disabled
             placeholder="Enter your Bouncie Authorization Code"
             required />
      <button class="btn btn-outline-secondary"
              type="button"
              id="toggleAuthCode"
              data-editable="true"
              disabled>
        <i class="fas fa-eye"></i>
      </button>
    </div>
    <div class="form-text">
          The authorization code obtained from Bouncie OAuth flow
    </div>
  </div>

  <!-- Authorized Devices -->
  <div class="mb-3">
    <label class="form-label">
                                                                                                          Authorized Devices (IMEIs) <span class="text-danger">*</span>
  </label>
  <div id="devicesList">
    <!-- Device inputs will be added here dynamically -->
  </div>
  <button type="button"
          class="btn btn-sm btn-outline-primary"
          id="addDeviceBtn"
          data-editable="true"
          disabled>
    <i class="fas fa-plus"></i> Add Device
  </button>
  <div class="form-text">
          IMEI numbers of devices authorized to fetch trip data from
  </div>
</div>

<!-- Fetch Concurrency -->
<div class="mb-3">
  <label for="fetchConcurrency" class="form-label">
          Fetch Concurrency
  </label>
  <input type="number"
         class="form-control"
         id="fetchConcurrency"
         data-editable="true"
         disabled
         placeholder="12"
         min="1"
         max="50"
         value="12" />
  <div class="form-text">
          Maximum number of concurrent API requests when fetching trips (1-50, default: 12)
  </div>
</div>
</fieldset>

<!-- View-only Actions -->
<div class="d-flex gap-2 flex-wrap profile-view-actions">
  <button type="button" class="btn btn-secondary view-only" id="loadCredentialsBtn">
    <i class="fas fa-sync"></i> Reload
  </button>
  <button type="button" class="btn btn-info view-only" id="unmaskCredentialsBtn">
    <i class="fas fa-eye"></i> Unmask All
  </button>
</div>

<div id="credentialsSaveStatus"
     class="mt-3"
     style="display: none"
     role="status"
     aria-live="polite"
     aria-atomic="true">
</div>
</form>
</div>

<!-- Service Configuration -->
<div class="settings-group bento-span-12">
  <h3 class="settings-group-title">
    <i class="fas fa-cogs"></i>
    Service Configuration
  </h3>
  <p class="text-muted small">
    Configure external services used by the application. These settings are saved to the database
    and can be changed without redeploying.
  </p>

  <form id="serviceConfigForm">
    <div class="row">
      <!-- Mapbox Token -->
      <div class="col-md-12 mb-3">
        <label for="mapboxToken" class="form-label">
          <i class="fas fa-map"></i> Mapbox Token
        </label>
        <input type="password"
               class="form-control"
               id="mapboxToken"
               placeholder="pk.eyJ1..." />
        <div class="form-text">
          Public Mapbox token (pk.*) for map rendering. Get one at
          <a href="https://mapbox.com" target="_blank" rel="noopener">mapbox.com</a>
        </div>
      </div>

      <!-- Nominatim Configuration -->
      <div class="col-md-6 mb-3">
        <label for="nominatimBaseUrl" class="form-label">
          <i class="fas fa-search-location"></i> Nominatim Base URL
        </label>
        <input type="url"
               class="form-control"
               id="nominatimBaseUrl"
               placeholder="http://nominatim:8080" />
        <div class="form-text">
          Self-hosted Nominatim URL for geocoding (default: Docker internal)
        </div>
      </div>

      <div class="col-md-6 mb-3">
        <label for="nominatimUserAgent" class="form-label">
          Nominatim User Agent
        </label>
        <input type="text"
               class="form-control"
               id="nominatimUserAgent"
               placeholder="EveryStreet/1.0" />
        <div class="form-text">
          User-Agent header for Nominatim requests
        </div>
      </div>

      <!-- Valhalla Configuration -->
      <div class="col-md-6 mb-3">
        <label for="valhallaBaseUrl" class="form-label">
          <i class="fas fa-route"></i> Valhalla Base URL
        </label>
        <input type="url"
               class="form-control"
               id="valhallaBaseUrl"
               placeholder="http://valhalla:8002" />
        <div class="form-text">
          Self-hosted Valhalla URL for routing (default: Docker internal)
        </div>
      </div>

      <!-- Geofabrik Mirror -->
      <div class="col-md-6 mb-3">
        <label for="geofabrikMirror" class="form-label">
          <i class="fas fa-download"></i> Geofabrik Mirror
        </label>
        <input type="url"
               class="form-control"
               id="geofabrikMirror"
               placeholder="https://download.geofabrik.de" />
        <div class="form-text">
          Mirror URL for downloading OSM extracts
        </div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary" id="saveServiceConfigBtn">
        <i class="fas fa-save"></i> Save Service Settings
      </button>
      <button type="button" class="btn btn-secondary" id="reloadServiceConfigBtn">
        <i class="fas fa-sync"></i> Reload
      </button>
    </div>

    <div id="serviceConfigStatus" class="mt-3" style="display: none" role="status"></div>
  </form>
</div>

<!-- Vehicle Management Link -->
<div class="settings-group bento-span-6">
  <h3 class="settings-group-title">
    <i class="fas fa-car"></i>
      Vehicle Management
  </h3>
  <p class="text-muted small">
      Manage your vehicle details, odometer settings, and more.
  </p>
  <a href="/vehicles" class="btn btn-outline-primary">
    <i class="fas fa-car me-2"></i>Go to My Vehicle
  </a>
</div>

<!-- Help/Documentation -->
<div class="settings-group bento-span-6">
  <h3 class="settings-group-title">
    <i class="fas fa-question-circle"></i>
      How to Get Your Credentials
  </h3>
  <ol>
    <li>
      <strong>Create a Bouncie Developer Account:</strong> Visit the
      <a href="https://developer.bouncie.com" target="_blank" rel="noopener">
          Bouncie Developer Portal
      </a>
        and sign up for an account.
    </li>
    <li>
      <strong>Create an Application:</strong> Once logged in, create a new
        application to get your Client ID and Client Secret.
    </li>
    <li>
      <strong>Configure Redirect URI:</strong> Set your redirect URI in the
        Bouncie application settings (e.g., https://your-domain.com/callback).
    </li>
    <li>
      <strong>Complete OAuth Flow:</strong> Use the OAuth 2.0 authorization
        flow to obtain an authorization code.
    </li>
    <li>
      <strong>Find Device IMEIs:</strong> Your device IMEI numbers can be found
        in your Bouncie account settings or on the physical device.
    </li>
  </ol>
  <p class="text-muted small mb-0">
    <i class="fas fa-info-circle"></i>
    <strong>Note:</strong> These credentials are stored securely in your database
      and are never exposed in logs or error messages.
  </p>
</div>
</div>
  </div>
  </div>

{% endblock %}


{% block extra_js %}

  <script src="{{ url_for('static', path='js/profile-state.js') | replace('http://', '//') }}"></script>
  <script src="{{ url_for('static', path='js/profile.js') | replace('http://', '//') }}"></script>
{% endblock %}
