{% extends "base.html" %}
{% block title %}Every Street - County Map{% endblock %}

{% block extra_css %}
<!-- Mapbox GL CSS -->
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.11.0/mapbox-gl.css" />
<link rel="stylesheet" href="{{ url_for('static', path='css/county-map.css') | replace('http://', '//') }}" />
{% endblock %}

{% block content %}
<div class="county-map-wrapper">
  <!-- Map Container -->
  <div id="county-map" class="county-map-container" role="application" aria-label="US Counties Map"></div>

  <!-- Stats Panel -->
  <div class="county-stats-panel" id="stats-panel">
    <div class="stats-header">
      <h2 class="stats-title">
        <i class="fas fa-map-marked-alt me-2" aria-hidden="true"></i>
        County Coverage
      </h2>
      <button class="stats-toggle-btn" id="stats-toggle" aria-label="Toggle stats panel" aria-expanded="true">
        <i class="fas fa-chevron-up" aria-hidden="true"></i>
      </button>
    </div>
    
    <div class="stats-content" id="stats-content">
      <div class="stats-grid">
        <div class="stat-card stat-card--primary">
          <div class="stat-value" id="counties-visited">0</div>
          <div class="stat-label">Counties Visited</div>
        </div>
        <div class="stat-card stat-card--secondary">
          <div class="stat-value" id="counties-total">3,143</div>
          <div class="stat-label">Total US Counties</div>
        </div>
        <div class="stat-card stat-card--accent">
          <div class="stat-value" id="coverage-percent">0%</div>
          <div class="stat-label">Coverage</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="states-visited">0</div>
          <div class="stat-label">States Visited</div>
        </div>
      </div>

      <!-- Last updated and recalculate -->
      <div class="cache-info">
        <span class="last-updated" id="last-updated"></span>
        <button class="btn btn-sm btn-outline-secondary" id="recalculate-btn" title="Recalculate from trip data">
          <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
      </div>

      <!-- Legend -->
      <div class="map-legend">
        <h3 class="legend-title">Legend</h3>
        <div class="legend-items">
          <div class="legend-item">
            <span class="legend-color legend-color--visited"></span>
            <span class="legend-label">Driven Through</span>
          </div>
          <div class="legend-item legend-item--toggle">
            <div class="legend-toggle-text">
              <span class="legend-color legend-color--stopped"></span>
              <div class="legend-label-group">
                <span class="legend-label">Stopped In</span>
                <span class="legend-subtext">Start or end stops (<span id="counties-stopped">0</span>)</span>
              </div>
            </div>
            <div class="form-check form-switch legend-toggle">
              <input
                class="form-check-input"
                type="checkbox"
                role="switch"
                id="stopped-toggle"
                aria-label="Highlight counties with stops"
              />
            </div>
          </div>
          <div class="legend-item">
            <span class="legend-color legend-color--unvisited"></span>
            <span class="legend-label">Not Yet Visited</span>
          </div>
          <div class="legend-item">
            <span class="legend-color legend-color--state-border"></span>
            <span class="legend-label">State Border</span>
          </div>
        </div>
      </div>

      <!-- State-by-State Stats -->
      <div class="state-stats-section">
        <button class="state-stats-header" id="state-stats-toggle" aria-expanded="false" aria-controls="state-stats-list">
          <span class="state-stats-title">
            <i class="fas fa-list-ul me-2" aria-hidden="true"></i>
            Stats by State
          </span>
          <i class="fas fa-chevron-down state-stats-chevron" aria-hidden="true"></i>
        </button>
        <div class="state-stats-content" id="state-stats-list" style="display: none;">
          <div class="state-stats-filter">
            <select id="state-sort" class="form-select form-select-sm">
              <option value="name">Sort by Name</option>
              <option value="coverage-desc">Sort by Coverage (High to Low)</option>
              <option value="coverage-asc">Sort by Coverage (Low to High)</option>
              <option value="visited-desc">Sort by Visited (High to Low)</option>
            </select>
          </div>
          <div class="state-stats-list" id="state-list">
            <!-- State items will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- County Info Tooltip -->
  <div id="county-tooltip" class="county-tooltip" style="display: none;">
    <div class="tooltip-county-name"></div>
    <div class="tooltip-state-name"></div>
    <div class="tooltip-status"></div>
    <div class="tooltip-dates"></div>
  </div>

  <!-- Loading Overlay -->
  <div id="map-loading" class="map-loading-overlay">
    <div class="loading-indicator">
      <div class="loading-spinner"></div>
      <span class="loading-text">Loading county data...</span>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Mapbox GL JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v3.11.0/mapbox-gl.js"></script>
<script src="{{ url_for('static', path='js/map-base.js') | replace('http://', '//') }}"></script>
<script src="{{ url_for('static', path='js/modules/map-styles.js') | replace('http://', '//') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
<script>
  window.MAPBOX_ACCESS_TOKEN = "{{ MAPBOX_ACCESS_TOKEN }}";
</script>
<script src="{{ url_for('static', path='js/county-map.js') | replace('http://', '//') }}"></script>
{% endblock %}
