{% extends "base.html" %}

{% block title %}

Recurring Routes - Every Street
{% endblock %}

{% block extra_css %}

  <!-- Mapbox GL CSS -->
  <link rel="stylesheet" href="{{ CDN.mapbox_gl_css }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/features/map/index.css') | replace('http://', '//') }}?v={{ repo_version.commit_count }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/routes.css') | replace('http://', '//') }}?v={{ repo_version.commit_count }}" />
{% endblock %}

{% block head_content %}

  <meta name="mapbox-access-token" content="{{ MAPBOX_ACCESS_TOKEN }}" />
{% endblock %}

{% block content %}

  <div id="routes-page" class="routes-page">
    <!-- Ambient Background -->
    <div class="routes-ambient-bg" aria-hidden="true">
      <div class="routes-ambient-gradient">
      </div>
      <div class="routes-ambient-noise">
      </div>
      <div class="routes-ambient-grid">
      </div>
    </div>

    <div class="routes-container">
      <header class="routes-hero" data-stagger>
        <div class="routes-hero-left">
          <div class="routes-badge">
            <i class="fas fa-route" aria-hidden="true"></i>
            <span>Recurring routes</span>
          </div>
          <h1 class="routes-title">
            Your paths,
            <span class="routes-title-accent">distilled</span>
          </h1>
          <p class="routes-subtitle">
          Automatically grouped from your stored trips. Rename, pin, hide, and explore the patterns that emerge.
          </p>
          <div class="routes-hero-insights" id="routes-hero-insights">
            <div class="routes-insight-tile">
              <span class="routes-insight-icon"><i class="fas fa-dna" aria-hidden="true"></i></span>
              <span class="routes-insight-text" id="hero-insight-dna">Analyzing your routes...</span>
            </div>
            <div class="routes-insight-tile accent">
              <span class="routes-insight-icon"><i class="fas fa-lightbulb" aria-hidden="true"></i></span>
              <span class="routes-insight-text" id="hero-insight-spotlight">Loading insights...</span>
            </div>
          </div>
          <button type="button" class="routes-stats-toggle" id="routes-stats-toggle" aria-expanded="false">
            <span>View stats</span>
            <i class="fas fa-chevron-down" aria-hidden="true"></i>
          </button>
          <div class="routes-hero-stats collapsed" id="routes-hero-stats">
            <div class="routes-hero-stat-card">
              <span class="routes-hero-stat-label">Routes</span>
              <span class="routes-hero-stat-value" id="hero-stat-routes">0</span>
            </div>
            <div class="routes-hero-stat-card">
              <span class="routes-hero-stat-label">Trips</span>
              <span class="routes-hero-stat-value" id="hero-stat-trips">0</span>
            </div>
            <div class="routes-hero-stat-card">
              <span class="routes-hero-stat-label">Miles</span>
              <span class="routes-hero-stat-value" id="hero-stat-miles">0</span>
            </div>
            <div class="routes-hero-stat-card">
              <span class="routes-hero-stat-label">Top route</span>
              <span class="routes-hero-stat-value" id="hero-stat-freq">--</span>
            </div>
          </div>
        </div>

        <div class="routes-hero-right">
          <div class="routes-build-card" data-accent="mint">
            <div class="build-card-top">
              <div class="build-status">
                <span class="build-dot" id="routes-build-dot" data-state="idle" aria-hidden="true"></span>
                <span class="build-text" id="routes-build-text">Ready to build</span>
              </div>
              <div class="build-meta" id="routes-build-meta">
                <span class="build-meta-item" id="routes-last-built">Not built yet</span>
              </div>
            </div>

            <div class="build-actions">
              <button type="button" class="btn btn-primary routes-build-btn" id="routes-build-btn">
                <i class="fas fa-wand-magic-sparkles me-2" aria-hidden="true"></i>
              Build / Refresh Routes
              </button>
              <button type="button"
                      class="btn btn-outline-secondary routes-cancel-btn d-none"
                      id="routes-cancel-btn">
                <i class="fas fa-ban me-2" aria-hidden="true"></i>
              Cancel
              </button>
            </div>

            <div class="build-progress-wrap d-none"
                 id="routes-build-progress-wrap"
                 aria-live="polite">
              <div class="build-progress">
                <div class="build-progress-bar" id="routes-build-progress-bar" style="width: 0%">
                </div>
              </div>
              <div class="build-progress-labels">
                <span id="routes-build-stage">Queued</span>
                <span id="routes-build-progress">0%</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Controls -->
      <section class="routes-controls" data-stagger>
        <div class="routes-controls-inner">
          <div class="routes-search">
            <i class="fas fa-search" aria-hidden="true"></i>
            <input type="text"
                   id="routes-search-input"
                   class="routes-search-input"
                   placeholder="Search routes..."
                   autocomplete="off" />
            <button type="button"
                    class="routes-search-clear d-none"
                    id="routes-search-clear"
                    aria-label="Clear search">
              <i class="fas fa-times" aria-hidden="true"></i>
            </button>
          </div>

          <div class="routes-filters">
            <div class="routes-filter">
              <label for="routes-min-trips" class="routes-filter-label">
Min trips
              </label>
              <select id="routes-min-trips" class="routes-filter-select">
                <option value="3" selected>
3 (recurring)
                </option>
                <option value="2">
2
                </option>
                <option value="1">
1
                </option>
              </select>
            </div>

            <div class="routes-filter">
              <label for="routes-vehicle" class="routes-filter-label">
Vehicle
              </label>
              <select id="routes-vehicle" class="routes-filter-select">
                <option value="">
All vehicles
                </option>
              </select>
            </div>

            <div class="routes-filter">
              <label for="routes-sort" class="routes-filter-label">
Sort by
              </label>
              <select id="routes-sort" class="routes-filter-select">
                <option value="trips" selected>Most trips</option>
                <option value="recent">Recently active</option>
                <option value="distance">Longest distance</option>
                <option value="alpha">Alphabetical</option>
              </select>
            </div>

            <label class="routes-toggle">
              <input type="checkbox" id="routes-include-hidden" />
              <span class="routes-toggle-ui" aria-hidden="true"></span>
              <span class="routes-toggle-text">Include hidden</span>
            </label>
          </div>
        </div>
      </section>

      <!-- All Paths Explorer -->
      <section class="routes-explorer" id="routes-explorer" data-stagger>
        <div class="routes-explorer-teaser" id="routes-explorer-teaser">
          <div class="routes-explorer-teaser-left">
            <i class="fas fa-compass" aria-hidden="true"></i>
            <div>
              <span class="routes-explorer-teaser-title">All Paths Explorer</span>
              <span class="routes-explorer-teaser-desc">Compare any two places to discover route patterns</span>
            </div>
          </div>
          <button type="button" class="routes-explorer-expand-btn" id="routes-explorer-expand-btn">
            <span>Open Explorer</span>
            <i class="fas fa-chevron-down" aria-hidden="true"></i>
          </button>
        </div>
        <div class="routes-explorer-body" id="routes-explorer-body" style="display:none">
        <div class="routes-explorer-header">
          <div>
            <h2 class="routes-explorer-title">
            All Paths Explorer
            </h2>
            <p class="routes-explorer-subtitle">
            Compare custom place pairs, including reverse direction, to inspect route variants over time.
            </p>
          </div>
        </div>

        <div class="routes-explorer-controls">
          <div class="routes-explorer-control">
            <label for="routes-explorer-start-place" class="routes-filter-label">
Start place
            </label>
            <select id="routes-explorer-start-place" class="routes-filter-select routes-explorer-select">
              <option value="">
Choose a place
              </option>
            </select>
          </div>
          <div class="routes-explorer-control">
            <label for="routes-explorer-end-place" class="routes-filter-label">
End place
            </label>
            <select id="routes-explorer-end-place" class="routes-filter-select routes-explorer-select">
              <option value="">
Choose a place
              </option>
            </select>
          </div>
          <label class="routes-toggle routes-explorer-toggle" for="routes-explorer-include-reverse">
            <input type="checkbox" id="routes-explorer-include-reverse" />
            <span class="routes-toggle-ui" aria-hidden="true"></span>
            <span class="routes-toggle-text">Include reverse direction</span>
          </label>
          <div class="routes-explorer-timeframe" role="radiogroup" aria-label="Explorer timeframe">
            <label class="routes-timeframe-option" for="routes-explorer-timeframe-90d">
              <input type="radio"
                     id="routes-explorer-timeframe-90d"
                     name="routes-explorer-timeframe"
                     value="90d"
                     checked />
              <span>Last 90d</span>
            </label>
            <label class="routes-timeframe-option" for="routes-explorer-timeframe-all">
              <input type="radio"
                     id="routes-explorer-timeframe-all"
                     name="routes-explorer-timeframe"
                     value="all" />
              <span>All time</span>
            </label>
          </div>
          <button type="button" class="btn btn-primary routes-explorer-run-btn" id="routes-explorer-run-btn">
            <i class="fas fa-compass me-2" aria-hidden="true"></i>
          Analyze pair
          </button>
        </div>

        <div class="routes-explorer-status" id="routes-explorer-status" aria-live="polite">
        Pick two places to run pair analysis.
        </div>

        <div class="routes-explorer-results">
          <div class="routes-explorer-insight-sentence" id="routes-explorer-insight-sentence"></div>
          <div class="routes-explorer-summary-grid">
            <article class="routes-summary-kpi">
              <span class="routes-summary-kpi-label">Total trips</span>
              <span class="routes-summary-kpi-value" id="routes-explorer-kpi-trips">--</span>
            </article>
            <article class="routes-summary-kpi">
              <span class="routes-summary-kpi-label">Variants</span>
              <span class="routes-summary-kpi-value" id="routes-explorer-kpi-variants">--</span>
            </article>
            <article class="routes-summary-kpi">
              <span class="routes-summary-kpi-label">Top variant share</span>
              <span class="routes-summary-kpi-value" id="routes-explorer-kpi-top-share">--</span>
            </article>
            <article class="routes-summary-kpi">
              <span class="routes-summary-kpi-label">Span</span>
              <span class="routes-summary-kpi-value" id="routes-explorer-kpi-span">--</span>
            </article>
          </div>

          <div class="routes-explorer-panels">
            <article class="routes-chart-panel routes-chart-panel-lg">
              <div class="routes-chart-panel-head">
                <h3 class="routes-chart-panel-title">
                Variant share
                </h3>
              </div>
              <div class="routes-chart-wrap">
                <canvas id="routes-explorer-variant-share-chart" class="routes-chart-canvas d-none"></canvas>
                <div class="routes-chart-empty" id="routes-explorer-variant-share-empty">
                Run analysis to see variant share.
                </div>
              </div>
              <div class="routes-variant-share-list" id="routes-explorer-variant-share-list">
              </div>
            </article>

            <article class="routes-chart-panel">
              <div class="routes-chart-panel-head">
                <h3 class="routes-chart-panel-title">
                Monthly trips
                </h3>
              </div>
              <div class="routes-chart-wrap">
                <canvas id="routes-explorer-chart-monthly" class="routes-chart-canvas d-none"></canvas>
                <div class="routes-chart-empty" id="routes-explorer-chart-monthly-empty">
                No monthly data yet.
                </div>
              </div>
            </article>

            <article class="routes-chart-panel">
              <div class="routes-chart-panel-head">
                <h3 class="routes-chart-panel-title">
                Hourly trips
                </h3>
              </div>
              <div class="routes-chart-wrap">
                <canvas id="routes-explorer-chart-hour" class="routes-chart-canvas d-none"></canvas>
                <div class="routes-chart-empty" id="routes-explorer-chart-hour-empty">
                No hourly data yet.
                </div>
              </div>
            </article>

            <article class="routes-chart-panel">
              <div class="routes-chart-panel-head">
                <h3 class="routes-chart-panel-title">
                Day of week
                </h3>
              </div>
              <div class="routes-chart-wrap">
                <canvas id="routes-explorer-chart-day" class="routes-chart-canvas d-none"></canvas>
                <div class="routes-chart-empty" id="routes-explorer-chart-day-empty">
                No day-of-week data yet.
                </div>
              </div>
            </article>
          </div>

          <article class="routes-explorer-variants-card">
            <div class="routes-chart-panel-head">
              <h3 class="routes-chart-panel-title">
              Route variants
              </h3>
            </div>
            <div class="routes-explorer-variants-list" id="routes-explorer-variants-list">
            </div>
          </article>
        </div>
        </div><!-- /routes-explorer-body -->
      </section>

      <!-- Results -->
      <section class="routes-results" data-stagger>
        <div class="routes-results-header">
          <div class="routes-results-title">
            <span id="routes-results-count">0</span> routes
          </div>
          <div class="routes-results-hint" id="routes-results-hint">
          Showing routes built from your trips
          </div>
        </div>

        <div class="routes-grid" id="routes-grid">
          <div class="routes-loading" id="routes-loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading routes...</span>
            </div>
            <p class="mt-2 text-secondary">
            Loading routes...
            </p>
          </div>
        </div>

        <div class="routes-empty d-none" id="routes-empty">
          <div class="routes-empty-icon" aria-hidden="true">
            <i class="fas fa-route"></i>
          </div>
          <h3 class="routes-empty-title">
No routes yet
          </h3>
          <p class="routes-empty-text">
          Build your route templates to group similar trips into recurring patterns.
          </p>
          <button type="button" class="btn btn-primary btn-lg" id="routes-empty-build-btn">
            <i class="fas fa-wand-magic-sparkles me-2" aria-hidden="true"></i>
          Build routes
          </button>
        </div>
      </section>
    </div>

    <!-- Route Details Modal -->
    <div class="modal fade" id="routeDetailsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered routes-modal-dialog">
        <div class="modal-content routes-modal-content">
          <div class="modal-header routes-modal-header">
            <div class="routes-modal-title-wrap">
              <h5 class="modal-title" id="routeModalTitle">
Route
              </h5>
              <div class="routes-modal-subtitle" id="routeModalSubtitle">
                <span id="routeModalMeta">--</span>
              </div>
            </div>
            <div class="modal-actions">
              <button class="btn-icon" id="route-modal-pin-btn" title="Pin">
                <i class="fas fa-thumbtack" aria-hidden="true"></i>
              </button>
              <button class="btn-icon" id="route-modal-hide-btn" title="Hide">
                <i class="fas fa-eye-slash" aria-hidden="true"></i>
              </button>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
              </button>
            </div>
          </div>
          <div class="modal-body p-0">
            <div class="row g-0">
              <div class="col-lg-8 position-relative routes-modal-map-col">
                <div class="routes-modal-map" id="route-modal-map">
                </div>
                <div class="routes-modal-map-badge" id="route-modal-map-badge" style="display: none">
                  <span class="badge-dot" aria-hidden="true"></span>
                  <span id="route-modal-map-badge-text">Pinned</span>
                </div>
                <div class="routes-modal-map-controls">
                  <button type="button"
                          class="btn btn-sm btn-outline-light routes-map-toggle-btn"
                          id="route-modal-show-all-trips">
                    <i class="fas fa-layer-group me-2" aria-hidden="true"></i>
                  Show all trips
                  </button>
                </div>
              </div>
              <div class="col-lg-4 routes-modal-panel">
                <div class="routes-modal-panel-inner">
                  <div class="routes-modal-edit">
                    <label class="routes-modal-label" for="route-modal-name">
Name
                    </label>
                    <div class="routes-modal-name-row">
                      <input type="text"
                             id="route-modal-name"
                             class="form-control routes-modal-name-input"
                             placeholder="(auto)" />
                      <input type="color"
                             id="route-modal-color"
                             class="routes-modal-color"
                             title="Route color" />
                    </div>
                    <div class="routes-modal-edit-hint" id="route-modal-edit-hint">
                    Renaming overrides the auto name for this route.
                    </div>
                  </div>

                  <div class="routes-modal-tabs" role="tablist" aria-label="Route details tabs">
                    <button type="button"
                            class="routes-modal-tab active"
                            data-tab="overview">
                    Overview
                    </button>
                    <button type="button" class="routes-modal-tab" data-tab="analytics">
                    Analytics
                    </button>
                    <button type="button" class="routes-modal-tab" data-tab="trips">
                    Trips
                    </button>
                  </div>

                  <section class="routes-modal-tab-content active" data-tab-content="overview">
                    <div class="route-insight-banner" id="route-insight-banner">
                      <div class="route-insight-banner-tag" id="route-insight-tag">Route</div>
                      <div class="route-insight-banner-sentence" id="route-insight-sentence">Loading insights...</div>
                    </div>

                    <div class="route-key-facts">
                      <div class="route-key-fact">
                        <span class="route-key-fact-icon"><i class="fas fa-repeat" aria-hidden="true"></i></span>
                        <span class="route-key-fact-value" id="route-fact-frequency">--</span>
                        <span class="route-key-fact-label">Trip frequency</span>
                      </div>
                      <div class="route-key-fact">
                        <span class="route-key-fact-icon"><i class="fas fa-ruler-combined" aria-hidden="true"></i></span>
                        <span class="route-key-fact-value" id="route-fact-distance">--</span>
                        <span class="route-key-fact-label">Typical trip</span>
                      </div>
                      <div class="route-key-fact">
                        <span class="route-key-fact-icon"><i class="fas fa-chart-line" aria-hidden="true"></i></span>
                        <span class="route-key-fact-value" id="route-fact-consistency">--</span>
                        <span class="route-key-fact-label">Consistency</span>
                      </div>
                    </div>

                    <details class="route-details-expand">
                      <summary>All statistics</summary>
                      <div class="routes-modal-stats" id="route-modal-stats">
                        <div class="routes-stat">
                          <span class="routes-stat-label">Trips</span>
                          <span class="routes-stat-value" id="route-stat-trips">--</span>
                        </div>
                        <div class="routes-stat">
                          <span class="routes-stat-label">Trips / week</span>
                          <span class="routes-stat-value" id="route-stat-frequency">--</span>
                        </div>
                        <div class="routes-stat">
                          <span class="routes-stat-label">Avg distance</span>
                          <span class="routes-stat-value" id="route-stat-distance">--</span>
                        </div>
                        <div class="routes-stat">
                          <span class="routes-stat-label">Avg duration</span>
                          <span class="routes-stat-value" id="route-stat-duration">--</span>
                        </div>
                        <div class="routes-stat">
                          <span class="routes-stat-label">First trip</span>
                          <span class="routes-stat-value" id="route-stat-first">--</span>
                        </div>
                        <div class="routes-stat">
                          <span class="routes-stat-label">Last trip</span>
                          <span class="routes-stat-value" id="route-stat-last">--</span>
                        </div>
                        <div class="routes-stat">
                          <span class="routes-stat-label">Total miles</span>
                          <span class="routes-stat-value" id="route-stat-total-dist">--</span>
                        </div>
                        <div class="routes-stat">
                          <span class="routes-stat-label">Total time</span>
                          <span class="routes-stat-value" id="route-stat-total-time">--</span>
                        </div>
                        <div class="routes-stat">
                          <span class="routes-stat-label">Fuel avg</span>
                          <span class="routes-stat-value" id="route-stat-fuel">--</span>
                        </div>
                        <div class="routes-stat">
                          <span class="routes-stat-label">Max speed</span>
                          <span class="routes-stat-value" id="route-stat-speed">--</span>
                        </div>
                        <div class="routes-stat">
                          <span class="routes-stat-label">Cost avg</span>
                          <span class="routes-stat-value" id="route-stat-cost">--</span>
                        </div>
                      </div>
                    </details>

                    <div class="routes-modal-places" id="route-modal-places">
                      <h6 class="routes-modal-section-title">
                      Connected places
                      </h6>
                      <div class="routes-connected-places" id="route-places-list">
                      </div>
                    </div>
                  </section>

                  <section class="routes-modal-tab-content" data-tab-content="analytics">
                    <div class="routes-chart-panel">
                      <div class="routes-chart-panel-head">
                        <h6 class="routes-chart-panel-title">
                        Monthly trips
                        </h6>
                      </div>
                      <div class="routes-chart-insight" id="route-chart-monthly-insight"></div>
                      <div class="routes-chart-wrap">
                        <canvas id="route-chart-monthly" class="routes-chart-canvas d-none"></canvas>
                        <div class="routes-chart-empty" id="route-chart-monthly-empty">
                        Not enough monthly data for this route.
                        </div>
                      </div>
                    </div>
                    <div class="routes-chart-panel">
                      <div class="routes-chart-panel-head">
                        <h6 class="routes-chart-panel-title">
                        Hourly trips
                        </h6>
                      </div>
                      <div class="routes-chart-insight" id="route-chart-hour-insight"></div>
                      <div class="routes-chart-wrap">
                        <canvas id="route-chart-hour" class="routes-chart-canvas d-none"></canvas>
                        <div class="routes-chart-empty" id="route-chart-hour-empty">
                        Not enough hourly data for this route.
                        </div>
                      </div>
                    </div>
                    <div class="routes-chart-panel">
                      <div class="routes-chart-panel-head">
                        <h6 class="routes-chart-panel-title">
                        Day of week
                        </h6>
                      </div>
                      <div class="routes-chart-insight" id="route-chart-dow-insight"></div>
                      <div class="routes-chart-wrap">
                        <canvas id="route-chart-dow" class="routes-chart-canvas d-none"></canvas>
                        <div class="routes-chart-empty" id="route-chart-dow-empty">
                        Not enough day-of-week data for this route.
                        </div>
                      </div>
                    </div>
                    <div class="routes-chart-panel">
                      <div class="routes-chart-panel-head">
                        <h6 class="routes-chart-panel-title">
                        Distance and duration trend
                        </h6>
                      </div>
                      <div class="routes-chart-insight" id="route-chart-trend-insight"></div>
                      <div class="routes-chart-wrap">
                        <canvas id="route-chart-distance-trend" class="routes-chart-canvas d-none"></canvas>
                        <div class="routes-chart-empty" id="route-chart-distance-trend-empty">
                        Not enough trend data for this route.
                        </div>
                      </div>
                    </div>
                  </section>

                  <section class="routes-modal-tab-content" data-tab-content="trips">
                    <div class="routes-modal-trips">
                      <div class="routes-modal-trips-header">
                        <h6 class="routes-modal-section-title">
                        Trips on this route
                        </h6>
                        <span class="routes-modal-trips-count" id="route-modal-trips-count">0</span>
                      </div>
                      <div class="routes-modal-trips-list" id="route-modal-trips-list">
                      </div>
                    </div>
                  </section>

                  <div class="routes-modal-footer">
                    <a class="btn btn-outline-secondary w-100"
                       id="route-modal-open-btn"
                       href="/routes">
                      <i class="fas fa-external-link-alt me-2" aria-hidden="true"></i>
                    Open route page
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
{% endblock %}

{# Page scripts are loaded via route-loader + swup. #}
