{% extends "base.html" %} {% block title %}Settings{% endblock %} 
{% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', path='css/settings-mobile.css') | replace('http://', '//') }}"
/>
{% endblock %}
{% block content %}
<div class="container-fluid settings-desktop-container">
  <div class="row">
    <div class="col-12">
      <h2>Background Task Management</h2>
      <div class="card bg-dark text-white mb-4">
        <div class="card-body">
          <h3 class="h5">Global Task Control</h3>
          <div class="form-check form-switch mb-3">
            <input
              class="form-check-input"
              type="checkbox"
              id="globalDisableSwitch"
            />
            <label class="form-check-label" for="globalDisableSwitch">
              Globally Disable Tasks
            </label>
          </div>
          <div class="btn-group mb-3">
            <button
              class="btn btn-warning"
              data-bs-toggle="modal"
              data-bs-target="#pauseModal"
            >
              <i class="fas fa-pause"></i> Pause Tasks
            </button>
            <button class="btn btn-success" id="resumeBtn">
              <i class="fas fa-play"></i> Resume Tasks
            </button>
            <button class="btn btn-danger" id="stopAllBtn">
              <i class="fas fa-stop"></i> Stop All
            </button>
          </div>
          <div class="btn-group mb-3 ms-2">
            <button class="btn btn-primary" id="enableAllBtn">
              <i class="fas fa-check"></i> Enable All
            </button>
            <button class="btn btn-secondary" id="disableAllBtn">
              <i class="fas fa-times"></i> Disable All
            </button>
            <button class="btn btn-info" id="manualRunAllBtn">
              <i class="fas fa-play-circle"></i> Run All Now
            </button>
            <button class="btn btn-warning" id="resetTasksBtn">
              <i class="fas fa-sync"></i> Reset Tasks
            </button>
          </div>
        </div>
      </div>

      <div class="card bg-dark text-white mb-4">
        <div class="card-body">
          <h3 class="h5">Task Configuration</h3>
          <div class="table-responsive-lg">
            <table class="table table-dark" id="taskConfigTable">
              <thead>
                <tr>
                  <th>Task</th>
                  <th>Interval</th>
                  <th>Enabled</th>
                  
                  <th style="width: 150px">Status</th>
                  <th>Last Run</th>
                  <th>Next Run</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Task rows will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
          <button class="btn btn-primary" id="saveTaskConfigBtn">
            <i class="fas fa-save"></i> Save Configuration
          </button>
        </div>
      </div>

      <div class="card bg-dark text-white mb-4" id="manual-fetch-card">
        <div class="card-body">
          <h3 class="h5">Manual Trip Fetch</h3>
          <p class="text-muted small">
            Schedule an on-demand trip fetch for a specific date range. Map
            matching can be toggled for the fetched trips.
          </p>
          <form id="manualFetchTripsForm" class="row g-3">
            <div class="col-md-4">
              <label for="manual-fetch-start" class="form-label">Start</label>
              <input
                type="datetime-local"
                class="form-control"
                id="manual-fetch-start"
                required
              />
            </div>
            <div class="col-md-4">
              <label for="manual-fetch-end" class="form-label">End</label>
              <input
                type="datetime-local"
                class="form-control"
                id="manual-fetch-end"
                required
              />
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="manual-fetch-map-match"
                />
                <label class="form-check-label" for="manual-fetch-map-match">
                  Enable map matching
                </label>
              </div>
            </div>
            <div class="col-12 d-flex align-items-center">
              <button
                type="submit"
                class="btn btn-success"
                id="manual-fetch-submit"
              >
                <i class="fas fa-cloud-download-alt"></i> Fetch Trips
              </button>
              <span class="ms-3 text-muted" id="manual-fetch-status"></span>
            </div>
          </form>
        </div>
      </div>

      <div class="card bg-dark text-white mb-4">
        <div class="card-body">
          <h3 class="h5">Task History</h3>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-danger btn-sm" id="clearHistoryBtn">
              <i class="fas fa-trash"></i> Clear History
            </button>
          </div>
          <div class="table-responsive-lg">
            <table class="table table-dark" id="taskHistoryTable">
              <thead>
                <tr>
                  <th>Task</th>
                  <th>Status</th>
                  <th>Start Time</th>
                  <th>Duration</th>
                  <th>Result</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                <!-- Task history will be populated by JavaScript -->
              </tbody>
            </table>
            <div id="taskHistoryPagination" class="mt-3">
              <!-- Pagination controls will be added by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Data Management Section -->
      <h2>Data Management</h2>

      <!-- Re-geocode Trips Section -->
      <div class="card bg-dark text-white mb-4">
        <div class="card-body">
          <h3 class="h5">Re-geocode Trips</h3>
          <p>Re-geocode trips within a date range. Only trips without addresses will be geocoded. Efficiently checks against custom places.</p>

          <div class="mb-3">
            <label for="geocode-type" class="form-label">Select Method:</label>
            <select id="geocode-type" class="form-select">
              <option value="date">Pick a Date Range</option>
              <option value="interval">Use a Predefined Interval</option>
              <option value="all">All Trips</option>
            </select>
          </div>

          <div id="geocode-date-range">
            <div class="mb-3">
              <label for="geocode-start" class="form-label">Start Date:</label>
              <input
                type="text"
                id="geocode-start"
                class="form-control datepicker"
              />
            </div>
            <div class="mb-3">
              <label for="geocode-end" class="form-label">End Date:</label>
              <input
                type="text"
                id="geocode-end"
                class="form-control datepicker"
              />
            </div>
          </div>

          <div id="geocode-interval" style="display: none">
            <div class="mb-3">
              <label for="geocode-interval-select" class="form-label"
                >Select Interval:</label
              >
              <select id="geocode-interval-select" class="form-select">
                <option value="1">Last Day</option>
                <option value="3">Last 3 Days</option>
                <option value="7">Last Week</option>
                <option value="30">Last Month</option>
                <option value="90">Last 3 Months</option>
                <option value="180">Last 6 Months</option>
                <option value="365">Last Year</option>
                <option value="730">Last 2 Years</option>
              </select>
            </div>
          </div>

          <button id="geocode-trips-btn" class="btn btn-warning">
            <i class="fas fa-sync-alt"></i> Re-geocode Trips
          </button>
          <div id="geocode-trips-status" class="mt-2"></div>
          
          <!-- Progress Panel -->
          <div id="geocode-progress-panel" class="mt-3" style="display: none">
            <div class="card bg-secondary">
              <div class="card-body">
                <h5 class="card-title">Geocoding Progress</h5>
                <div class="progress mb-2" style="height: 25px">
                  <div
                    id="geocode-progress-bar"
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    role="progressbar"
                    style="width: 0%"
                    aria-valuenow="0"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  >
                    0%
                  </div>
                </div>
                <div id="geocode-progress-message" class="small mb-2"></div>
                <div id="geocode-progress-metrics" class="small text-muted"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Remap Matched Trips Section -->
      <div class="card bg-dark text-white mb-4">
        <div class="card-body">
          <h3 class="h5">Remap Matched Trips</h3>
          <p>
            Re-match trips to the street network within a specific date range.
          </p>

          <div class="mb-3">
            <label for="remap-type" class="form-label">Select Method:</label>
            <select id="remap-type" class="form-select">
              <option value="date">Pick a Date Range</option>
              <option value="interval">Use a Predefined Interval</option>
            </select>
          </div>

          <div id="remap-date-range">
            <div class="mb-3">
              <label for="remap-start" class="form-label">Start Date:</label>
              <input
                type="text"
                id="remap-start"
                class="form-control datepicker"
              />
            </div>
            <div class="mb-3">
              <label for="remap-end" class="form-label">End Date:</label>
              <input
                type="text"
                id="remap-end"
                class="form-control datepicker"
              />
            </div>
          </div>

          <div id="remap-interval" style="display: none">
            <div class="mb-3">
              <label for="remap-interval-select" class="form-label"
                >Select Interval:</label
              >
              <select id="remap-interval-select" class="form-select">
                <option value="1">Last Day</option>
                <option value="3">Last 3 Days</option>
                <option value="7">Last Week</option>
                <option value="30">Last Month</option>
                <option value="90">Last 3 Months</option>
                <option value="180">Last 6 Months</option>
                <option value="365">Last Year</option>
                <option value="730">Last 2 Years</option>
                <option value="0">All Time</option>
              </select>
            </div>
          </div>

          <button id="remap-btn" class="btn btn-warning">
            <i class="fas fa-route"></i> Re-Match Trips
          </button>
          <div id="remap-status" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Container -->
<div class="container-fluid settings-mobile-container">
  <!-- Mobile: Global Controls Section -->
  <div class="mobile-settings-section">
    <div class="mobile-settings-section-header" data-section="global-controls">
      <h2 class="mobile-settings-section-title">
        <i class="fas fa-sliders-h"></i>
        Global Controls
      </h2>
      <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
    </div>
    <div class="mobile-settings-section-content" id="mobile-global-controls">
      <div class="mobile-settings-section-body">
        <div class="mobile-global-controls">
          <div class="mobile-control-item">
            <span class="mobile-control-label">Globally Disable Tasks</span>
            <input type="checkbox" class="mobile-switch" id="mobile-globalDisableSwitch" />
          </div>
        </div>
        
        <div class="mobile-action-grid mt-3">
          <button class="mobile-action-btn warning" id="mobile-pauseBtn">
            <i class="fas fa-pause"></i>
            <span>Pause Tasks</span>
          </button>
          <button class="mobile-action-btn success" id="mobile-resumeBtn">
            <i class="fas fa-play"></i>
            <span>Resume Tasks</span>
          </button>
          <button class="mobile-action-btn danger" id="mobile-stopAllBtn">
            <i class="fas fa-stop"></i>
            <span>Stop All</span>
          </button>
          <button class="mobile-action-btn warning" id="mobile-resetTasksBtn">
            <i class="fas fa-sync"></i>
            <span>Reset Tasks</span>
          </button>
          <button class="mobile-action-btn primary" id="mobile-enableAllBtn">
            <i class="fas fa-check"></i>
            <span>Enable All</span>
          </button>
          <button class="mobile-action-btn" id="mobile-disableAllBtn">
            <i class="fas fa-times"></i>
            <span>Disable All</span>
          </button>
          <button class="mobile-action-btn info" id="mobile-manualRunAllBtn">
            <i class="fas fa-play-circle"></i>
            <span>Run All Now</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile: Task Configuration Section -->
  <div class="mobile-settings-section">
    <div class="mobile-settings-section-header expanded" data-section="task-config">
      <h2 class="mobile-settings-section-title">
        <i class="fas fa-tasks"></i>
        Task Configuration
      </h2>
      <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
    </div>
    <div class="mobile-settings-section-content expanded" id="mobile-task-config">
      <div class="mobile-settings-section-body">
        <div id="mobile-task-list">
          <!-- Task cards will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile: Manual Trip Fetch Section -->
  <div class="mobile-settings-section" id="mobile-manual-fetch-section">
    <div class="mobile-settings-section-header" data-section="manual-fetch">
      <h2 class="mobile-settings-section-title">
        <i class="fas fa-cloud-download-alt"></i>
        Manual Trip Fetch
      </h2>
      <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
    </div>
    <div class="mobile-settings-section-content" id="mobile-manual-fetch">
      <div class="mobile-settings-section-body">
        <form id="mobile-manualFetchTripsForm">
          <div class="mobile-form-group">
            <label class="mobile-form-label" for="mobile-manual-fetch-start">Start Date & Time</label>
            <input type="datetime-local" class="mobile-form-input" id="mobile-manual-fetch-start" required />
          </div>
          
          <div class="mobile-form-group">
            <label class="mobile-form-label" for="mobile-manual-fetch-end">End Date & Time</label>
            <input type="datetime-local" class="mobile-form-input" id="mobile-manual-fetch-end" required />
          </div>
          
          <div class="mobile-form-group">
            <div class="mobile-form-checkbox-wrapper">
              <input type="checkbox" id="mobile-manual-fetch-map-match" />
              <label class="mobile-form-checkbox-label" for="mobile-manual-fetch-map-match">
                Enable map matching
              </label>
            </div>
          </div>
          
          <button type="submit" class="mobile-submit-btn success">
            <i class="fas fa-cloud-download-alt"></i>
            Fetch Trips
          </button>
          
          <div id="mobile-manual-fetch-status" class="mobile-form-status d-none"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Mobile: Task History Section -->
  <div class="mobile-settings-section">
    <div class="mobile-settings-section-header" data-section="task-history">
      <h2 class="mobile-settings-section-title">
        <i class="fas fa-history"></i>
        Task History
      </h2>
      <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
    </div>
    <div class="mobile-settings-section-content" id="mobile-task-history">
      <div class="mobile-settings-section-body">
        <button class="mobile-submit-btn danger mb-3" id="mobile-clearHistoryBtn">
          <i class="fas fa-trash"></i>
          Clear History
        </button>
        
        <div id="mobile-history-list">
          <!-- History cards will be populated by JavaScript -->
        </div>
        
        <div class="mobile-pagination" id="mobile-history-pagination" style="display: none;">
          <button class="mobile-pagination-btn" id="mobile-history-prev" disabled>
            <i class="fas fa-chevron-left"></i> Previous
          </button>
          <span class="mobile-pagination-info" id="mobile-history-page-info"></span>
          <button class="mobile-pagination-btn" id="mobile-history-next">
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile: Data Management Section -->
  <div class="mobile-settings-section">
    <div class="mobile-settings-section-header" data-section="data-management">
      <h2 class="mobile-settings-section-title">
        <i class="fas fa-database"></i>
        Data Management
      </h2>
      <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
    </div>
    <div class="mobile-settings-section-content" id="mobile-data-management">
      <div class="mobile-settings-section-body">
        <!-- Re-geocode Trips -->
        <div class="mb-4">
          <h3 class="mobile-form-label">Re-geocode Trips</h3>
          <p class="mobile-form-hint mb-3">Re-geocode trips within a date range. Only trips without addresses will be geocoded.</p>
          
          <div class="mobile-date-method-tabs mb-3">
            <button type="button" class="mobile-date-method-tab active" data-method="date" data-target="geocode">
              Date Range
            </button>
            <button type="button" class="mobile-date-method-tab" data-method="interval" data-target="geocode">
              Interval
            </button>
            <button type="button" class="mobile-date-method-tab" data-method="all" data-target="geocode">
              All Trips
            </button>
          </div>

          <div id="mobile-geocode-date-range">
            <div class="mobile-form-group">
              <label class="mobile-form-label" for="mobile-geocode-start">Start Date</label>
              <input type="text" class="mobile-form-input datepicker" id="mobile-geocode-start" />
            </div>
            
            <div class="mobile-form-group">
              <label class="mobile-form-label" for="mobile-geocode-end">End Date</label>
              <input type="text" class="mobile-form-input datepicker" id="mobile-geocode-end" />
            </div>
          </div>

          <div id="mobile-geocode-interval" style="display: none;">
            <div class="mobile-form-group">
              <label class="mobile-form-label" for="mobile-geocode-interval-select">Select Interval</label>
              <select class="mobile-form-select" id="mobile-geocode-interval-select">
                <option value="1">Last Day</option>
                <option value="3">Last 3 Days</option>
                <option value="7">Last Week</option>
                <option value="30">Last Month</option>
                <option value="90">Last 3 Months</option>
                <option value="180">Last 6 Months</option>
                <option value="365">Last Year</option>
                <option value="730">Last 2 Years</option>
              </select>
            </div>
          </div>
          
          <button class="mobile-submit-btn warning" id="mobile-geocode-trips-btn">
            <i class="fas fa-sync-alt"></i>
            Re-geocode Trips
          </button>
          
          <div id="mobile-geocode-trips-status" class="mobile-form-status d-none"></div>
          
          <!-- Progress Panel -->
          <div id="mobile-geocode-progress-panel" class="mt-3" style="display: none">
            <div class="card bg-secondary">
              <div class="card-body">
                <h5 class="card-title">Geocoding Progress</h5>
                <div class="progress mb-2" style="height: 25px">
                  <div
                    id="mobile-geocode-progress-bar"
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    role="progressbar"
                    style="width: 0%"
                    aria-valuenow="0"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  >
                    0%
                  </div>
                </div>
                <div id="mobile-geocode-progress-message" class="small mb-2"></div>
                <div id="mobile-geocode-progress-metrics" class="small text-muted"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Remap Matched Trips -->
        <div>
          <h3 class="mobile-form-label">Remap Matched Trips</h3>
          <p class="mobile-form-hint mb-3">Re-match trips to the street network within a specific date range.</p>
          
          <div class="mobile-date-method-tabs mb-3">
            <button type="button" class="mobile-date-method-tab active" data-method="date">
              Date Range
            </button>
            <button type="button" class="mobile-date-method-tab" data-method="interval">
              Interval
            </button>
          </div>

          <div id="mobile-remap-date-range">
            <div class="mobile-form-group">
              <label class="mobile-form-label" for="mobile-remap-start">Start Date</label>
              <input type="text" class="mobile-form-input datepicker" id="mobile-remap-start" />
            </div>
            
            <div class="mobile-form-group">
              <label class="mobile-form-label" for="mobile-remap-end">End Date</label>
              <input type="text" class="mobile-form-input datepicker" id="mobile-remap-end" />
            </div>
          </div>

          <div id="mobile-remap-interval" style="display: none;">
            <div class="mobile-form-group">
              <label class="mobile-form-label" for="mobile-remap-interval-select">Select Interval</label>
              <select class="mobile-form-select" id="mobile-remap-interval-select">
                <option value="1">Last Day</option>
                <option value="3">Last 3 Days</option>
                <option value="7">Last Week</option>
                <option value="30">Last Month</option>
                <option value="90">Last 3 Months</option>
                <option value="180">Last 6 Months</option>
                <option value="365">Last Year</option>
                <option value="730">Last 2 Years</option>
                <option value="0">All Time</option>
              </select>
            </div>
          </div>
          
          <button class="mobile-submit-btn warning" id="mobile-remap-btn">
            <i class="fas fa-route"></i>
            Re-Match Trips
          </button>
          
          <div id="mobile-remap-status" class="mobile-form-status d-none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Save Button -->
  <button class="mobile-save-fab" id="mobile-save-config-fab" title="Save Configuration">
    <i class="fas fa-save"></i>
  </button>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Task Details</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="task-details-content"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button type="button" class="btn btn-primary run-task-btn">
          <i class="fas fa-play"></i> Run Now
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Pause Tasks Modal -->
<div class="modal fade" id="pauseModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Pause Tasks</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Pausing tasks will temporarily stop scheduled task execution.
          Running tasks will complete, but no new tasks will start.
        </p>
        <div class="mb-3">
          <label for="pauseDuration" class="form-label">Pause Duration (minutes):</label>
          <input type="number" class="form-control" id="pauseDuration" min="1" value="60" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-warning" id="confirmPause">
          Pause Tasks
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Clear History Confirmation Modal -->
<div class="modal fade" id="clearHistoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Clear Task History</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to clear the task history? This action cannot be
          undone.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmClearHistory">
          Clear History
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Task Status Template (hidden) -->
<template id="task-status-template">
  <div class="task-status d-flex align-items-center">
    <div class="spinner-border spinner-border-sm me-2" role="status">
      <span class="visually-hidden">Running...</span>
    </div>
    <span class="status-text">Running...</span>
    <div class="progress ms-2" style="width: 100px; height: 6px">
      <div
        class="progress-bar progress-bar-striped progress-bar-animated"
        role="progressbar"
        style="width: 0%"
      ></div>
    </div>
  </div>
</template>

{% endblock %} {% block extra_js %}
<script src="{{ url_for('static', path='js/settings.js') | replace('http://', '//') }}"></script>
{% endblock %}
