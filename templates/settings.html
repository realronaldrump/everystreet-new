{% extends "base.html" %} {% block title %}Settings{% endblock %} 
{% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', path='css/settings-mobile.css') | replace('http://', '//') }}"
/>
<style>
  /* Settings Tab Navigation */
  .settings-tabs {
    display: flex;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: var(--surface-1);
    border-bottom: 1px solid var(--border-color);
    margin-bottom: var(--space-4);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .settings-tab {
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .settings-tab:hover {
    background: var(--surface-2);
    color: var(--text-primary);
  }

  .settings-tab.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }

  .settings-tab i {
    font-size: var(--font-size-md);
  }

  .settings-tab-content {
    display: none;
  }

  .settings-tab-content.active {
    display: block;
  }

  /* Preferences Section Styles */
  .preferences-section {
    padding: var(--space-4);
  }

  .settings-group {
    background: var(--surface-1);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-4);
  }

  .settings-group-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-3);
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .settings-group-title i {
    color: var(--primary);
    opacity: 0.8;
  }

  .setting-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3) 0;
    border-bottom: 1px solid var(--border-color);
  }

  .setting-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .setting-item:first-child {
    padding-top: 0;
  }

  .setting-label {
    flex: 1;
  }

  .setting-label-title {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
    margin-bottom: var(--space-1);
  }

  .setting-label-description {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    line-height: 1.4;
  }

  .setting-control {
    margin-left: var(--space-4);
    flex-shrink: 0;
  }

  /* Color picker inline */
  .color-picker-row {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-wrap: wrap;
  }

  .color-picker-row input[type="color"] {
    width: 48px;
    height: 36px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 2px;
    cursor: pointer;
    background: var(--surface-2);
  }

  .opacity-slider {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .opacity-slider input[type="range"] {
    width: 100px;
  }

  .opacity-slider-value {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    min-width: 30px;
  }

  /* Save button for preferences */
  .preferences-actions {
    display: flex;
    gap: var(--space-3);
    justify-content: flex-end;
    padding-top: var(--space-4);
  }

  @media (max-width: 768px) {
    .settings-tabs {
      padding: var(--space-2);
      gap: var(--space-1);
    }

    .settings-tab {
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-size-xs);
    }

    .settings-tab span {
      display: none;
    }

    .settings-tab i {
      font-size: var(--font-size-lg);
    }

    .setting-item {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-2);
    }

    .setting-control {
      margin-left: 0;
      width: 100%;
    }

    .color-picker-row {
      width: 100%;
    }

    .preferences-actions {
      flex-direction: column;
    }

    .preferences-actions .btn {
      width: 100%;
    }
  }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid settings-desktop-container">
  <!-- Tab Navigation -->
  <div class="settings-tabs">
    <button class="settings-tab active" data-tab="preferences">
      <i class="fas fa-sliders-h"></i>
      <span>Preferences</span>
    </button>
    <button class="settings-tab" data-tab="background-tasks">
      <i class="fas fa-tasks"></i>
      <span>Background Tasks</span>
    </button>
    <button class="settings-tab" data-tab="data-management">
      <i class="fas fa-database"></i>
      <span>Data Management</span>
    </button>
  </div>

  <!-- Preferences Tab -->
  <div class="settings-tab-content active" id="preferences-tab">
    <div class="preferences-section">
      <form id="app-settings-form">
        <!-- Appearance Settings -->
        <div class="settings-group">
          <h3 class="settings-group-title">
            <i class="fas fa-palette"></i>
            Appearance
          </h3>
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-label-title">Dark Mode</div>
              <div class="setting-label-description">Use dark theme for the application interface</div>
            </div>
            <div class="setting-control">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle" checked />
              </div>
            </div>
          </div>
        </div>

        <!-- Map Settings -->
        <div class="settings-group">
          <h3 class="settings-group-title">
            <i class="fas fa-map"></i>
            Map
          </h3>
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-label-title">Highlight Recent Trips</div>
              <div class="setting-label-description">Visually emphasize recently completed trips on the map</div>
            </div>
            <div class="setting-control">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="highlight-recent-trips" checked />
              </div>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-label-title">Auto-Center on Live Location</div>
              <div class="setting-label-description">Automatically center the map on your current location during live tracking</div>
            </div>
            <div class="setting-control">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="auto-center-toggle" checked />
              </div>
            </div>
          </div>
        </div>

        <!-- Live Tracking Settings -->
        <div class="settings-group">
          <h3 class="settings-group-title">
            <i class="fas fa-broadcast-tower"></i>
            Live Tracking
          </h3>
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-label-title">Show Live Tracking Panel</div>
              <div class="setting-label-description">Display the live tracking panel on the main map</div>
            </div>
            <div class="setting-control">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="show-live-tracking" checked />
              </div>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-label-title">Tracking Path Style</div>
              <div class="setting-label-description">Customize the color and opacity of the live tracking path</div>
            </div>
            <div class="setting-control">
              <div class="color-picker-row">
                <input type="color" id="polyline-color" value="#00FF00" />
                <div class="opacity-slider">
                  <span>Opacity:</span>
                  <input type="range" min="0.1" max="1" step="0.1" id="polyline-opacity" value="0.8" />
                  <span id="opacity-value" class="opacity-slider-value">0.8</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Trip Processing Settings -->
        <div class="settings-group">
          <h3 class="settings-group-title">
            <i class="fas fa-cogs"></i>
            Trip Processing
          </h3>
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-label-title">Geocode Trips on Fetch</div>
              <div class="setting-label-description">Automatically reverse geocode trips when fetched from Bouncie to get start and end locations. Disable to reduce processing time.</div>
            </div>
            <div class="setting-control">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="geocode-trips-on-fetch" checked />
              </div>
            </div>
          </div>
        </div>

        <div class="preferences-actions">
          <button type="reset" class="btn btn-outline-secondary">
            <i class="fas fa-undo"></i> Reset
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Preferences
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Background Tasks Tab -->
  <div class="settings-tab-content" id="background-tasks-tab">
    <div class="row">
      <div class="col-12">
        <h2>Background Task Management</h2>
        <div class="card bg-dark text-white mb-4">
          <div class="card-body">
            <h3 class="h5">Global Task Control</h3>
            <div class="form-check form-switch mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="globalDisableSwitch"
              />
              <label class="form-check-label" for="globalDisableSwitch">
                Globally Disable Tasks
              </label>
            </div>
            <div class="btn-group mb-3">
              <button
                class="btn btn-warning"
                data-bs-toggle="modal"
                data-bs-target="#pauseModal"
              >
                <i class="fas fa-pause"></i> Pause Tasks
              </button>
              <button class="btn btn-success" id="resumeBtn">
                <i class="fas fa-play"></i> Resume Tasks
              </button>
              <button class="btn btn-danger" id="stopAllBtn">
                <i class="fas fa-stop"></i> Stop All
              </button>
            </div>
            <div class="btn-group mb-3 ms-2">
              <button class="btn btn-primary" id="enableAllBtn">
                <i class="fas fa-check"></i> Enable All
              </button>
              <button class="btn btn-secondary" id="disableAllBtn">
                <i class="fas fa-times"></i> Disable All
              </button>
              <button class="btn btn-info" id="manualRunAllBtn">
                <i class="fas fa-play-circle"></i> Run All Now
              </button>
              <button class="btn btn-warning" id="resetTasksBtn">
                <i class="fas fa-sync"></i> Reset Tasks
              </button>
            </div>
          </div>
        </div>

        <div class="card bg-dark text-white mb-4">
          <div class="card-body">
            <h3 class="h5">Task Configuration</h3>
            <div class="table-responsive-lg">
              <table class="table table-dark" id="taskConfigTable">
                <thead>
                  <tr>
                    <th>Task</th>
                    <th>Interval</th>
                    <th>Enabled</th>
                    <th style="width: 150px">Status</th>
                    <th>Last Run</th>
                    <th>Next Run</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Task rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
            <button class="btn btn-primary" id="saveTaskConfigBtn">
              <i class="fas fa-save"></i> Save Configuration
            </button>
          </div>
        </div>

        <div class="card bg-dark text-white mb-4" id="manual-fetch-card">
          <div class="card-body">
            <h3 class="h5">Manual Trip Fetch</h3>
            <p class="text-muted small">
              Schedule an on-demand trip fetch for a specific date range. Map
              matching can be toggled for the fetched trips.
            </p>
            <form id="manualFetchTripsForm" class="row g-3">
              <div class="col-md-4">
                <label for="manual-fetch-start" class="form-label">Start</label>
                <input
                  type="datetime-local"
                  class="form-control"
                  id="manual-fetch-start"
                  required
                />
              </div>
              <div class="col-md-4">
                <label for="manual-fetch-end" class="form-label">End</label>
                <input
                  type="datetime-local"
                  class="form-control"
                  id="manual-fetch-end"
                  required
                />
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="manual-fetch-map-match"
                  />
                  <label class="form-check-label" for="manual-fetch-map-match">
                    Enable map matching
                  </label>
                </div>
              </div>
              <div class="col-12 d-flex align-items-center">
                <button
                  type="submit"
                  class="btn btn-success"
                  id="manual-fetch-submit"
                >
                  <i class="fas fa-cloud-download-alt"></i> Fetch Trips
                </button>
                <span class="ms-3 text-muted" id="manual-fetch-status"></span>
              </div>
            </form>
          </div>
        </div>

        <div class="card bg-dark text-white mb-4">
          <div class="card-body">
            <h3 class="h5">Fetch All Missing Trips</h3>
            <p class="text-muted small">
              Fetches all trips from a configurable start date to now. Useful for filling gaps.
            </p>
            <div class="d-flex align-items-center">
              <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#fetchAllMissingModal" id="openFetchAllMissingModalBtn">
                <i class="fas fa-sync-alt"></i> Fetch All Missing Trips
              </button>
              <span class="ms-3 text-muted" id="fetchAllMissingStatus"></span>
            </div>
          </div>
        </div>

        <div class="card bg-dark text-white mb-4">
          <div class="card-body">
            <h3 class="h5">Task History</h3>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <button class="btn btn-danger btn-sm" id="clearHistoryBtn">
                <i class="fas fa-trash"></i> Clear History
              </button>
            </div>
            <div class="table-responsive-lg">
              <table class="table table-dark" id="taskHistoryTable">
                <thead>
                  <tr>
                    <th>Task</th>
                    <th>Status</th>
                    <th>Start Time</th>
                    <th>Duration</th>
                    <th>Result</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Task history will be populated by JavaScript -->
                </tbody>
              </table>
              <div id="taskHistoryPagination" class="mt-3">
                <!-- Pagination controls will be added by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Management Tab -->
  <div class="settings-tab-content" id="data-management-tab">
    <div class="row">
      <div class="col-12">
        <h2>Data Management</h2>

        <!-- Invalid Trips Section -->
        <div class="card bg-dark text-white mb-4">
          <div class="card-body">
            <h3 class="h5">Invalid Trips Review</h3>
            <p class="text-muted small">
              Review trips that were marked as invalid. You can restore them if they are valid or permanently delete them.
            </p>
            <div class="table-responsive-lg">
              <table class="table table-dark table-hover" id="invalidTripsTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Source</th>
                    <th>Reason</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
            <div id="invalidTripsPagination" class="mt-3"></div>
          </div>
        </div>

        <!-- Re-geocode Trips Section -->
        <div class="card bg-dark text-white mb-4">
          <div class="card-body">
            <h3 class="h5">Re-geocode Trips</h3>
            <p>Re-geocode trips within a date range. Only trips without addresses will be geocoded. Efficiently checks against custom places.</p>

            <div class="mb-3">
              <label for="geocode-type" class="form-label">Select Method:</label>
              <select id="geocode-type" class="form-select">
                <option value="date">Pick a Date Range</option>
                <option value="interval">Use a Predefined Interval</option>
                <option value="all">All Trips</option>
              </select>
            </div>

            <div id="geocode-date-range">
              <div class="mb-3">
                <label for="geocode-start" class="form-label">Start Date:</label>
                <input
                  type="text"
                  id="geocode-start"
                  class="form-control datepicker"
                />
              </div>
              <div class="mb-3">
                <label for="geocode-end" class="form-label">End Date:</label>
                <input
                  type="text"
                  id="geocode-end"
                  class="form-control datepicker"
                />
              </div>
            </div>

            <div id="geocode-interval" style="display: none">
              <div class="mb-3">
                <label for="geocode-interval-select" class="form-label">Select Interval:</label>
                <select id="geocode-interval-select" class="form-select">
                  <option value="1">Last Day</option>
                  <option value="3">Last 3 Days</option>
                  <option value="7">Last Week</option>
                  <option value="30">Last Month</option>
                  <option value="90">Last 3 Months</option>
                  <option value="180">Last 6 Months</option>
                  <option value="365">Last Year</option>
                  <option value="730">Last 2 Years</option>
                </select>
              </div>
            </div>

            <button id="geocode-trips-btn" class="btn btn-warning">
              <i class="fas fa-sync-alt"></i> Re-geocode Trips
            </button>
            <div id="geocode-trips-status" class="mt-2"></div>
            
            <!-- Progress Panel -->
            <div id="geocode-progress-panel" class="mt-3" style="display: none">
              <div class="card bg-secondary">
                <div class="card-body">
                  <h5 class="card-title">Geocoding Progress</h5>
                  <div class="progress mb-2" style="height: 25px">
                    <div
                      id="geocode-progress-bar"
                      class="progress-bar progress-bar-striped progress-bar-animated"
                      role="progressbar"
                      style="width: 0%"
                      aria-valuenow="0"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    >
                      0%
                    </div>
                  </div>
                  <div id="geocode-progress-message" class="small mb-2"></div>
                  <div id="geocode-progress-metrics" class="small text-muted"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Remap Matched Trips Section -->
        <div class="card bg-dark text-white mb-4">
          <div class="card-body">
            <h3 class="h5">Remap Matched Trips</h3>
            <p>
              Re-match trips to the street network within a specific date range.
            </p>

            <div class="mb-3">
              <label for="remap-type" class="form-label">Select Method:</label>
              <select id="remap-type" class="form-select">
                <option value="date">Pick a Date Range</option>
                <option value="interval">Use a Predefined Interval</option>
              </select>
            </div>

            <div id="remap-date-range">
              <div class="mb-3">
                <label for="remap-start" class="form-label">Start Date:</label>
                <input
                  type="text"
                  id="remap-start"
                  class="form-control datepicker"
                />
              </div>
              <div class="mb-3">
                <label for="remap-end" class="form-label">End Date:</label>
                <input
                  type="text"
                  id="remap-end"
                  class="form-control datepicker"
                />
              </div>
            </div>

            <div id="remap-interval" style="display: none">
              <div class="mb-3">
                <label for="remap-interval-select" class="form-label">Select Interval:</label>
                <select id="remap-interval-select" class="form-select">
                  <option value="1">Last Day</option>
                  <option value="3">Last 3 Days</option>
                  <option value="7">Last Week</option>
                  <option value="30">Last Month</option>
                  <option value="90">Last 3 Months</option>
                  <option value="180">Last 6 Months</option>
                  <option value="365">Last Year</option>
                  <option value="730">Last 2 Years</option>
                  <option value="0">All Time</option>
                </select>
              </div>
            </div>

            <button id="remap-btn" class="btn btn-warning">
              <i class="fas fa-route"></i> Re-Match Trips
            </button>
            <div id="remap-status" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Container -->
<div class="container-fluid settings-mobile-container">
  <!-- Mobile Tab Navigation -->
  <div class="settings-tabs">
    <button class="settings-tab active" data-tab="preferences">
      <i class="fas fa-sliders-h"></i>
    </button>
    <button class="settings-tab" data-tab="background-tasks">
      <i class="fas fa-tasks"></i>
    </button>
    <button class="settings-tab" data-tab="data-management">
      <i class="fas fa-database"></i>
    </button>
  </div>

  <!-- Mobile Preferences Tab -->
  <div class="settings-tab-content active" id="mobile-preferences-tab">
    <div class="mobile-settings-section">
      <div class="mobile-settings-section-header expanded" data-section="appearance">
        <h2 class="mobile-settings-section-title">
          <i class="fas fa-palette"></i>
          Appearance
        </h2>
        <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
      </div>
      <div class="mobile-settings-section-content expanded" id="mobile-appearance">
        <div class="mobile-settings-section-body">
          <div class="mobile-control-item">
            <span class="mobile-control-label">Dark Mode</span>
            <input type="checkbox" class="mobile-switch" id="mobile-dark-mode-toggle" checked />
          </div>
        </div>
      </div>
    </div>

    <div class="mobile-settings-section">
      <div class="mobile-settings-section-header expanded" data-section="map-settings">
        <h2 class="mobile-settings-section-title">
          <i class="fas fa-map"></i>
          Map Settings
        </h2>
        <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
      </div>
      <div class="mobile-settings-section-content expanded" id="mobile-map-settings">
        <div class="mobile-settings-section-body">
          <div class="mobile-control-item">
            <span class="mobile-control-label">Highlight Recent Trips</span>
            <input type="checkbox" class="mobile-switch" id="mobile-highlight-recent-trips" checked />
          </div>
          <div class="mobile-control-item mt-3">
            <span class="mobile-control-label">Auto-Center on Location</span>
            <input type="checkbox" class="mobile-switch" id="mobile-auto-center-toggle" checked />
          </div>
        </div>
      </div>
    </div>

    <div class="mobile-settings-section">
      <div class="mobile-settings-section-header expanded" data-section="live-tracking">
        <h2 class="mobile-settings-section-title">
          <i class="fas fa-broadcast-tower"></i>
          Live Tracking
        </h2>
        <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
      </div>
      <div class="mobile-settings-section-content expanded" id="mobile-live-tracking">
        <div class="mobile-settings-section-body">
          <div class="mobile-control-item">
            <span class="mobile-control-label">Show Live Tracking</span>
            <input type="checkbox" class="mobile-switch" id="mobile-show-live-tracking" checked />
          </div>
          <div class="mobile-form-group mt-3">
            <label class="mobile-form-label">Path Color</label>
            <input type="color" class="mobile-form-input" id="mobile-polyline-color" value="#00FF00" style="height: 44px;" />
          </div>
          <div class="mobile-form-group">
            <label class="mobile-form-label">Path Opacity: <span id="mobile-opacity-value">0.8</span></label>
            <input type="range" class="mobile-form-input" min="0.1" max="1" step="0.1" id="mobile-polyline-opacity" value="0.8" />
          </div>
        </div>
      </div>
    </div>

    <div class="mobile-settings-section">
      <div class="mobile-settings-section-header expanded" data-section="trip-processing">
        <h2 class="mobile-settings-section-title">
          <i class="fas fa-cogs"></i>
          Trip Processing
        </h2>
        <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
      </div>
      <div class="mobile-settings-section-content expanded" id="mobile-trip-processing">
        <div class="mobile-settings-section-body">
          <div class="mobile-control-item">
            <span class="mobile-control-label">Geocode on Fetch</span>
            <input type="checkbox" class="mobile-switch" id="mobile-geocode-trips-on-fetch" checked />
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Save Button for Preferences -->
    <div class="p-3">
      <button class="mobile-submit-btn primary" id="mobile-save-preferences">
        <i class="fas fa-save"></i> Save Preferences
      </button>
    </div>
  </div>

  <!-- Mobile Background Tasks Tab -->
  <div class="settings-tab-content" id="mobile-background-tasks-tab">
    <!-- Mobile: Global Controls Section -->
    <div class="mobile-settings-section">
      <div class="mobile-settings-section-header" data-section="global-controls">
        <h2 class="mobile-settings-section-title">
          <i class="fas fa-sliders-h"></i>
          Global Controls
        </h2>
        <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
      </div>
      <div class="mobile-settings-section-content" id="mobile-global-controls">
        <div class="mobile-settings-section-body">
          <div class="mobile-global-controls">
            <div class="mobile-control-item">
              <span class="mobile-control-label">Globally Disable Tasks</span>
              <input type="checkbox" class="mobile-switch" id="mobile-globalDisableSwitch" />
            </div>
          </div>
          
          <div class="mobile-action-grid mt-3">
            <button class="mobile-action-btn warning" id="mobile-pauseBtn">
              <i class="fas fa-pause"></i>
              <span>Pause Tasks</span>
            </button>
            <button class="mobile-action-btn success" id="mobile-resumeBtn">
              <i class="fas fa-play"></i>
              <span>Resume Tasks</span>
            </button>
            <button class="mobile-action-btn danger" id="mobile-stopAllBtn">
              <i class="fas fa-stop"></i>
              <span>Stop All</span>
            </button>
            <button class="mobile-action-btn warning" id="mobile-resetTasksBtn">
              <i class="fas fa-sync"></i>
              <span>Reset Tasks</span>
            </button>
            <button class="mobile-action-btn primary" id="mobile-enableAllBtn">
              <i class="fas fa-check"></i>
              <span>Enable All</span>
            </button>
            <button class="mobile-action-btn" id="mobile-disableAllBtn">
              <i class="fas fa-times"></i>
              <span>Disable All</span>
            </button>
            <button class="mobile-action-btn info" id="mobile-manualRunAllBtn">
              <i class="fas fa-play-circle"></i>
              <span>Run All Now</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile: Task Configuration Section -->
    <div class="mobile-settings-section">
      <div class="mobile-settings-section-header expanded" data-section="task-config">
        <h2 class="mobile-settings-section-title">
          <i class="fas fa-tasks"></i>
          Task Configuration
        </h2>
        <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
      </div>
      <div class="mobile-settings-section-content expanded" id="mobile-task-config">
        <div class="mobile-settings-section-body">
          <div id="mobile-task-list">
            <!-- Task cards will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile: Manual Trip Fetch Section -->
    <div class="mobile-settings-section" id="mobile-manual-fetch-section">
      <div class="mobile-settings-section-header" data-section="manual-fetch">
        <h2 class="mobile-settings-section-title">
          <i class="fas fa-cloud-download-alt"></i>
          Manual Trip Fetch
        </h2>
        <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
      </div>
      <div class="mobile-settings-section-content" id="mobile-manual-fetch">
        <div class="mobile-settings-section-body">
          <form id="mobile-manualFetchTripsForm">
            <div class="mobile-form-group">
              <label class="mobile-form-label" for="mobile-manual-fetch-start">Start Date & Time</label>
              <input type="datetime-local" class="mobile-form-input" id="mobile-manual-fetch-start" required />
            </div>
            
            <div class="mobile-form-group">
              <label class="mobile-form-label" for="mobile-manual-fetch-end">End Date & Time</label>
              <input type="datetime-local" class="mobile-form-input" id="mobile-manual-fetch-end" required />
            </div>
            
            <div class="mobile-form-group">
              <div class="mobile-form-checkbox-wrapper">
                <input type="checkbox" id="mobile-manual-fetch-map-match" />
                <label class="mobile-form-checkbox-label" for="mobile-manual-fetch-map-match">
                  Enable map matching
                </label>
              </div>
            </div>
            
            <button type="submit" class="mobile-submit-btn success">
              <i class="fas fa-cloud-download-alt"></i>
              Fetch Trips
            </button>
            
            <div id="mobile-manual-fetch-status" class="mobile-form-status d-none"></div>
          </form>
        </div>
      </div>
    </div>

    <!-- Mobile: Task History Section -->
    <div class="mobile-settings-section">
      <div class="mobile-settings-section-header" data-section="task-history">
        <h2 class="mobile-settings-section-title">
          <i class="fas fa-history"></i>
          Task History
        </h2>
        <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
      </div>
      <div class="mobile-settings-section-content" id="mobile-task-history">
        <div class="mobile-settings-section-body">
          <button class="mobile-submit-btn danger mb-3" id="mobile-clearHistoryBtn">
            <i class="fas fa-trash"></i>
            Clear History
          </button>
          
          <div id="mobile-history-list">
            <!-- History cards will be populated by JavaScript -->
          </div>
          
          <div class="mobile-pagination" id="mobile-history-pagination" style="display: none;">
            <button class="mobile-pagination-btn" id="mobile-history-prev" disabled>
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <span class="mobile-pagination-info" id="mobile-history-page-info"></span>
            <button class="mobile-pagination-btn" id="mobile-history-next">
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Save Button -->
    <button class="mobile-save-fab" id="mobile-save-config-fab" title="Save Configuration">
      <i class="fas fa-save"></i>
    </button>
  </div>

  <!-- Mobile Data Management Tab -->
  <div class="settings-tab-content" id="mobile-data-management-tab">
    <div class="mobile-settings-section">
      <div class="mobile-settings-section-header" data-section="data-management">
        <h2 class="mobile-settings-section-title">
          <i class="fas fa-database"></i>
          Data Management
        </h2>
        <i class="fas fa-chevron-down mobile-settings-section-chevron"></i>
      </div>
      <div class="mobile-settings-section-content" id="mobile-data-management">
        <div class="mobile-settings-section-body">
          <!-- Re-geocode Trips -->
          <div class="mb-4">
            <h3 class="mobile-form-label">Re-geocode Trips</h3>
            <p class="mobile-form-hint mb-3">Re-geocode trips within a date range. Only trips without addresses will be geocoded.</p>
            
            <div class="mobile-date-method-tabs mb-3">
              <button type="button" class="mobile-date-method-tab active" data-method="date" data-target="geocode">
                Date Range
              </button>
              <button type="button" class="mobile-date-method-tab" data-method="interval" data-target="geocode">
                Interval
              </button>
              <button type="button" class="mobile-date-method-tab" data-method="all" data-target="geocode">
                All Trips
              </button>
            </div>

            <div id="mobile-geocode-date-range">
              <div class="mobile-form-group">
                <label class="mobile-form-label" for="mobile-geocode-start">Start Date</label>
                <input type="text" class="mobile-form-input datepicker" id="mobile-geocode-start" />
              </div>
              
              <div class="mobile-form-group">
                <label class="mobile-form-label" for="mobile-geocode-end">End Date</label>
                <input type="text" class="mobile-form-input datepicker" id="mobile-geocode-end" />
              </div>
            </div>

            <div id="mobile-geocode-interval" style="display: none;">
              <div class="mobile-form-group">
                <label class="mobile-form-label" for="mobile-geocode-interval-select">Select Interval</label>
                <select class="mobile-form-select" id="mobile-geocode-interval-select">
                  <option value="1">Last Day</option>
                  <option value="3">Last 3 Days</option>
                  <option value="7">Last Week</option>
                  <option value="30">Last Month</option>
                  <option value="90">Last 3 Months</option>
                  <option value="180">Last 6 Months</option>
                  <option value="365">Last Year</option>
                  <option value="730">Last 2 Years</option>
                </select>
              </div>
            </div>
            
            <button class="mobile-submit-btn warning" id="mobile-geocode-trips-btn">
              <i class="fas fa-sync-alt"></i>
              Re-geocode Trips
            </button>
            
            <div id="mobile-geocode-trips-status" class="mobile-form-status d-none"></div>
            
            <!-- Progress Panel -->
            <div id="mobile-geocode-progress-panel" class="mt-3" style="display: none">
              <div class="card bg-secondary">
                <div class="card-body">
                  <h5 class="card-title">Geocoding Progress</h5>
                  <div class="progress mb-2" style="height: 25px">
                    <div
                      id="mobile-geocode-progress-bar"
                      class="progress-bar progress-bar-striped progress-bar-animated"
                      role="progressbar"
                      style="width: 0%"
                      aria-valuenow="0"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    >
                      0%
                    </div>
                  </div>
                  <div id="mobile-geocode-progress-message" class="small mb-2"></div>
                  <div id="mobile-geocode-progress-metrics" class="small text-muted"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Remap Matched Trips -->
          <div>
            <h3 class="mobile-form-label">Remap Matched Trips</h3>
            <p class="mobile-form-hint mb-3">Re-match trips to the street network within a specific date range.</p>
            
            <div class="mobile-date-method-tabs mb-3">
              <button type="button" class="mobile-date-method-tab active" data-method="date">
                Date Range
              </button>
              <button type="button" class="mobile-date-method-tab" data-method="interval">
                Interval
              </button>
            </div>

            <div id="mobile-remap-date-range">
              <div class="mobile-form-group">
                <label class="mobile-form-label" for="mobile-remap-start">Start Date</label>
                <input type="text" class="mobile-form-input datepicker" id="mobile-remap-start" />
              </div>
              
              <div class="mobile-form-group">
                <label class="mobile-form-label" for="mobile-remap-end">End Date</label>
                <input type="text" class="mobile-form-input datepicker" id="mobile-remap-end" />
              </div>
            </div>

            <div id="mobile-remap-interval" style="display: none;">
              <div class="mobile-form-group">
                <label class="mobile-form-label" for="mobile-remap-interval-select">Select Interval</label>
                <select class="mobile-form-select" id="mobile-remap-interval-select">
                  <option value="1">Last Day</option>
                  <option value="3">Last 3 Days</option>
                  <option value="7">Last Week</option>
                  <option value="30">Last Month</option>
                  <option value="90">Last 3 Months</option>
                  <option value="180">Last 6 Months</option>
                  <option value="365">Last Year</option>
                  <option value="730">Last 2 Years</option>
                  <option value="0">All Time</option>
                </select>
              </div>
            </div>
            
            <button class="mobile-submit-btn warning" id="mobile-remap-btn">
              <i class="fas fa-route"></i>
              Re-Match Trips
            </button>
            
            <div id="mobile-remap-status" class="mobile-form-status d-none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Task Details</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="task-details-content"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button type="button" class="btn btn-primary run-task-btn">
          <i class="fas fa-play"></i> Run Now
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Pause Tasks Modal -->
<div class="modal fade" id="pauseModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Pause Tasks</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Pausing tasks will temporarily stop scheduled task execution.
          Running tasks will complete, but no new tasks will start.
        </p>
        <div class="mb-3">
          <label for="pauseDuration" class="form-label">Pause Duration (minutes):</label>
          <input type="number" class="form-control" id="pauseDuration" min="1" value="60" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-warning" id="confirmPause">
          Pause Tasks
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Clear History Confirmation Modal -->
<div class="modal fade" id="clearHistoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Clear Task History</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to clear the task history? This action cannot be
          undone.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmClearHistory">
          Clear History
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Task Status Template (hidden) -->
<template id="task-status-template">
  <div class="task-status d-flex align-items-center">
    <div class="spinner-border spinner-border-sm me-2" role="status">
      <span class="visually-hidden">Running...</span>
    </div>
    <span class="status-text">Running...</span>
    <div class="progress ms-2" style="width: 100px; height: 6px">
      <div
        class="progress-bar progress-bar-striped progress-bar-animated"
        role="progressbar"
        style="width: 0%"
      ></div>
    </div>
  </div>
</template>

<!-- Fetch All Missing Trips Modal -->
<div
  class="modal fade"
  id="fetchAllMissingModal"
  tabindex="-1"
  aria-labelledby="fetchAllMissingModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="fetchAllMissingModalLabel">
          Fetch All Missing Trips
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          This will fetch all trips from the selected start date up to now.
          This process may take a while.
        </p>
        <div class="mb-3">
          <label for="fetchAllMissingStart" class="form-label">Start Date</label>
          <input
            type="datetime-local"
            class="form-control"
            id="fetchAllMissingStart"
          />
          <div class="form-text text-muted">
            Defaults to the earliest trip found in your database.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-warning"
          id="confirmFetchAllMissing"
        >
          Start Fetch
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script src="{{ url_for('static', path='js/settings.js') | replace('http://', '//') }}"></script>
<script>
  // Tab switching logic
  document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.settings-tab');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const tabName = this.dataset.tab;
        
        // Update tab buttons in both desktop and mobile
        document.querySelectorAll('.settings-tab').forEach(t => {
          t.classList.toggle('active', t.dataset.tab === tabName);
        });
        
        // Update tab content - desktop
        document.querySelectorAll('.settings-desktop-container .settings-tab-content').forEach(content => {
          content.classList.remove('active');
        });
        const desktopContent = document.getElementById(`${tabName}-tab`);
        if (desktopContent) desktopContent.classList.add('active');
        
        // Update tab content - mobile
        document.querySelectorAll('.settings-mobile-container .settings-tab-content').forEach(content => {
          content.classList.remove('active');
        });
        const mobileContent = document.getElementById(`mobile-${tabName}-tab`);
        if (mobileContent) mobileContent.classList.add('active');
      });
    });

    // App Settings Form Functionality
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const highlightRecentTrips = document.getElementById('highlight-recent-trips');
    const autoCenterToggle = document.getElementById('auto-center-toggle');
    const showLiveTracking = document.getElementById('show-live-tracking');
    const polylineColor = document.getElementById('polyline-color');
    const polylineOpacity = document.getElementById('polyline-opacity');
    const opacityValue = document.getElementById('opacity-value');
    const geocodeTripsOnFetch = document.getElementById('geocode-trips-on-fetch');
    const form = document.getElementById('app-settings-form');
    const themeToggleCheckbox = document.getElementById('theme-toggle-checkbox');

    // Mobile elements
    const mobileDarkModeToggle = document.getElementById('mobile-dark-mode-toggle');
    const mobileHighlightRecentTrips = document.getElementById('mobile-highlight-recent-trips');
    const mobileAutoCenterToggle = document.getElementById('mobile-auto-center-toggle');
    const mobileShowLiveTracking = document.getElementById('mobile-show-live-tracking');
    const mobilePolylineColor = document.getElementById('mobile-polyline-color');
    const mobilePolylineOpacity = document.getElementById('mobile-polyline-opacity');
    const mobileOpacityValue = document.getElementById('mobile-opacity-value');
    const mobileGeocodeTripsOnFetch = document.getElementById('mobile-geocode-trips-on-fetch');
    const mobileSaveBtn = document.getElementById('mobile-save-preferences');

    // Function to apply settings to UI
    function applySettings(settings = {}) {
      const {
        highlightRecentTrips: hrt,
        autoCenter,
        showLiveTracking: slt,
        polylineColor: pc,
        polylineOpacity: po,
        geocodeTripsOnFetch: gtof,
      } = settings;

      const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
      
      // Desktop
      if (darkModeToggle) darkModeToggle.checked = isDarkMode;
      if (highlightRecentTrips) highlightRecentTrips.checked = hrt !== false;
      if (autoCenterToggle) autoCenterToggle.checked = autoCenter !== false;
      if (showLiveTracking) showLiveTracking.checked = slt !== false;
      if (geocodeTripsOnFetch) geocodeTripsOnFetch.checked = gtof !== false;
      if (polylineColor) polylineColor.value = pc || localStorage.getItem('polylineColor') || '#00FF00';
      if (polylineOpacity) {
        polylineOpacity.value = po || localStorage.getItem('polylineOpacity') || '0.8';
        if (opacityValue) opacityValue.textContent = polylineOpacity.value;
      }

      // Mobile
      if (mobileDarkModeToggle) mobileDarkModeToggle.checked = isDarkMode;
      if (mobileHighlightRecentTrips) mobileHighlightRecentTrips.checked = hrt !== false;
      if (mobileAutoCenterToggle) mobileAutoCenterToggle.checked = autoCenter !== false;
      if (mobileShowLiveTracking) mobileShowLiveTracking.checked = slt !== false;
      if (mobileGeocodeTripsOnFetch) mobileGeocodeTripsOnFetch.checked = gtof !== false;
      if (mobilePolylineColor) mobilePolylineColor.value = pc || localStorage.getItem('polylineColor') || '#00FF00';
      if (mobilePolylineOpacity) {
        mobilePolylineOpacity.value = po || localStorage.getItem('polylineOpacity') || '0.8';
        if (mobileOpacityValue) mobileOpacityValue.textContent = mobilePolylineOpacity.value;
      }
    }

    // Load settings from server
    (async () => {
      try {
        const res = await fetch('/api/app_settings');
        if (res.ok) {
          const data = await res.json();
          applySettings(data);
        } else {
          console.warn('Failed to fetch app settings. HTTP', res.status);
          applySettings();
        }
      } catch (err) {
        console.error('Error fetching app settings:', err);
        applySettings();
      }
    })();

    // Sync opacity display
    if (polylineOpacity && opacityValue) {
      polylineOpacity.addEventListener('input', function() {
        opacityValue.textContent = this.value;
      });
    }
    if (mobilePolylineOpacity && mobileOpacityValue) {
      mobilePolylineOpacity.addEventListener('input', function() {
        mobileOpacityValue.textContent = this.value;
      });
    }

    // Save preferences function
    async function savePreferences(isDesktop = true) {
      const payload = {
        highlightRecentTrips: isDesktop 
          ? highlightRecentTrips?.checked 
          : mobileHighlightRecentTrips?.checked,
        autoCenter: isDesktop 
          ? autoCenterToggle?.checked 
          : mobileAutoCenterToggle?.checked,
        showLiveTracking: isDesktop 
          ? showLiveTracking?.checked 
          : mobileShowLiveTracking?.checked,
        polylineColor: isDesktop 
          ? polylineColor?.value 
          : mobilePolylineColor?.value,
        polylineOpacity: isDesktop 
          ? polylineOpacity?.value 
          : mobilePolylineOpacity?.value,
        geocodeTripsOnFetch: isDesktop 
          ? geocodeTripsOnFetch?.checked 
          : mobileGeocodeTripsOnFetch?.checked,
      };

      try {
        const resp = await fetch('/api/app_settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!resp.ok) {
          throw new Error(`Server returned ${resp.status}`);
        }
      } catch (err) {
        console.error('Error saving settings to server:', err);
        window.notificationManager?.show('Failed to save settings on server', 'danger');
        return;
      }

      // Mirror to localStorage
      localStorage.setItem('highlightRecentTrips', payload.highlightRecentTrips);
      localStorage.setItem('autoCenter', payload.autoCenter);
      localStorage.setItem('showLiveTracking', payload.showLiveTracking);
      localStorage.setItem('polylineColor', payload.polylineColor);
      localStorage.setItem('polylineOpacity', payload.polylineOpacity);

      // Show success
      if (window.notificationManager) {
        window.notificationManager.show('Settings saved successfully', 'success');
      }

      // Update live tracker if active
      if (window.liveTracker) {
        try {
          window.liveTracker.updatePolylineStyle(payload.polylineColor, payload.polylineOpacity);
        } catch (err) {
          console.error('Error updating live tracker style:', err);
        }
      }
    }

    // Desktop form submission
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        await savePreferences(true);
      });
    }

    // Mobile save button
    if (mobileSaveBtn) {
      mobileSaveBtn.addEventListener('click', async function() {
        await savePreferences(false);
      });
    }

    // Dark mode toggle sync
    if (darkModeToggle) {
      darkModeToggle.addEventListener('change', function() {
        if (themeToggleCheckbox) {
          themeToggleCheckbox.checked = !this.checked;
          themeToggleCheckbox.dispatchEvent(new Event('change'));
        }
      });
    }
    if (mobileDarkModeToggle) {
      mobileDarkModeToggle.addEventListener('change', function() {
        if (themeToggleCheckbox) {
          themeToggleCheckbox.checked = !this.checked;
          themeToggleCheckbox.dispatchEvent(new Event('change'));
        }
      });
    }
  });
</script>
{% endblock %}
