{% extends "base.html" %}

{% block title %}
Coverage Navigator
{% endblock %}


{% block head_content %}
  <meta name="mapbox-access-token" content="{{ MAPBOX_ACCESS_TOKEN }}" />
  <link rel="stylesheet" href="{{ CDN.mapbox_gl_css }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/coverage-navigator.css') | replace('http://', '//') }}?v={{ repo_version.commit_count }}" />
{% endblock %}


{% block content %}
  <div class="coverage-navigator" id="coverage-navigator" data-mode="select">
    <h1 class="visually-hidden">Coverage Navigator</h1>

    <!-- Mobile Panel Toggle -->
    <button type="button"
            class="mobile-panel-toggle"
            id="mobile-panel-toggle"
            aria-expanded="false"
            aria-controls="control-panel"
            aria-label="Toggle control panel">
      <i class="fas fa-sliders" aria-hidden="true"></i>
      <span class="toggle-text">Controls</span>
    </button>

    <aside class="control-panel" id="control-panel">
      <!-- Hero Section: Coverage Area Selection -->
      <section class="nav-hero" data-section="hero">
        <div class="nav-hero-header">
          <div class="nav-hero-badge">
            <i class="fas fa-route" aria-hidden="true"></i>
            <span>Coverage Navigator</span>
          </div>
        </div>

        <div class="nav-hero-body">
          <label for="area-select" class="nav-hero-label">
            <span class="label-text">Coverage Area</span>
          </label>
          <div class="area-select-wrapper">
            <select id="area-select" class="area-select">
              <option value="">Select a coverage area...</option>
            </select>
            <i class="fas fa-chevron-down select-chevron" aria-hidden="true"></i>
          </div>

          <!-- Coverage Stats (shown when area selected) -->
          <div id="area-stats" class="hero-stats" hidden>
            <div class="hero-stat hero-stat--primary">
              <div class="hero-stat-ring">
                <svg viewBox="0 0 36 36" class="progress-ring">
                  <path class="progress-ring-bg"
                        d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                  <path class="progress-ring-fill"
                        id="coverage-ring-fill"
                        stroke-dasharray="0, 100"
                        d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                </svg>
                <span class="hero-stat-value" id="area-coverage" data-coverage-percent>0%</span>
              </div>
              <span class="hero-stat-label">Coverage</span>
            </div>
            <div class="hero-stat">
              <span class="hero-stat-value" id="area-remaining" data-value-flash>--</span>
              <span class="hero-stat-label">Remaining</span>
            </div>
            <div class="hero-stat">
              <span class="hero-stat-value" id="area-total">--</span>
              <span class="hero-stat-label">Total</span>
            </div>
          </div>

          <!-- Primary Action -->
          <button id="generate-route-btn" class="nav-hero-action" disabled>
            <span class="action-icon">
              <i class="fas fa-wand-magic-sparkles" aria-hidden="true"></i>
            </span>
            <span class="action-content">
              <span class="action-title">Generate Optimal Route</span>
              <span class="action-subtitle">Minimize deadhead driving with RPP algorithm</span>
            </span>
          </button>
        </div>
      </section>

      <!-- Route Generation Progress (inline, shown during processing) -->
      <section class="nav-progress" id="route-progress" hidden>
        <div class="nav-progress-header">
          <div class="progress-title">
            <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
            <span>Generating Route</span>
          </div>
          <span class="progress-stage" id="progress-stage">Initializing...</span>
        </div>

        <div class="nav-progress-steps">
          <div class="progress-step" data-step="1" id="step-clustering">
            <div class="step-dot"></div>
            <span class="step-label">Cluster</span>
          </div>
          <div class="progress-step" data-step="2" id="step-optimizing">
            <div class="step-dot"></div>
            <span class="step-label">Optimize</span>
          </div>
          <div class="progress-step" data-step="3" id="step-rendering">
            <div class="step-dot"></div>
            <span class="step-label">Render</span>
          </div>
        </div>

        <div class="nav-progress-bar">
          <div class="progress-track">
            <div class="progress-fill" id="route-progress-fill" style="width: 0%"></div>
          </div>
          <span class="progress-percent" id="route-progress-percent">0%</span>
        </div>

        <div class="nav-progress-detail">
          <span class="progress-message" id="progress-message">Preparing...</span>
          <span class="progress-elapsed" id="progress-elapsed">
            <i class="fas fa-clock" aria-hidden="true"></i>
            <span id="elapsed-value">0:00</span>
          </span>
        </div>

        <button type="button" class="nav-progress-cancel" id="cancel-task-btn">
          <i class="fas fa-times" aria-hidden="true"></i>
          Cancel
        </button>
      </section>

      <!-- Live Solver Progress (for advanced processing) -->
      <section class="nav-live" id="progress-section" hidden>
        <div class="nav-live-header">
          <div class="live-indicator">
            <span class="live-dot"></span>
            <span class="live-label">Route Solver</span>
          </div>
          <span class="live-badge">LIVE</span>
        </div>

        <p class="nav-live-description">
          Mapping, connecting, and plotting the circuit in real time.
        </p>

        <div class="nav-live-stages">
          <div class="live-stage" data-stages="queued,waiting,initializing">
            <i class="fas fa-play" aria-hidden="true"></i>
            <span>Start</span>
          </div>
          <div class="live-stage" data-stages="loading_area,loading_segments,loading_graph,fetching_osm">
            <i class="fas fa-database" aria-hidden="true"></i>
            <span>Load</span>
          </div>
          <div class="live-stage" data-stages="mapping_segments">
            <i class="fas fa-project-diagram" aria-hidden="true"></i>
            <span>Map</span>
          </div>
          <div class="live-stage" data-stages="connectivity_check">
            <i class="fas fa-network-wired" aria-hidden="true"></i>
            <span>Link</span>
          </div>
          <div class="live-stage" data-stages="routing">
            <i class="fas fa-route" aria-hidden="true"></i>
            <span>Route</span>
          </div>
          <div class="live-stage" data-stages="finalizing,complete">
            <i class="fas fa-check" aria-hidden="true"></i>
            <span>Done</span>
          </div>
        </div>

        <div class="nav-live-bar">
          <div class="progress-track">
            <div class="progress-fill progress-fill--animated" id="progress-bar" style="width: 0%"></div>
          </div>
        </div>

        <div class="nav-live-messages">
          <div class="live-message-primary" id="progress-message-primary">Initializing...</div>
          <div class="live-message-secondary" id="progress-message-secondary"></div>
        </div>

        <div class="nav-live-elapsed">
          <i class="fas fa-clock" aria-hidden="true"></i>
          Elapsed: <span id="elapsed-value-live">0:00</span>
        </div>

        <button type="button" class="nav-progress-cancel" id="cancel-live-btn">
          <i class="fas fa-times" aria-hidden="true"></i>
          Cancel Task
        </button>
      </section>

      <!-- Error State -->
      <section class="nav-error" id="error-section" hidden>
        <div class="nav-error-icon">
          <i class="fas fa-triangle-exclamation" aria-hidden="true"></i>
        </div>
        <div class="nav-error-title">Issue Detected</div>
        <div class="nav-error-message" id="error-message">An error occurred.</div>
        <button type="button" class="nav-error-retry" id="retry-btn">
          <i class="fas fa-redo" aria-hidden="true"></i>
          Try Again
        </button>
      </section>

      <!-- Route History Section -->
      <section class="nav-section" id="route-history-section" data-section="history">
        <button type="button"
                class="nav-section-header"
                aria-expanded="true"
                aria-controls="section-history-content">
          <div class="section-header-left">
            <i class="fas fa-history" aria-hidden="true"></i>
            <span class="section-title">Route History</span>
          </div>
          <i class="fas fa-chevron-down section-chevron" aria-hidden="true"></i>
        </button>
        <div class="nav-section-content" id="section-history-content">
          <!-- Active Mission -->
          <div class="history-group">
            <div class="history-group-label">Active Mission</div>
            <div id="active-mission-card" class="history-list">
              <div class="history-empty">
                <i class="fas fa-flag-checkered" aria-hidden="true"></i>
                <span>No active mission</span>
              </div>
            </div>
          </div>

          <!-- Mission History -->
          <div class="history-group">
            <div class="history-group-label">Recent Missions</div>
            <div id="mission-history" class="history-list">
              <div class="history-empty">
                <i class="fas fa-list-check" aria-hidden="true"></i>
                <span>No mission history yet</span>
              </div>
            </div>
          </div>

          <!-- Saved Routes -->
          <div class="history-group">
            <div class="history-group-label">Saved Routes</div>
            <div id="route-history" class="history-list">
              <div class="history-empty">
                <i class="fas fa-route" aria-hidden="true"></i>
                <span>No saved routes yet</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Navigation Tools Section -->
      <section class="nav-section" id="nav-tools-section" data-section="navigate" hidden>
        <button type="button"
                class="nav-section-header"
                aria-expanded="true"
                aria-controls="section-navigate-content">
          <div class="section-header-left">
            <i class="fas fa-compass" aria-hidden="true"></i>
            <span class="section-title">Navigation Tools</span>
          </div>
          <i class="fas fa-chevron-down section-chevron" aria-hidden="true"></i>
        </button>
        <div class="nav-section-content" id="section-navigate-content">
          <div class="nav-tools-grid">
            <button id="find-next-street-btn" class="nav-tool-btn" disabled>
              <span class="tool-icon">
                <i class="fas fa-route" aria-hidden="true"></i>
              </span>
              <span class="tool-content">
                <span class="tool-title">Find Nearest Street</span>
                <span class="tool-subtitle">Navigate to closest undriven road</span>
              </span>
            </button>
            <button id="find-efficient-street-btn" class="nav-tool-btn nav-tool-btn--secondary" disabled>
              <span class="tool-icon">
                <i class="fas fa-layer-group" aria-hidden="true"></i>
              </span>
              <span class="tool-content">
                <span class="tool-title">Find Clusters</span>
                <span class="tool-subtitle">Discover efficient route groups</span>
              </span>
            </button>
          </div>

          <div id="status-message" class="nav-status-message info">
            <i class="fas fa-info-circle" aria-hidden="true"></i>
            <span>Select a coverage area to begin navigation</span>
          </div>

          <div id="target-info" class="nav-target-info"></div>

          <div id="route-info" class="nav-route-info">
            <div class="route-info-header">
              <i class="fas fa-route" aria-hidden="true"></i>
              <span>Active Guidance</span>
            </div>
            <div id="route-details-content" class="route-info-content"></div>
            <div class="route-info-actions">
              <button id="open-google-maps-btn" class="route-map-btn" disabled>
                <i class="fab fa-google" aria-hidden="true"></i>
                Google Maps
              </button>
              <button id="open-apple-maps-btn" class="route-map-btn" disabled>
                <i class="fab fa-apple" aria-hidden="true"></i>
                Apple Maps
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Results Section (shown after route generation) -->
      <section class="nav-results" id="results-section" hidden>
        <div class="nav-results-header">
          <div class="results-title">
            <i class="fas fa-chart-bar" aria-hidden="true"></i>
            <span>Route Statistics</span>
          </div>
          <button type="button"
                  class="nav-section-toggle"
                  id="toggle-results"
                  aria-expanded="true"
                  aria-controls="results-content">
            <i class="fas fa-chevron-up" aria-hidden="true"></i>
          </button>
        </div>

        <div class="nav-results-content" id="results-content">
          <div class="results-stats">
            <div class="result-stat" data-stat="total">
              <div class="result-stat-icon">
                <i class="fas fa-road" aria-hidden="true"></i>
              </div>
              <div class="result-stat-content">
                <span class="result-stat-value" id="stat-total-distance">--</span>
                <span class="result-stat-label">Total Route</span>
              </div>
            </div>
            <div class="result-stat" data-stat="required">
              <div class="result-stat-icon result-stat-icon--success">
                <i class="fas fa-check-circle" aria-hidden="true"></i>
              </div>
              <div class="result-stat-content">
                <span class="result-stat-value" id="stat-required-distance">--</span>
                <span class="result-stat-label">Required</span>
              </div>
            </div>
            <div class="result-stat" data-stat="coverage">
              <div class="result-stat-icon result-stat-icon--primary">
                <i class="fas fa-map-marked-alt" aria-hidden="true"></i>
              </div>
              <div class="result-stat-content">
                <span class="result-stat-value" id="stat-covered-distance">--</span>
                <span class="result-stat-label">Coverage</span>
              </div>
            </div>
            <div class="result-stat" data-stat="deadhead">
              <div class="result-stat-icon result-stat-icon--warning">
                <i class="fas fa-car-side" aria-hidden="true"></i>
              </div>
              <div class="result-stat-content">
                <span class="result-stat-value" id="stat-deadhead-distance">--</span>
                <span class="result-stat-label">Deadhead</span>
              </div>
            </div>
            <div class="result-stat result-stat--efficiency" data-stat="efficiency">
              <div class="result-stat-icon result-stat-icon--success">
                <i class="fas fa-percentage" aria-hidden="true"></i>
              </div>
              <div class="result-stat-content">
                <span class="result-stat-value" id="stat-deadhead-percent">--</span>
                <span class="result-stat-label">Efficiency</span>
              </div>
            </div>
          </div>

          <!-- Export & Actions -->
          <div class="results-actions">
            <button id="export-gpx-btn" class="results-action-btn">
              <i class="fas fa-download" aria-hidden="true"></i>
              <span>Export GPX</span>
            </button>
            <button id="replay-animation-btn" class="results-action-btn" disabled>
              <i class="fas fa-redo" aria-hidden="true"></i>
              <span>Replay</span>
            </button>
            <button id="start-turn-by-turn-btn" class="results-action-btn results-action-btn--primary" disabled>
              <i class="fas fa-location-arrow" aria-hidden="true"></i>
              <span>Navigate</span>
            </button>
            <button id="clear-route-btn" class="results-action-btn results-action-btn--secondary">
              <i class="fas fa-times" aria-hidden="true"></i>
              <span>Clear</span>
            </button>
          </div>

          <!-- Layer Controls -->
          <div class="results-layers">
            <div class="layers-title">Map Layers</div>
            <div class="layers-list" id="layer-list">
              <div class="layer-item" data-layer-id="route">
                <div class="layer-main">
                  <span class="layer-color layer-color--route"></span>
                  <span class="layer-name">Optimal Route</span>
                  <div class="layer-controls">
                    <button type="button"
                            class="layer-toggle active"
                            id="toggle-route-layer"
                            aria-pressed="true"
                            aria-label="Toggle route layer">
                      <i class="fas fa-eye" aria-hidden="true"></i>
                    </button>
                  </div>
                </div>
                <div class="layer-opacity">
                  <input type="range"
                         class="opacity-slider"
                         id="opacity-route-layer"
                         min="0"
                         max="100"
                         value="100"
                         aria-label="Route opacity" />
                  <span class="opacity-value">100%</span>
                </div>
              </div>

              <div class="layer-item" data-layer-id="driven">
                <div class="layer-main">
                  <span class="layer-color layer-color--driven"></span>
                  <span class="layer-name">Driven Streets</span>
                  <div class="layer-controls">
                    <button type="button"
                            class="layer-toggle active"
                            id="toggle-driven-layer"
                            aria-pressed="true"
                            aria-label="Toggle driven layer">
                      <i class="fas fa-eye" aria-hidden="true"></i>
                    </button>
                  </div>
                </div>
                <div class="layer-opacity">
                  <input type="range"
                         class="opacity-slider"
                         id="opacity-driven-layer"
                         min="0"
                         max="100"
                         value="60"
                         aria-label="Driven streets opacity" />
                  <span class="opacity-value">60%</span>
                </div>
              </div>

              <div class="layer-item" data-layer-id="undriven">
                <div class="layer-main">
                  <span class="layer-color layer-color--undriven"></span>
                  <span class="layer-name">Undriven Streets</span>
                  <div class="layer-controls">
                    <button type="button"
                            class="layer-toggle active"
                            id="toggle-undriven-layer"
                            aria-pressed="true"
                            aria-label="Toggle undriven layer">
                      <i class="fas fa-eye" aria-hidden="true"></i>
                    </button>
                  </div>
                </div>
                <div class="layer-opacity">
                  <input type="range"
                         class="opacity-slider"
                         id="opacity-undriven-layer"
                         min="0"
                         max="100"
                         value="80"
                         aria-label="Undriven streets opacity" />
                  <span class="opacity-value">80%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Route Details Section -->
      <section class="nav-section nav-section--details" id="route-details" hidden>
        <button type="button"
                class="nav-section-header"
                aria-expanded="true"
                aria-controls="section-details-content">
          <div class="section-header-left">
            <i class="fas fa-list-ul" aria-hidden="true"></i>
            <span class="section-title">Route Details</span>
          </div>
          <i class="fas fa-chevron-down section-chevron" aria-hidden="true"></i>
        </button>
        <div class="nav-section-content" id="section-details-content">
          <div id="route-stats" class="route-stats-grid"></div>
        </div>
      </section>
    </aside>

    <!-- Map Container -->
    <div class="map-container">
      <div id="coverage-map"></div>

      <!-- Map Scanner Overlay -->
      <div id="map-scanner-overlay" class="map-scanner-overlay" aria-hidden="true"></div>

      <!-- Route Solver HUD -->
      <div id="route-solver-hud" class="route-solver-hud" aria-live="polite" hidden>
        <div class="hud-panel">
          <div class="hud-header">
            <div class="hud-signal">
              <span class="hud-dot"></span>
              <span class="hud-title">Route Solver</span>
            </div>
            <div id="hud-stage" class="hud-stage">Initializing</div>
          </div>
          <div id="hud-message" class="hud-message">Initializing...</div>
          <div id="hud-submessage" class="hud-submessage"></div>
          <div class="hud-metrics">
            <div class="hud-metric">
              <span class="metric-label">Segments</span>
              <span id="hud-segments" class="metric-value">--</span>
            </div>
            <div class="hud-metric">
              <span class="metric-label">Matched</span>
              <span id="hud-matched" class="metric-value">--</span>
            </div>
            <div class="hud-metric">
              <span class="metric-label">Default</span>
              <span id="hud-default" class="metric-value">--</span>
            </div>
            <div class="hud-metric">
              <span class="metric-label">Elapsed</span>
              <span id="hud-elapsed" class="metric-value">0:00</span>
            </div>
          </div>
          <div id="hud-activity" class="hud-activity"></div>
        </div>
      </div>

      <!-- Map Legend -->
      <div class="map-legend" id="map-legend" hidden>
        <div class="legend-title">Legend</div>
        <div class="legend-items">
          <div class="legend-item">
            <span class="legend-color legend-color--driven"></span>
            <span class="legend-label">Driven Streets</span>
          </div>
          <div class="legend-item">
            <span class="legend-color legend-color--undriven"></span>
            <span class="legend-label">Undriven Streets</span>
          </div>
          <div class="legend-item">
            <span class="legend-color legend-color--route"></span>
            <span class="legend-label">Optimal Route</span>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
