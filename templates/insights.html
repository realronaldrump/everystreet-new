{% extends "base.html" %}

{% block title %}

Driving Insights
{% endblock %}


{% block extra_css %}

  <link rel="stylesheet"
        href="{{ url_for('static', path='css/insights.css') | replace('http://', '//') }}?v={{ repo_version.commit_count }}" />

{% endblock %}


{% block content %}

  <div id="insights-page" class="insights-container">
    <!-- Hero Section -->
    <section class="insights-hero" data-accent="lime">
      <div class="hero-content">
        <div class="hero-badge">
          <i class="fas fa-chart-line"></i>
          <span>Your driving insights</span>
        </div>
        <h1 class="hero-title">
          Your driving patterns,
          <br />
          <span class="highlight">broken down by data</span>
        </h1>
        <p class="hero-subtitle">
          Use period comparisons, time distributions, and destination concentration to inspect exactly what changed in your selected range.
        </p>
        <div class="hero-stat-card">
          <div class="hero-stat-value counter" id="hero-total-miles">
0
          </div>
          <div class="hero-stat-label">
miles in the selected range
          </div>
        </div>
      </div>
    </section>

    <!-- Quick Stats Section -->
    <section class="insights-section" data-accent="mint">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-star section-icon"></i>
            At a glance
        </h2>
        <p class="section-subtitle">
Headline metrics with contextual cues from your latest patterns
        </p>
      </div>

      <div class="metrics-grid">
        <div class="metric-card" data-widget-id="trips">
          <div class="metric-accent mint"></div>
          <div class="metric-content">
            <div class="metric-icon">
              <i class="fas fa-route"></i>
            </div>
            <div class="metric-value counter" id="total-trips">
0
            </div>
            <button type="button"
                    class="metric-label insights-drilldown-trigger"
                    data-drilldown="trips">
trips taken
            </button>
            <div class="metric-context">
              <i class="fas fa-info-circle"></i>
              <span id="trips-context">Not enough trips in this range for derived ratios yet.</span>
            </div>
          </div>
        </div>

        <div class="metric-card" data-widget-id="distance">
          <div class="metric-accent coral"></div>
          <div class="metric-content">
            <div class="metric-icon">
              <i class="fas fa-road"></i>
            </div>
            <div class="metric-value">
              <span class="counter" id="total-distance">0</span>
              <span class="metric-unit">mi</span>
            </div>
            <button type="button"
                    class="metric-label insights-drilldown-trigger"
                    data-drilldown="distance">
total distance
            </button>
            <div class="metric-context">
              <i class="fas fa-wave-square"></i>
              <span id="distance-context">Add more trips to improve long-range comparison detail.</span>
            </div>
          </div>
        </div>

        <div class="metric-card" data-widget-id="time">
          <div class="metric-accent sky"></div>
          <div class="metric-content">
            <div class="metric-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="metric-value" id="total-time">
0h 0m
            </div>
            <button type="button"
                    class="metric-label insights-drilldown-trigger"
                    data-drilldown="duration">
time driving
            </button>
            <div class="metric-context">
              <i class="fas fa-hourglass-half"></i>
              <span id="time-context">Signature windows appear once time clusters emerge.</span>
            </div>
          </div>
        </div>

        <div class="metric-card" data-widget-id="fuel">
          <div class="metric-accent purple"></div>
          <div class="metric-content">
            <div class="metric-icon">
              <i class="fas fa-gas-pump"></i>
            </div>
            <div class="metric-value">
              <span class="counter" id="total-fuel">0</span>
              <span class="metric-unit">gal</span>
            </div>
            <button type="button"
                    class="metric-label insights-drilldown-trigger"
                    data-drilldown="fuel">
fuel context
            </button>
            <div class="metric-context">
              <i class="fas fa-leaf"></i>
              <span id="fuel-context">Fuel context appears when fuel entries are available.</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Period Analytics Section -->
    <section class="insights-section story-shell" data-accent="purple">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-wave-square section-icon"></i>
            Period analytics
        </h2>
        <p class="section-subtitle">
Compare daily, weekly, and monthly totals with direct links to underlying trips
        </p>
      </div>

      <div class="story-grid">
        <article class="chart-card chart-large">
          <div class="chart-header">
            <h3 class="chart-title">
              <button type="button"
                      class="insights-drilldown-trigger insights-title-button"
                      data-drilldown="trips">
Movement over time
              </button>
            </h3>
            <div class="chart-controls">
              <div class="toggle-group" aria-label="Trend resolution">
                <button class="toggle-btn active" data-view="daily" aria-pressed="true">
Daily
                </button>
                <button class="toggle-btn" data-view="weekly" aria-pressed="false">
Weekly
                </button>
                <button class="toggle-btn" data-view="monthly" aria-pressed="false">
Monthly
                </button>
              </div>
            </div>
          </div>
          <div class="chart-body">
            <div class="chart-loading" id="trends-loading">
              <div class="chart-loading-spinner"></div>
            </div>
            <canvas id="trendsChart" style="display: none"></canvas>
          </div>
          <div class="story-narrative" id="trends-narrative">
            Comparison facts will appear after a few periods in this range.
          </div>
        </article>

        <article class="rhythm-panel">
          <div class="rhythm-header">
            <h3>Period comparison</h3>
            <div class="toggle-group" id="rhythm-period-toggle" aria-label="Comparison period">
              <button class="toggle-btn active" data-rhythm-view="weekly" aria-pressed="true">
Weekly
              </button>
              <button class="toggle-btn" data-rhythm-view="monthly" aria-pressed="false">
Monthly
              </button>
            </div>
          </div>
          <div class="rhythm-storyrail" id="rhythm-storyrail" role="list">
            <div class="story-empty">Not enough data in this range to compare periods yet.</div>
          </div>
        </article>
      </div>
    </section>

    <!-- Pattern Cards Section -->
    <section class="insights-section" data-accent="amber">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-lightbulb section-icon"></i>
            Pattern cards
        </h2>
        <p class="section-subtitle">
Data-driven summaries with one-click drilldowns
        </p>
      </div>

      <div class="scene-chips" aria-hidden="true">
        <span id="scene-streak-value">0 day streak</span>
        <span id="scene-exploration-value">0.0% top-3 concentration</span>
        <span id="scene-signature-value">Daytime rhythm</span>
        <span id="scene-active-ratio-value">0.0% active-day ratio</span>
      </div>

      <div class="insight-scenes-grid" id="insight-scenes">
        <div class="story-empty">Not enough data in this range to compute pattern cards yet.</div>
      </div>
    </section>

    <!-- Time Signature Section -->
    <section class="insights-section" data-accent="sky">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-clock section-icon"></i>
            Time signature
        </h2>
        <p class="section-subtitle">
See when your starts cluster and how weekday rhythm shifts
        </p>
      </div>

      <div class="time-signature-layout">
        <div class="chart-card">
          <div class="chart-header">
            <div class="toggle-group" aria-label="Time distribution granularity">
              <button class="toggle-btn active" data-time="hour" aria-pressed="true">
By Hour
              </button>
              <button class="toggle-btn" data-time="day" aria-pressed="false">
By Day
              </button>
            </div>
          </div>
          <div class="chart-body compact">
            <canvas id="timeDistChart"></canvas>
          </div>
        </div>

        <aside class="time-signature-panel" id="time-signature">
          <div class="story-empty">Not enough time-distribution data in this range yet.</div>
        </aside>
      </div>
    </section>

    <!-- Places Orbit Section -->
    <section class="insights-section" data-accent="mint">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-map-marker-alt section-icon"></i>
            Places orbit
        </h2>
        <p class="section-subtitle">
Your places arranged by frequency, distance, and recency
        </p>
      </div>

      <div class="places-layout">
        <div class="places-orbit" id="places-orbit" role="group" aria-label="Destination orbit">
          <div class="story-empty">No destination clusters in this date range.</div>
        </div>
        <aside class="places-detail-panel" id="places-detail-panel">
          <div class="places-detail-empty">
            <p>Select a place bubble to see details.</p>
          </div>
        </aside>
      </div>
    </section>

    <!-- Street & Segment Movement Section -->
    <section class="insights-section" data-accent="lime">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-grip-lines section-icon"></i>
            Most driven streets and segments
        </h2>
        <p class="section-subtitle">
Built automatically from your trip geometry using H3 segment aggregation
        </p>
      </div>

      <div class="movement-layout">
        <article class="movement-map-card">
          <header class="movement-map-header">
            <div class="movement-meta-strip">
              <span class="movement-meta-pill" id="movement-trip-count">0 trips analyzed</span>
              <span class="movement-meta-pill" id="movement-hex-count">0 active H3 cells</span>
              <span class="movement-meta-pill" id="movement-sync-state">Auto-sync active</span>
            </div>
            <div class="toggle-group movement-toggle-group" id="movement-layer-toggle">
              <button class="toggle-btn active"
                      type="button"
                      data-movement-layer="both"
                      aria-pressed="true">
Cells + Segments
              </button>
              <button class="toggle-btn"
                      type="button"
                      data-movement-layer="cells"
                      aria-pressed="false">
Cells
              </button>
              <button class="toggle-btn"
                      type="button"
                      data-movement-layer="segments"
                      aria-pressed="false">
Segments
              </button>
            </div>
          </header>
          <div class="movement-map-shell">
            <div id="movement-map" role="img" aria-label="Most driven streets and segments map"></div>
            <div class="movement-map-empty story-empty" id="movement-map-empty">
              Not enough trip geometry in this range yet.
            </div>
          </div>
        </article>

        <aside class="movement-rankings">
          <section class="movement-rank-card">
            <h3 class="movement-rank-title">Top streets</h3>
            <ol class="movement-rank-list" id="movement-top-streets">
              <li class="story-empty">No streets resolved yet for this range.</li>
            </ol>
          </section>
          <section class="movement-rank-card">
            <h3 class="movement-rank-title">Top segments</h3>
            <ol class="movement-rank-list" id="movement-top-segments">
              <li class="story-empty">No segment traversals in this range yet.</li>
            </ol>
          </section>
        </aside>
      </div>
    </section>

    <!-- Records Timeline Section -->
    <section class="insights-section" data-accent="coral">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-flag-checkered section-icon"></i>
            Record timeline
        </h2>
        <p class="section-subtitle">
Milestones from your selected range, presented as quick timeline cards
        </p>
      </div>

      <div class="records-timeline" id="records-timeline">
        <div class="story-empty">No record-level outliers in this range yet.</div>
      </div>
    </section>
  </div>

  <!-- Floating Action Button -->
  <div class="fab-container">
    <div class="fab-menu" id="fab-menu">
      <button class="fab mini-fab" title="Refresh Data" id="refresh-data">
        <i class="fas fa-sync"></i>
      </button>
      <button class="fab mini-fab" title="Download Report" id="download-report">
        <i class="fas fa-file-pdf"></i>
      </button>
      <button class="fab mini-fab" title="Share Insights" id="share-insights">
        <i class="fas fa-share-alt"></i>
      </button>
    </div>
    <button class="fab" id="fab-main">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <!-- Custom tooltip -->
  <div class="custom-tooltip" id="custom-tooltip"></div>

  <!-- Trip Details Modal -->
  <div class="modal fade"
       id="tripDetailsModal"
       tabindex="-1"
       aria-labelledby="tripDetailsModalLabel"
       aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="tripDetailsModalLabel">Trips</h5>
            <p class="modal-subtitle" id="tripDetailsModalCount">0 trips</p>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="modal-trips-grid" id="modal-trips-grid">
            <div class="modal-trip-empty">No trips found for this drilldown.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
Close
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{# Page scripts are loaded via route-loader + swup. #}
