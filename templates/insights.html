{% extends "base.html" %}

{% block title %}

Your Driving Story
{% endblock %}


{% block extra_css %}

  <link rel="stylesheet"
        href="{{ url_for('static', path='css/insights.css') | replace('http://', '//') }}?v={{ repo_version.commit_count }}" />

{% endblock %}


{% block content %}

  <div id="insights-page" class="insights-container">
    <!-- Hero Section -->
    <section class="insights-hero" data-accent="lime">
      <div class="hero-content">
        <div class="hero-badge">
          <i class="fas fa-chart-line"></i>
          <span>Your driving story</span>
        </div>
        <h1 class="hero-title">
          Your movement patterns,
          <br />
          <span class="highlight">told like a story</span>
        </h1>
        <p class="hero-subtitle">
          This page turns your trips into narrative scenes, rhythm cards, and place clusters so you can understand what changed and what stayed consistent.
        </p>
        <div class="hero-stat-card">
          <div class="hero-stat-value counter" id="hero-total-miles">
0
          </div>
          <div class="hero-stat-label">
miles in the selected range
          </div>
        </div>
      </div>
    </section>

    <!-- Quick Stats Section -->
    <section class="insights-section" data-accent="mint">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-star section-icon"></i>
            At a glance
        </h2>
        <p class="section-subtitle">
Headline metrics with contextual cues from your latest patterns
        </p>
      </div>

      <div class="metrics-grid">
        <div class="metric-card" data-widget-id="trips">
          <div class="metric-accent mint"></div>
          <div class="metric-content">
            <div class="metric-icon">
              <i class="fas fa-route"></i>
            </div>
            <div class="metric-value counter" id="total-trips">
0
            </div>
            <button type="button"
                    class="metric-label insights-drilldown-trigger"
                    data-drilldown="trips">
trips taken
            </button>
            <div class="metric-context">
              <i class="fas fa-info-circle"></i>
              <span id="trips-context">Patterns will appear as your trip history grows.</span>
            </div>
          </div>
        </div>

        <div class="metric-card" data-widget-id="distance">
          <div class="metric-accent coral"></div>
          <div class="metric-content">
            <div class="metric-icon">
              <i class="fas fa-road"></i>
            </div>
            <div class="metric-value">
              <span class="counter" id="total-distance">0</span>
              <span class="metric-unit">mi</span>
            </div>
            <button type="button"
                    class="metric-label insights-drilldown-trigger"
                    data-drilldown="distance">
total distance
            </button>
            <div class="metric-context">
              <i class="fas fa-wave-square"></i>
              <span id="distance-context">Long-form distance stories need more data.</span>
            </div>
          </div>
        </div>

        <div class="metric-card" data-widget-id="time">
          <div class="metric-accent sky"></div>
          <div class="metric-content">
            <div class="metric-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="metric-value" id="total-time">
0h 0m
            </div>
            <button type="button"
                    class="metric-label insights-drilldown-trigger"
                    data-drilldown="duration">
time driving
            </button>
            <div class="metric-context">
              <i class="fas fa-hourglass-half"></i>
              <span id="time-context">Signature windows appear once time clusters emerge.</span>
            </div>
          </div>
        </div>

        <div class="metric-card" data-widget-id="fuel">
          <div class="metric-accent purple"></div>
          <div class="metric-content">
            <div class="metric-icon">
              <i class="fas fa-gas-pump"></i>
            </div>
            <div class="metric-value">
              <span class="counter" id="total-fuel">0</span>
              <span class="metric-unit">gal</span>
            </div>
            <button type="button"
                    class="metric-label insights-drilldown-trigger"
                    data-drilldown="fuel">
fuel context
            </button>
            <div class="metric-context">
              <i class="fas fa-leaf"></i>
              <span id="fuel-context">Fuel context appears when fuel entries are available.</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Journey + Rhythm Section -->
    <section class="insights-section story-shell" data-accent="purple">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-wave-square section-icon"></i>
            Journey rhythm
        </h2>
        <p class="section-subtitle">
Track daily movement and compare weekly/monthly momentum in narrative cards
        </p>
      </div>

      <div class="story-grid">
        <article class="chart-card chart-large">
          <div class="chart-header">
            <h3 class="chart-title">
              <button type="button"
                      class="insights-drilldown-trigger insights-title-button"
                      data-drilldown="trips">
Movement over time
              </button>
            </h3>
            <div class="chart-controls">
              <div class="toggle-group" aria-label="Trend resolution">
                <button class="toggle-btn active" data-view="daily" aria-pressed="true">
Daily
                </button>
                <button class="toggle-btn" data-view="weekly" aria-pressed="false">
Weekly
                </button>
                <button class="toggle-btn" data-view="monthly" aria-pressed="false">
Monthly
                </button>
              </div>
            </div>
          </div>
          <div class="chart-body">
            <div class="chart-loading" id="trends-loading">
              <div class="chart-loading-spinner"></div>
            </div>
            <canvas id="trendsChart" style="display: none"></canvas>
          </div>
          <div class="story-narrative" id="trends-narrative">
            Narrative summary will appear after a few trips in this range.
          </div>
        </article>

        <article class="rhythm-panel">
          <div class="rhythm-header">
            <h3>Journey Rhythm Storyrail</h3>
            <div class="toggle-group" id="rhythm-period-toggle" aria-label="Rhythm period">
              <button class="toggle-btn active" data-rhythm-view="weekly" aria-pressed="true">
Weekly
              </button>
              <button class="toggle-btn" data-rhythm-view="monthly" aria-pressed="false">
Monthly
              </button>
            </div>
          </div>
          <div class="rhythm-storyrail" id="rhythm-storyrail" role="list">
            <div class="story-empty">Not enough trip history yet to build period stories.</div>
          </div>
        </article>
      </div>
    </section>

    <!-- Insight Scenes Section -->
    <section class="insights-section" data-accent="amber">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-lightbulb section-icon"></i>
            Insight scenes
        </h2>
        <p class="section-subtitle">
A narrative readout of consistency, timing, exploration, and fuel context
        </p>
      </div>

      <div class="scene-chips" aria-hidden="true">
        <span id="scene-streak-value">0 day streak</span>
        <span id="scene-exploration-value">0 exploration score</span>
        <span id="scene-signature-value">Daytime rhythm</span>
        <span id="scene-active-ratio-value">0.0% active-day ratio</span>
      </div>

      <div class="insight-scenes-grid" id="insight-scenes">
        <div class="story-empty">No scenes yet. Drive a bit more to unlock insights.</div>
      </div>
    </section>

    <!-- Time Signature Section -->
    <section class="insights-section" data-accent="sky">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-clock section-icon"></i>
            Time signature
        </h2>
        <p class="section-subtitle">
See when your starts cluster and how weekday rhythm shifts
        </p>
      </div>

      <div class="time-signature-layout">
        <div class="chart-card">
          <div class="chart-header">
            <div class="toggle-group" aria-label="Time distribution granularity">
              <button class="toggle-btn active" data-time="hour" aria-pressed="true">
By Hour
              </button>
              <button class="toggle-btn" data-time="day" aria-pressed="false">
By Day
              </button>
            </div>
          </div>
          <div class="chart-body compact">
            <canvas id="timeDistChart"></canvas>
          </div>
        </div>

        <aside class="time-signature-panel" id="time-signature">
          <div class="story-empty">Time signature is building...</div>
        </aside>
      </div>
    </section>

    <!-- Places Orbit Section -->
    <section class="insights-section" data-accent="mint">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-map-marker-alt section-icon"></i>
            Places orbit
        </h2>
        <p class="section-subtitle">
Your places arranged by frequency, distance, and recency
        </p>
      </div>

      <div class="places-layout">
        <div class="places-orbit" id="places-orbit" role="group" aria-label="Destination orbit">
          <div class="story-empty">No destination clusters in this date range.</div>
        </div>
        <aside class="places-detail-panel" id="places-detail-panel">
          <div class="places-detail-empty">
            <p>Select a place bubble to see details.</p>
          </div>
        </aside>
      </div>
    </section>

    <!-- Records Timeline Section -->
    <section class="insights-section" data-accent="coral">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-flag-checkered section-icon"></i>
            Record timeline
        </h2>
        <p class="section-subtitle">
Milestones from your selected range, presented as quick timeline cards
        </p>
      </div>

      <div class="records-timeline" id="records-timeline">
        <div class="story-empty">No record highlights for this range yet.</div>
      </div>
    </section>
  </div>

  <!-- Floating Action Button -->
  <div class="fab-container">
    <div class="fab-menu" id="fab-menu">
      <button class="fab mini-fab" title="Refresh Data" id="refresh-data">
        <i class="fas fa-sync"></i>
      </button>
      <button class="fab mini-fab" title="Download Report" id="download-report">
        <i class="fas fa-file-pdf"></i>
      </button>
      <button class="fab mini-fab" title="Share Insights" id="share-insights">
        <i class="fas fa-share-alt"></i>
      </button>
    </div>
    <button class="fab" id="fab-main">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <!-- Custom tooltip -->
  <div class="custom-tooltip" id="custom-tooltip"></div>

  <!-- Trip Details Modal -->
  <div class="modal fade"
       id="tripDetailsModal"
       tabindex="-1"
       aria-labelledby="tripDetailsModalLabel"
       aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="tripDetailsModalLabel">
Trips
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped" id="modal-trips-table">
              <thead>
                <tr>
                  <th>
Start Time
                  </th>
                  <th>
End Time
                  </th>
                  <th>
Duration
                  </th>
                  <th>
Distance
                  </th>
                  <th>
Start Location
                  </th>
                  <th>
Destination
                  </th>
                  <th>
Max Speed
                  </th>
                  <th>
Insight
                  </th>
                  <th>
Actions
                  </th>
                </tr>
              </thead>
              <tbody>
                <!-- Dynamic content -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
Close
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{# Page scripts are loaded via route-loader + swup. #}
