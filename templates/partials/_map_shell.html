<div class="map-wrapper d-flex flex-column flex-grow-1" data-es-shell-id="map-shell">
  <h1 id="map-page-title" class="visually-hidden">
Map
  </h1>
  <!-- Map Container -->
  <div id="map"
       class="flex-grow-1 position-relative"
       role="application"
       aria-label="Interactive map">
    <div id="map-canvas" class="map-canvas">
    </div>
    <!-- Loading indicator -->
    <div id="map-loading-indicator" class="map-loading d-none">
      <div class="loading-spinner">
      </div>
      <span class="map-loading-text">Loading map...</span>
    </div>

    <!-- Trip Statistics Widget (Top Left) -->
    <div id="trip-stats-widget" class="trip-stats-widget" aria-label="Trip statistics">
      <div class="trip-stats-card" id="trip-stats-card">
        <!-- Compact View -->
        <div class="trip-stats-compact" id="trip-stats-compact">
          <div class="trip-stats-header">
            <div class="trip-stats-icon">
              <i class="fas fa-chart-bar" aria-hidden="true"></i>
            </div>
            <div class="trip-stats-title">
Trip Stats
            </div>
            <button class="trip-stats-toggle"
                    id="trip-stats-toggle"
                    type="button"
                    aria-expanded="false"
                    aria-label="Toggle statistics details">
              <i class="fas fa-chevron-down" aria-hidden="true"></i>
            </button>
          </div>
          <div class="trip-stats-summary">
            <div class="trip-stats-summary-item">
              <div class="trip-stats-summary-value" id="widget-total-trips">
0
              </div>
              <div class="trip-stats-summary-label">
trips
              </div>
            </div>
            <div class="trip-stats-summary-divider">
            </div>
            <div class="trip-stats-summary-item">
              <div class="trip-stats-summary-value" id="widget-total-distance">
0
              </div>
              <div class="trip-stats-summary-label">
miles
              </div>
            </div>
          </div>
        </div>

        <!-- Expanded View -->
        <div class="trip-stats-expanded" id="trip-stats-expanded" style="display: none">
          <div class="trip-stats-expanded-content">
            <div class="trip-stats-metric">
              <div class="trip-stats-metric-icon">
                <i class="fas fa-route" aria-hidden="true"></i>
              </div>
              <div class="trip-stats-metric-info">
                <div class="trip-stats-metric-label">
Total Trips
                </div>
                <div class="trip-stats-metric-value" id="widget-detailed-trips">
0
                </div>
              </div>
            </div>
            <div class="trip-stats-metric">
              <div class="trip-stats-metric-icon">
                <i class="fas fa-road" aria-hidden="true"></i>
              </div>
              <div class="trip-stats-metric-info">
                <div class="trip-stats-metric-label">
Total Distance
                </div>
                <div class="trip-stats-metric-value">
                  <span id="widget-detailed-distance">0</span>
                  <span class="trip-stats-metric-unit">mi</span>
                </div>
              </div>
            </div>
            <div class="trip-stats-metric">
              <div class="trip-stats-metric-icon">
                <i class="fas fa-balance-scale" aria-hidden="true"></i>
              </div>
              <div class="trip-stats-metric-info">
                <div class="trip-stats-metric-label">
Avg Distance
                </div>
                <div class="trip-stats-metric-value">
                  <span id="widget-detailed-avg-distance">0</span>
                  <span class="trip-stats-metric-unit">mi</span>
                </div>
              </div>
            </div>
            <div class="trip-stats-metric">
              <div class="trip-stats-metric-icon">
                <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
              </div>
              <div class="trip-stats-metric-info">
                <div class="trip-stats-metric-label">
Avg Speed
                </div>
                <div class="trip-stats-metric-value">
                  <span id="widget-detailed-avg-speed">0</span>
                  <span class="trip-stats-metric-unit">mph</span>
                </div>
              </div>
            </div>
            <div class="trip-stats-metric">
              <div class="trip-stats-metric-icon">
                <i class="fas fa-clock" aria-hidden="true"></i>
              </div>
              <div class="trip-stats-metric-info">
                <div class="trip-stats-metric-label">
Avg Start Time
                </div>
                <div class="trip-stats-metric-value" id="widget-detailed-avg-start">
                  --:--
                </div>
              </div>
            </div>
            <div class="trip-stats-metric">
              <div class="trip-stats-metric-icon">
                <i class="fas fa-hourglass-half" aria-hidden="true"></i>
              </div>
              <div class="trip-stats-metric-info">
                <div class="trip-stats-metric-label">
Avg Duration
                </div>
                <div class="trip-stats-metric-value" id="widget-detailed-avg-duration">
                  --:--
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Live Trip HUD - Minimal pill -->
    <div id="live-trip-hud" class="live-trip-hud" aria-hidden="true">
      <span class="live-trip-hud-dot" aria-hidden="true"></span>
      <span class="live-trip-hud-speed" id="live-trip-speed">--</span>
      <span class="live-trip-hud-unit">mph</span>
      <span class="live-trip-hud-divider"></span>
      <span class="live-trip-hud-street" id="live-trip-street">--</span>
      <button class="live-trip-hud-follow"
              id="live-trip-follow-toggle"
              type="button"
              aria-pressed="false"
              aria-label="Follow vehicle">
        <i class="fas fa-location-arrow" aria-hidden="true"></i>
      </button>
    </div>

    <!-- Unified Control Panel - Redesigned -->
    <div id="map-controls" class="control-panel" role="region" aria-label="Map controls">
      <!-- Mobile handle -->
      <div class="mobile-sheet-handle-container">
        <div class="mobile-sheet-handle">
        </div>
      </div>

      <!-- Panel Header -->
      <div class="control-panel-header">
        <h2 class="control-panel-title">
          <i class="fas fa-layer-group" aria-hidden="true"></i>
          Map Controls
        </h2>
        <div class="control-panel-actions">
          <!-- Desktop toggle -->
          <button id="controls-toggle"
                  class="btn btn-sm btn-icon-only"
                  aria-label="Toggle Controls"
                  aria-expanded="true">
            <i class="fas fa-chevron-down" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="control-panel-quick-actions">
        <button class="quick-action-btn"
                data-street-mode="undriven"
                onclick="setStreetMode('undriven')">
          <i class="fas fa-road"></i>
          <span>Undriven</span>
        </button>
        <button class="quick-action-btn"
                data-street-mode="driven"
                onclick="setStreetMode('driven')">
          <i class="fas fa-check-circle"></i>
          <span>Driven</span>
        </button>
        <button class="quick-action-btn" data-street-mode="all" onclick="setStreetMode('all')">
          <i class="fas fa-layer-group"></i>
          <span>All</span>
        </button>
      </div>

      <!-- Panel Body -->
      <div class="control-panel-body">
        <!-- Location Selector -->
        <div class="control-section" id="location-selector-container">
          <div class="layer-group">
            <h3 class="layer-group-title">
Coverage Area
            </h3>
            <select id="streets-location" class="search-input">
              <option value="">
Select location...
              </option>
            </select>
          </div>
        </div>

        <!-- Map Style -->
        <div class="control-section">
          <div class="layer-group map-style-group">
            <div class="map-style-header">
              <h3 class="layer-group-title">
Map Style
              </h3>
              <span class="map-style-hint">
Basemap
              </span>
            </div>
            <div class="map-style-select-wrap">
              <i class="fas fa-palette map-style-select-icon" aria-hidden="true"></i>
              <select id="map-type-select" class="map-style-select" aria-label="Select map style">
                <option value="dark">
Dark
                </option>
                <option value="light">
Light
                </option>
                <option value="streets">
Streets
                </option>
                <option value="satellite">
Satellite
                </option>
              </select>
            </div>
          </div>
        </div>

        <!-- Layer Toggles -->
        <div class="control-section">
          <div class="layer-group">
            <h3 class="layer-group-title">
Layers
            </h3>
            <div id="layer-toggles" class="layer-toggles-grid">
              <!-- Layer toggles inserted by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Search -->
        <div class="search-container">
          <div class="search-wrapper">
            <i class="fas fa-search search-icon" aria-hidden="true"></i>
            <input type="text"
                   id="map-search-input"
                   class="search-input"
                   placeholder="Search places, addresses..."
                   autocomplete="off"
                   aria-label="Search map" />
          </div>
        </div>

        <!-- Legend -->
        <div class="legend-bar">
          <div class="legend-item">
            <span class="legend-indicator driven"></span>
            <span>Driven</span>
          </div>
          <div class="legend-item">
            <span class="legend-indicator undriven"></span>
            <span>Undriven</span>
          </div>
          <div class="legend-item">
            <span class="legend-indicator all"></span>
            <span>All</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Bouncie Simulator Toggle -->
    <button id="sim-toggle"
            class="sim-toggle-btn"
            type="button"
            aria-label="Toggle Bouncie Simulator"
            title="Bouncie Simulator">
      <i class="fas fa-broadcast-tower" aria-hidden="true"></i>
    </button>

    <!-- Search Results Dropdown (positioned outside control panel to avoid clipping) -->
    <div id="search-results"
         class="search-results-dropdown d-none"
         role="listbox"
         aria-label="Search results">
    </div>

    <!-- Mobile sheet backdrop (for when bottom sheet is expanded) -->
    <div class="mobile-sheet-backdrop">
    </div>
  </div>
</div>

<!-- Accessibility announcements -->
<div class="visually-hidden"
     aria-live="polite"
     aria-atomic="true"
     id="map-announcements">
</div>
