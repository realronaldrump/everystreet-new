{% extends "base.html" %}

{% block title %}
  Every Street Setup
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ CDN.mapbox_gl_css }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/setup-wizard.css') | replace('http://', '//') }}?v={{ repo_version.commit_count }}" />
{% endblock %}

{% block content %}
  <div class="setup-page">
    <div class="container-fluid setup-shell">

      {# ── Progress bar ── #}
      <div class="setup-progress-bar" aria-label="Setup progress">
        <div class="setup-progress-track">
          <div class="setup-progress-step is-active" data-progress-step="0">
            <span class="setup-progress-dot"><i class="fas fa-layer-group"></i></span>
            <span class="setup-progress-label">Engine</span>
          </div>
          <div class="setup-progress-connector">
            <div class="setup-progress-connector-fill" id="progress-connector-0"></div>
          </div>
          <div class="setup-progress-step" data-progress-step="1">
            <span class="setup-progress-dot"><i class="fas fa-key"></i></span>
            <span class="setup-progress-label">Credentials</span>
          </div>
          <div class="setup-progress-connector" id="progress-connector-container-1">
            <div class="setup-progress-connector-fill" id="progress-connector-1"></div>
          </div>
          <div class="setup-progress-step" data-progress-step="2" id="progress-step-coverage">
            <span class="setup-progress-dot"><i class="fas fa-map"></i></span>
            <span class="setup-progress-label">Map Coverage</span>
          </div>
        </div>
      </div>

      {# ── Hero ── #}
      <div class="setup-hero" data-stagger>
        <div class="setup-hero-text">
          <div class="setup-eyebrow">Every Street Setup</div>
          <h1 class="setup-title">Get your streets online in&nbsp;minutes.</h1>
          <p class="setup-subtitle">
            Two quick steps: save your API credentials, then import trips so we
            can build local coverage for geocoding and routing.
          </p>
        </div>
      </div>

      {# ── Main layout ── #}
      <div class="setup-layout">

        {# ── Sidebar ── #}
        <aside class="setup-sidebar">
          <ol class="setup-step-list" aria-label="Setup steps">
            <li class="setup-step-item is-active" data-step="0" data-step-key="engine">
              <button class="setup-step-button" type="button" data-step-target="0">
                <span class="step-number">1</span>
                <div>
                  <div class="step-title">Map Engine</div>
                  <div class="step-note">Google vs. Local</div>
                </div>
              </button>
            </li>
            <li class="setup-step-item" data-step="1" data-step-key="credentials">
              <button class="setup-step-button" type="button" data-step-target="1">
                <span class="step-number">2</span>
                <div>
                  <div class="step-title">Credentials</div>
                  <div class="step-note">Bouncie + Maps</div>
                </div>
              </button>
            </li>
            <li class="setup-step-item" data-step="2" data-step-key="coverage" id="sidebar-step-coverage">
              <button class="setup-step-button" type="button" data-step-target="2">
                <span class="step-number">3</span>
                <div>
                  <div class="step-title">Map Coverage</div>
                  <div class="step-note">Import &amp; build</div>
                </div>
              </button>
            </li>
          </ol>
          <div class="setup-sidebar-help">
            <a href="/status" class="setup-sidebar-help-link">
              <i class="fas fa-heartbeat"></i>
              <span>System Status</span>
            </a>
          </div>
        </aside>

        {# ════════════════════════════════════════════════════
           STEP 0 — MAP ENGINE
           ════════════════════════════════════════════════════ #}
        <main class="setup-content">
          <section class="setup-step is-active" data-step="0">
            <div class="setup-card">
              <div class="setup-card-header">
                <div>
                  <h2>Choose your Mapping Engine</h2>
                  <p>
                    Every Street supports two different mapping engines.
                    Choose the one that best fits your needs.
                  </p>
                </div>
              </div>

              <div class="setup-card-section">
                <div class="setup-provider-grid">
                  <label class="setup-provider-card">
                    <input type="radio" name="map_provider" value="self_hosted" class="setup-provider-input" checked />
                    <div class="setup-provider-content">
                      <div class="setup-provider-icon"><i class="fas fa-server"></i></div>
                      <div class="setup-provider-text">
                        <h3>Self-Hosted (Local)</h3>
                        <p>No monthly fees. We'll download map data for your driven areas to handle geocoding and routing locally using Valhalla and Nominatim.</p>
                      </div>
                    </div>
                  </label>

                  <label class="setup-provider-card">
                    <input type="radio" name="map_provider" value="google" class="setup-provider-input" />
                    <div class="setup-provider-content">
                      <div class="setup-provider-icon"><i class="fab fa-google"></i></div>
                      <div class="setup-provider-text">
                        <h3>Google Maps Cloud</h3>
                        <p>Lightweight and zero maintenance. Uses Google's APIs for rendering, routing, and geocoding. Perfect for local development or low-resource devices.</p>
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              <div class="setup-actions">
                <button class="btn btn-primary" id="provider-continue-btn" type="button">
                  Continue
                  <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </section>

        {# ════════════════════════════════════════════════════
           STEP 1 — CREDENTIALS
           ════════════════════════════════════════════════════ #}
          <section class="setup-step" data-step="1">
            <div class="setup-card">

              <div class="setup-card-header">
                <div>
                  <h2>Credentials</h2>
                  <p>
                    Save your API details once.
                    We'll validate everything before moving on.
                  </p>
                </div>
              </div>

              <div id="credentials-status" class="setup-status" role="status" aria-live="polite"></div>

              {# ── Bouncie Credentials ── #}
              <div class="setup-card-section">
                <div class="setup-card-section-header">
                  <div>
                    <h3>Bouncie Credentials</h3>
                    <p>Enter your Bouncie OAuth app details to connect your devices.</p>
                  </div>
                </div>

                {# Collapsible help #}
                <details class="setup-help-panel">
                  <summary class="setup-help-toggle">
                    <i class="fas fa-question-circle"></i>
                    Where do I get these credentials?
                  </summary>
                  <div class="setup-help-content">
                    <ol>
                      <li>Go to <a href="https://bouncie.dev" target="_blank" rel="noopener">bouncie.dev</a> and sign in with your Bouncie account.</li>
                      <li>Create a new app (or open an existing one).</li>
                      <li>Copy the <strong>Client ID</strong> and <strong>Client Secret</strong> from the app dashboard.</li>
                      <li>Set the <strong>Redirect URI</strong> below to match the one in your Bouncie app settings.</li>
                    </ol>
                    <div class="setup-help-tip">
                      <i class="fas fa-lightbulb"></i>
                      <span>The Redirect URI should point to this server's <code>/api/bouncie/callback</code> endpoint. We've pre-filled it for you.</span>
                    </div>
                  </div>
                </details>

                <form id="bouncieCredentialsForm" class="setup-form" novalidate>
                  <div class="setup-form-grid">
                    <div class="setup-field">
                      <label for="clientId" class="form-label">Client ID</label>
                      <input type="text" class="form-control" id="clientId" required
                             placeholder="e.g. abc123def456" />
                      <span class="setup-field-hint">Found in your Bouncie app dashboard</span>
                    </div>
                    <div class="setup-field">
                      <label for="clientSecret" class="form-label">Client Secret</label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="clientSecret" required
                               placeholder="••••••••" />
                        <button class="btn btn-outline-secondary" type="button" id="toggleClientSecret"
                                aria-label="Toggle secret visibility">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                      <span class="setup-field-hint">Keep this private — never share it publicly</span>
                    </div>
                    <div class="setup-field">
                      <label for="redirectUri" class="form-label">Redirect URI</label>
                      <input type="url" class="form-control" id="redirectUri" required />
                      <span class="setup-field-hint">Must match the URI registered in your Bouncie app</span>
                    </div>
                  </div>
                </form>

                <div class="setup-card-section-header mt-4" id="googleCredentialsHeader" style="display: none;">
                  <div>
                    <h3>Google Maps Platform</h3>
                    <p>Enter your Google Maps API Key to enable cloud routing and geocoding.</p>
                  </div>
                </div>
                <form id="googleCredentialsForm" class="setup-form" novalidate style="display: none;">
                  <div class="setup-form-grid">
                    <div class="setup-field">
                      <label for="googleMapsApiKey" class="form-label">API Key</label>
                      <input type="text" class="form-control" id="googleMapsApiKey" placeholder="AIzaSy..." />
                      <span class="setup-field-hint">Must have Maps JavaScript, Directions, Roads, and Geocoding APIs enabled.</span>
                    </div>
                  </div>
                </form>

                {# Bouncie connect actions — shown after credentials are saved #}
                <div class="setup-connect-actions" id="bouncie-connect-actions">
                  <a href="#" class="btn btn-success" id="connectBouncieBtn" role="button">
                    <i class="fas fa-plug"></i> Connect with Bouncie
                  </a>
                  <details class="setup-advanced-toggle">
                    <summary>Advanced: Sync vehicles manually</summary>
                    <div class="setup-advanced-content">
                      <p class="text-muted small">
                        Vehicles are synced automatically when you connect. Use this only
                        if you need to re-sync after adding a new device.
                      </p>
                      <button class="btn btn-outline-light btn-sm" id="syncVehiclesBtn" type="button" disabled>
                        <i class="fas fa-sync"></i> Sync Vehicles
                      </button>
                    </div>
                  </details>
                </div>
              </div>

              <div class="setup-card-footer-note">
                <i class="fas fa-info-circle"></i>
                Need to edit later? Manage credentials in
                <a href="/settings#credentials">Settings&nbsp;&gt;&nbsp;Credentials</a>.
              </div>

              <div class="setup-actions">
                <button class="setup-step-button-back btn btn-outline-light" type="button" data-step-target="0">
                  <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-primary" id="credentials-continue-btn" type="button">
                  Verify &amp; Continue
                  <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </section>

          {# ════════════════════════════════════════════════════
             STEP 2 — MAP COVERAGE (unified flow)
             ════════════════════════════════════════════════════ #}
          <section class="setup-step" data-step="2" id="step-coverage-section">
            <div class="setup-card">

              <div class="setup-card-header">
                <div>
                  <h2>Map Coverage</h2>
                  <p id="coverage-step-description">
                    Import your recent trips so we can detect which states to download.
                    Coverage data powers local geocoding and routing.
                  </p>
                </div>
                <div class="setup-pill-group">
                  <div class="setup-pill" id="coverage-mode-pill">Trip coverage</div>
                  <div class="setup-pill is-muted" id="coverage-status-pill">Not configured</div>
                </div>
              </div>

              <div id="coverage-status" class="setup-status" role="status" aria-live="polite"></div>

              {# ── Phase: Import Trips ── #}
              <div class="setup-phase" id="phase-import">
                <div class="setup-phase-header">
                  <div class="setup-phase-icon">
                    <i class="fas fa-route"></i>
                  </div>
                  <div>
                    <h3>Import Recent Trips</h3>
                    <p class="text-muted" id="import-description">
                      We'll fetch your trips from <strong>the last 7 days</strong> from Bouncie.
                      This tells us which states you've been driving in so we download
                      only the coverage data you actually need.
                    </p>
                  </div>
                </div>

                <div class="setup-import-meta" id="import-meta">
                  <div class="setup-import-meta-item">
                    <span class="setup-import-meta-label">Trips imported</span>
                    <span class="setup-import-meta-value" id="trip-sync-count">--</span>
                  </div>
                  <div class="setup-import-meta-item">
                    <span class="setup-import-meta-label">Status</span>
                    <span class="setup-pill is-muted" id="trip-sync-state-pill">Idle</span>
                  </div>
                </div>

                {# Live activity log — visible during import #}
                <div class="setup-import-activity d-none" id="import-activity">
                  <div class="setup-import-activity-header">
                    <i class="fas fa-stream"></i>
                    <span>Import Activity</span>
                  </div>
                  <ul class="setup-import-activity-log" id="import-activity-log">
                    {# JS will populate this with live status lines #}
                  </ul>
                </div>

                <div class="setup-import-hint d-none" id="trip-sync-hint"></div>

                <button class="btn btn-primary setup-import-btn" id="coverage-import-trips-btn" type="button">
                  <i class="fas fa-download"></i>
                  Import Recent Trips
                </button>

                <div class="setup-help-tip" id="import-tip">
                  <i class="fas fa-lightbulb"></i>
                  <span>Need more history? You can import your full trip history later from
                    <a href="/settings#sync">Settings&nbsp;&gt;&nbsp;Sync</a>.</span>
                </div>
              </div>

              {# ── Phase: Detected Coverage ── #}
              <div class="setup-phase d-none" id="phase-detected">
                <div class="setup-phase-header">
                  <div class="setup-phase-icon is-success">
                    <i class="fas fa-check"></i>
                  </div>
                  <div>
                    <h3 id="coverage-select-title">Detected Coverage</h3>
                    <p class="text-muted" id="coverage-select-description">
                      Based on your trips, we've identified the states below.
                      Coverage data will be downloaded and built for these areas.
                    </p>
                  </div>
                </div>

                <div class="setup-detected-states" id="state-selection">
                  <div class="text-muted">Loading states...</div>
                </div>

                <div class="setup-coverage-summary">
                  <div class="setup-coverage-summary-item">
                    <span class="coverage-label">Total size</span>
                    <span class="setup-coverage-summary-value" id="coverage-total-size">--</span>
                  </div>
                  <div class="setup-coverage-summary-item">
                    <span class="coverage-label">Estimated time</span>
                    <span class="setup-coverage-summary-value" id="coverage-time-estimate">--</span>
                  </div>
                </div>

                <button class="btn btn-primary" id="map-setup-btn" type="button">
                  <i class="fas fa-hammer"></i>
                  Build Coverage
                </button>

                {# Hidden elements still needed by JS for compatibility #}
                <span class="d-none" id="coverage-total-size-review"></span>
                <span class="d-none" id="coverage-time-estimate-review"></span>
                <span class="d-none" id="coverage-review-btn" disabled></span>
                <span class="d-none" id="coverage-run-btn" disabled></span>
                <span class="d-none" id="coverage-back-btn"></span>
                <span class="d-none" id="coverage-summary-list"></span>
                <span class="d-none" id="coverage-review-list"></span>
                <span class="d-none" id="state-search" disabled></span>
                <span class="d-none" id="coverage-search"></span>
                <span class="d-none" id="coverage-select-hint"></span>
                <span class="d-none" id="coverage-trips-banner"></span>
                <span class="d-none" id="coverage-trips-title"></span>
                <span class="d-none" id="coverage-trips-message"></span>
                <span class="d-none" id="trip-sync-last-success"></span>
                <span class="d-none" id="trip-sync-last-attempt"></span>
              </div>

              {# ── Phase: Building ── #}
              <div class="setup-phase d-none" id="phase-building">
                <div class="setup-phase-header">
                  <div class="setup-phase-icon is-building">
                    <i class="fas fa-cog fa-spin"></i>
                  </div>
                  <div>
                    <h3>Building Coverage</h3>
                    <p class="text-muted">
                      Downloading and building routing data. This runs in the
                      background — feel free to start exploring the app.
                    </p>
                  </div>
                </div>

                <div class="setup-build-progress" id="map-setup-progress">
                  <div class="progress">
                    <div class="progress-bar" id="map-setup-progress-bar" style="width: 0%"></div>
                  </div>
                  <div class="progress-meta">
                    <span id="map-setup-progress-text"></span>
                    <span id="map-setup-message">Starting...</span>
                  </div>
                </div>

                <div class="setup-build-actions">
                  <a class="btn btn-primary" href="/" id="build-continue-btn">
                    <i class="fas fa-arrow-right"></i> Continue to Dashboard
                  </a>
                  <button class="btn btn-outline-light" id="map-cancel-btn" type="button">
                    <i class="fas fa-times"></i> Cancel Build
                  </button>
                </div>
                <div class="setup-help-tip">
                  <i class="fas fa-info-circle"></i>
                  <span>Coverage will finish building in the background.
                    You'll be able to see progress any time from
                    <a href="/settings#coverage">Settings&nbsp;&gt;&nbsp;Coverage</a>.</span>
                </div>
              </div>

              {# ── Phase: Ready / Finish ── #}
              <div class="setup-phase d-none" id="phase-ready">
                <div class="setup-phase-header">
                  <div class="setup-phase-icon is-success is-celebrate">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div>
                    <h3>You're All Set!</h3>
                    <p class="text-muted">
                      Coverage is built and ready. Your streets are now online with
                      local geocoding and routing.
                    </p>
                  </div>
                </div>

                <button class="btn btn-success setup-finish-btn" id="finish-setup-btn" type="button">
                  <i class="fas fa-rocket"></i>
                  Go to Dashboard
                </button>
              </div>

              <div class="setup-actions" id="coverage-actions">
                <button class="setup-step-button-back btn btn-outline-light" type="button" data-step-target="1">
                  <i class="fas fa-arrow-left"></i> Back to Credentials
                </button>
              </div>

            </div>
          </section>
        </main>
      </div>
    </div>
  </div>

  {# Page scripts are loaded via route-loader + swup. #}

{% endblock %}
