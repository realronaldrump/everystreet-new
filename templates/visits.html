{% extends "base.html" %}

{% block title %}

Every Street - Visits
{% endblock %}

{% block head_content %}

  <link rel="stylesheet" href="{{ CDN.mapbox_draw_css }}" crossorigin="anonymous" />
{% endblock %}


{% block extra_css %}

  <!-- Mapbox GL CSS -->
  <link rel="stylesheet" href="{{ CDN.mapbox_gl_css }}" />
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="{{ CDN.datatables_css }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/features/map/index.css') | replace('http://', '//') }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/search.css') | replace('http://', '//') }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/visits.css') | replace('http://', '//') }}" />
{% endblock %}


{% block content %}

  <div id="visits-page" class="container-fluid px-4 py-4">
    <div class="bento-grid" data-stagger>
      <div class="bento-span-12 widget" data-accent="mint">
        <div class="widget-header">
          <div>
            <h1 class="widget-title">
              <i class="fas fa-map-marked-alt" aria-hidden="true"></i>
              Your Places & Visits
            </h1>
            <div class="widget-meta">
              Track and analyze your visits to custom places and monitor patterns over time.
            </div>
          </div>
          <div class="d-inline-flex align-items-center">
            <div class="me-4">
              <div class="h2 mb-0 text-primary fw-bold">
                <span id="total-places-count">0</span>
              </div>
              <div class="text-secondary small">
Custom Places
              </div>
            </div>
            <div>
              <div class="h2 mb-0 text-success fw-bold">
                <span id="total-visits-count">0</span>
              </div>
              <div class="text-secondary small">
Place Visits
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bento-span-4 widget" data-accent="purple">
        <div class="widget-header">
          <h3 class="widget-title">
            <i class="fas fa-layer-group" aria-hidden="true"></i>
            Places Management
          </h3>
        </div>
        <div class="widget-body">
          <div class="mb-4">
            <label for="place-name" class="form-label fw-semibold mb-3">
              <i class="fas fa-tag me-2 text-primary"></i>
            Place Name
            </label>
            <input type="text"
                   id="place-name"
                   class="form-control form-control-lg place-name-input"
                   placeholder="Enter a memorable name..." />
            <div class="invalid-feedback">
              Please enter a name for the place.
            </div>
            <div class="form-text mt-2">
              <i class="fas fa-info-circle me-1"></i>
            Choose a name that helps you remember this location
            </div>
          </div>

          <div class="form-check form-switch mb-4 p-3 bg-body-secondary rounded-3">
            <input type="checkbox"
                   class="form-check-input"
                   id="toggle-custom-places"
                   checked
                   style="width: 3em;
                          height: 1.5em" />
            <label class="form-check-label ms-2 fw-medium" for="toggle-custom-places">
            Show Custom Places on Map
            </label>
          </div>

          <div class="d-grid gap-3 mb-4">
            <button id="start-drawing" class="btn btn-lg btn-primary action-button draw-button">
              <i class="fas fa-draw-polygon me-2"></i>
              <span>Draw Place Boundary</span>
            </button>
            <button id="save-place" class="btn btn-lg btn-success action-button" disabled>
              <i class="fas fa-save me-2"></i>
              <span>Save Place</span>
            </button>
          </div>

          <div class="divider-gradient my-4">
          </div>

          <button id="manage-places" class="btn btn-lg btn-outline-primary w-100 action-button">
            <i class="fas fa-cog me-2"></i>
            <span>Manage All Places</span>
          </button>

          <div class="mt-4 p-3 bg-body-secondary rounded-3">
            <div class="row g-3 text-center">
              <div class="col-6">
                <div class="p-2">
                  <i class="fas fa-map-pin text-primary mb-2" style="font-size: 1.5rem;"></i>
                  <div class="small text-secondary">
Active Places
                  </div>
                  <div class="fw-bold" id="active-places-stat">
0
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="p-2">
                  <i class="fas fa-calendar-check text-success mb-2" style="font-size: 1.5rem;"></i>
                  <div class="small text-secondary">
This Month
                  </div>
                  <div class="fw-bold" id="month-visits-stat">
0
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bento-span-8 widget" data-accent="sky">
        <div class="widget-header">
          <h3 class="widget-title">
            <i class="fas fa-map" aria-hidden="true"></i>
            Places Map
          </h3>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary-subtle text-primary px-3 py-2">
              <i class="fas fa-mouse-pointer me-1"></i>
            Interactive Map
            </span>
          </div>
        </div>
        <div class="widget-body p-0 position-relative">
          <div id="map" class="map-container map-container-standard map-container--visits">
          </div>
          <div class="map-controls-enhanced">
            <button type="button"
                    class="map-control-btn"
                    id="zoom-to-fit"
                    title="Zoom to fit all places"
                    data-bs-toggle="tooltip">
              <i class="fas fa-expand-arrows-alt"></i>
            </button>
            <button type="button"
                    class="map-control-btn"
                    id="clear-drawing"
                    title="Clear current drawing"
                    data-bs-toggle="tooltip">
              <i class="fas fa-eraser"></i>
            </button>
            <button type="button"
                    class="map-control-btn"
                    id="map-style-toggle"
                    title="Toggle map style"
                    data-bs-toggle="tooltip">
              <i class="fas fa-palette"></i>
            </button>
          </div>
          <div id="map-loading"
               class="position-absolute top-0 start-0 end-0 bottom-0 d-flex align-items-center justify-content-center bg-dark bg-opacity-75"
               style="z-index: 20;
                      display: none">
            <div class="text-center">
              <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="text-secondary">
Loading map data...
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="bento-span-12 widget" data-accent="lime" id="visits-table-container">
        <div class="widget-header">
          <div class="d-flex flex-wrap align-items-center justify-content-between w-100 gap-3">
            <h3 class="widget-title">
              <i class="fas fa-chart-line" aria-hidden="true"></i>
              Visit Statistics
            </h3>
            <select class="form-select form-select-sm" id="time-filter" style="width: auto;">
              <option value="all">
All Time
              </option>
              <option value="year">
This Year
              </option>
              <option value="month">
This Month
              </option>
              <option value="week">
This Week
              </option>
            </select>
          </div>
        </div>
        <div class="widget-body">
          <ul class="nav visits-nav-tabs" id="visitsTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active"
                      id="custom-places-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#custom-places-content"
                      type="button"
                      role="tab">
                <i class="fas fa-map-marker-alt me-2"></i>
                <span class="nav-label">Custom Places</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link"
                      id="non-custom-places-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#non-custom-places-content"
                      type="button"
                      role="tab">
                <i class="fas fa-globe me-2"></i>
                <span class="nav-label">Other Locations</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link"
                      id="suggested-places-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#suggested-places-content"
                      type="button"
                      role="tab">
                <i class="fas fa-magic me-2"></i>
                <span class="nav-label">Suggestions</span>
              </button>
            </li>
            <li class="nav-item ms-auto" role="presentation">
              <button class="nav-link"
                      id="insights-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#insights-content"
                      type="button"
                      role="tab">
                <i class="fas fa-lightbulb me-2"></i>
                <span class="nav-label">Insights</span>
              </button>
            </li>
          </ul>

          <div class="tab-content" id="visitsTabContent">
            <div class="tab-pane fade show active" id="custom-places-content" role="tabpanel">
              <div class="row">
                <div class="col-lg-5 mb-4 mb-lg-0">
                  <div class="chart-container">
                    <h5 class="text-center mb-3 fw-semibold">
Visit Distribution
                    </h5>
                    <canvas id="visitsChart" style="max-height: 350px"></canvas>
                  </div>
                </div>
                <div class="col-lg-7">
                  <div class="table-responsive">
                    <table id="visits-table" class="table visits-table" style="width: 100%">
                      <thead>
                        <tr>
                          <th>
Place
                          </th>
                          <th class="text-end">
Visits
                          </th>
                          <th>
First Visit
                          </th>
                          <th>
Last Visit
                          </th>
                          <th class="text-end">
Avg Duration
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="non-custom-places-content" role="tabpanel">
              <div class="table-responsive">
                <table id="non-custom-visits-table" class="table visits-table" style="width: 100%">
                  <thead>
                    <tr>
                      <th>
Location
                      </th>
                      <th class="text-end">
Visits
                      </th>
                      <th>
First Visit
                      </th>
                      <th>
Last Visit
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="suggested-places-content" role="tabpanel">
              <div class="table-responsive">
                <table id="suggested-places-table" class="table visits-table" style="width: 100%">
                  <thead>
                    <tr>
                      <th>
Suggested Name
                      </th>
                      <th class="text-end">
Visits
                      </th>
                      <th>
First Visit
                      </th>
                      <th>
Last Visit
                      </th>
                      <th class="text-center">
Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="insights-content" role="tabpanel">
              <div class="row g-4">
                <div class="col-md-4">
                  <div class="text-center p-4 bg-body-secondary rounded-3">
                    <div class="progress-ring mb-3">
                      <svg width="120" height="120">
<circle cx="60" cy="60" r="54" stroke="var(--surface-3)" stroke-width="4" fill="none" />
<circle class="progress-ring-circle" cx="60" cy="60" r="54" />
                      </svg>
                    </div>
                    <h6 class="fw-semibold">
Most Visited
                    </h6>
                    <p class="text-primary fw-bold mb-0" id="most-visited-place">
-
                    </p>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="text-center p-4 bg-body-secondary rounded-3">
                    <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                    <h6 class="fw-semibold">
Average Visit Duration
                    </h6>
                    <p class="text-warning fw-bold mb-0" id="avg-visit-duration">
-
                    </p>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="text-center p-4 bg-body-secondary rounded-3">
                    <i class="fas fa-calendar-alt fa-3x text-info mb-3"></i>
                    <h6 class="fw-semibold">
Visit Frequency
                    </h6>
                    <p class="text-info fw-bold mb-0" id="visit-frequency">
-
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bento-span-12 widget"
           data-accent="amber"
           id="trips-for-place-container"
           style="display: none">
        <div class="widget-header">
          <h3 class="widget-title">
            <i class="fas fa-route" aria-hidden="true"></i>
            Trips for
            <span id="selected-place-name" class="text-primary"></span>
          </h3>
          <button id="back-to-places-btn" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>
          Back to Places
          </button>
        </div>
        <div class="widget-body">
          <div class="table-responsive">
            <table id="trips-for-place-table" class="table visits-table" style="width: 100%">
              <thead>
                <tr>
                  <th>
Trip ID
                  </th>
                  <th>
Date
                  </th>
                  <th>
Arrival
                  </th>
                  <th>
Departure
                  </th>
                  <th class="text-end">
Duration
                  </th>
                  <th class="text-end">
Since Last
                  </th>
                  <th class="text-center">
Actions
                  </th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade visits-modal" id="manage-places-modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-cog me-2"></i>
          Manage Places
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal">
          </button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table id="manage-places-table" class="table visits-table" style="width: 100%">
              <thead>
                <tr>
                  <th>
Place Name
                  </th>
                  <th class="text-center">
Created
                  </th>
                  <th class="text-center">
Actions
                  </th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade visits-modal" id="edit-place-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-edit me-2"></i>
          Edit Place
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal">
          </button>
        </div>
        <div class="modal-body">
          <form id="edit-place-form">
            <input type="hidden" id="edit-place-id" />
            <div class="mb-4">
              <label for="edit-place-name" class="form-label fw-semibold">
                <i class="fas fa-tag me-2 text-primary"></i>
              Place Name
              </label>
              <input type="text"
                     class="form-control form-control-lg place-name-input"
                     id="edit-place-name"
                     required />
            </div>
            <div class="d-flex justify-content-between gap-3">
              <button type="button" class="btn btn-outline-primary" id="edit-place-boundary">
                <i class="fas fa-draw-polygon me-2"></i>
              Edit Boundary
              </button>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-2"></i>
              Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade visits-modal" id="view-trip-modal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-route me-2"></i>
          Trip Details
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal">
          </button>
        </div>
        <div class="modal-body">
          <div id="trip-info" class="mb-4">
          </div>
          <div id="trip-map-container" class="map-container map-container-standard">
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}



{% block extra_js %}

  <!-- Mapbox GL JS -->
  <script src="{{ CDN.mapbox_gl_js }}"></script>
  <script src="{{ CDN.mapbox_draw_js }}"></script>
  <script>
      // Make Mapbox access token available globally
      window.MAPBOX_ACCESS_TOKEN = "{{ MAPBOX_ACCESS_TOKEN }}";
  </script>
  <script src="{{ CDN.chartjs }}"></script>
  <script src="{{ CDN.jquery }}" crossorigin="anonymous"></script>
  <!-- DataTables JS -->
  <script src="{{ CDN.datatables_js }}"></script>
  <script type="module"
          src="{{ url_for('static', path='js/pages/visits.js') | replace('http://', '//') }}"></script>
{% endblock %}
