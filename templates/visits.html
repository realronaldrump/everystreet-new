{% extends "base.html" %} {% block title %}Every Street - Visits{% endblock %}
{% block head_content %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
/>
<!-- Removed inline styles for tables, tabs, etc. They are now in style.css -->
<style>
  /* Page-specific styles that are not part of the global system can remain or be moved to a page-specific CSS file */
  .map-container {
    /* This is a common class, but height is often page-specific */
    height: 500px !important; /* Default height for this page */
    width: 100% !important;
    border-radius: var(--radius-md);
    background-color: var(--surface-2); /* Match theme */
    display: block !important;
    visibility: visible !important;
    position: relative !important;
    z-index: 5 !important;
  }

  #trip-map-container {
    /* Specific map container in modal */
    height: 400px;
  }

  .place-popup .btn {
    /* Specific to popups on this page's map */
    margin-top: var(--space-2);
  }
  .trip-marker {
    /* Leaflet specific marker styling */
    color: var(--info);
    text-align: center;
    line-height: 20px;
    font-size: 20px;
    text-shadow: 0 0 3px rgba(0, 0, 0, 0.7);
  }
  .start-marker {
    color: var(--success);
  }
  .end-marker {
    color: var(--danger);
  }

  /* Ensure Leaflet Draw tooltips are interactive if needed, or style them */
  .leaflet-draw-tooltip {
    background-color: var(--surface-glass) !important;
    color: var(--text-primary) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--radius-sm) !important;
    box-shadow: var(--shadow-md) !important;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid px-4 py-3">
  <div id="visits-page"></div>
  <!-- This div seems unused, can be removed if not needed by JS -->
  <div class="row">
    <!-- Places Management Column -->
    <div class="col-lg-4 col-md-12 mb-4">
      <!-- Adjusted col for better responsiveness -->
      <div class="card">
        <div class="card-header">
          <h3 class="h5 mb-0 card-title">Places Management</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <!-- Changed to form-group for consistency -->
            <label for="place-name" class="form-label">Place Name</label>
            <input
              type="text"
              id="place-name"
              class="form-control"
              placeholder="Enter place name"
            />
          </div>
          <div class="form-check form-switch mb-3">
            <input
              type="checkbox"
              class="form-check-input"
              id="toggle-custom-places"
              checked
            />
            <label class="form-check-label" for="toggle-custom-places">
              Show Custom Places on Map
            </label>
          </div>
          <div class="d-grid gap-2 mb-3">
            <button id="start-drawing" class="btn btn-primary">
              <i class="fas fa-draw-polygon me-2"></i> Draw Place
            </button>
            <button id="save-place" class="btn btn-success" disabled>
              <i class="fas fa-save me-2"></i> Save Place
            </button>
          </div>
          <hr class="my-3" />
          <button id="manage-places" class="btn btn-outline-secondary w-100">
            <i class="fas fa-cog me-2"></i> Manage All Places
          </button>
        </div>
      </div>
    </div>
    <!-- Map Column -->
    <div class="col-lg-8 col-md-12 mb-4">
      <!-- Adjusted col for better responsiveness -->
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h3 class="h5 mb-0 card-title">Places Map</h3>
          <div class="map-controls">
            <div class="btn-group btn-group-sm" role="group">
              <button
                type="button"
                class="btn btn-outline-secondary"
                id="zoom-to-fit"
                title="Zoom to fit all custom places"
                data-bs-toggle="tooltip"
              >
                <i class="fas fa-expand-arrows-alt"></i>
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary"
                id="clear-drawing"
                title="Clear current drawing"
                data-bs-toggle="tooltip"
              >
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <!-- Remove padding if map should fill -->
          <div id="map" class="map-container"></div>
        </div>
      </div>
    </div>
    <!-- Visit Statistics -->
    <div class="col-12" id="visits-table-container">
      <div class="card">
        <div class="card-header">
          <h3 class="h5 mb-0 card-title">Visit Statistics</h3>
        </div>
        <div class="card-body">
          <ul class="nav nav-tabs mb-3" id="visitsTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="custom-places-tab"
                data-bs-toggle="tab"
                data-bs-target="#custom-places-content"
                type="button"
                role="tab"
                aria-controls="custom-places-content"
                aria-selected="true"
              >
                Custom Places
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="non-custom-places-tab"
                data-bs-toggle="tab"
                data-bs-target="#non-custom-places-content"
                type="button"
                role="tab"
                aria-controls="non-custom-places-content"
                aria-selected="false"
              >
                Other Visited Locations
              </button>
            </li>
          </ul>
          <div class="tab-content" id="visitsTabContent">
            <div
              class="tab-pane fade show active"
              id="custom-places-content"
              role="tabpanel"
              aria-labelledby="custom-places-tab"
            >
              <div class="row">
                <div class="col-lg-5 mb-4 mb-lg-0">
                  <!-- Adjusted col for chart -->
                  <canvas id="visitsChart" style="max-height: 400px"></canvas>
                </div>
                <div class="col-lg-7">
                  <!-- Adjusted col for table -->
                  <div class="table-responsive-lg">
                    <table
                      id="visits-table"
                      class="table table-hover"
                      style="width: 100%"
                    >
                      <thead>
                        <tr>
                          <th>Place</th>
                          <th class="text-end">Total Visits</th>
                          <th>First Visit</th>
                          <th>Last Visit</th>
                          <th class="text-end">Avg Time Spent</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div
              class="tab-pane fade"
              id="non-custom-places-content"
              role="tabpanel"
              aria-labelledby="non-custom-places-tab"
            >
              <div class="table-responsive-lg">
                <table
                  id="non-custom-visits-table"
                  class="table table-hover"
                  style="width: 100%"
                >
                  <thead>
                    <tr>
                      <th>Place</th>
                      <th class="text-end">Total Visits</th>
                      <th>First Visit</th>
                      <th>Last Visit</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Trips for Selected Place -->
    <div
      class="col-12 mt-4"
      id="trips-for-place-container"
      style="display: none"
    >
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h3 class="h5 mb-0 card-title">
            Trips for
            <span id="selected-place-name" class="text-primary"
              >Selected Place</span
            >
          </h3>
          <button
            id="back-to-places-btn"
            class="btn btn-sm btn-outline-secondary"
          >
            <i class="fas fa-arrow-left me-1"></i> Back to Places
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive-lg">
            <table
              id="trips-for-place-table"
              class="table table-hover"
              style="width: 100%"
            >
              <thead>
                <tr>
                  <th>Transaction ID</th>
                  <th>Arrival Date</th>
                  <th class="text-end">Arrival Time</th>
                  <th class="text-end">Departure Time</th>
                  <th class="text-end">Duration of Stay</th>
                  <th class="text-end">Time Since Last Visit</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Manage Places Modal -->
<div
  class="modal fade"
  id="manage-places-modal"
  tabindex="-1"
  aria-labelledby="managePlacesModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="managePlacesModalLabel">Manage Places</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive-lg">
          <table
            id="manage-places-table"
            class="table table-hover"
            style="width: 100%"
          >
            <thead>
              <tr>
                <th>Name</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Place Modal -->
<div
  class="modal fade"
  id="edit-place-modal"
  tabindex="-1"
  aria-labelledby="editPlaceModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPlaceModalLabel">Edit Place</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="edit-place-form">
          <input type="hidden" id="edit-place-id" />
          <div class="form-group">
            <label for="edit-place-name" class="form-label">Place Name</label>
            <input
              type="text"
              class="form-control"
              id="edit-place-name"
              required
            />
          </div>
          <div class="d-flex justify-content-between mt-4">
            <button
              type="button"
              class="btn btn-outline-primary"
              id="edit-place-boundary"
            >
              <i class="fas fa-draw-polygon me-2"></i> Edit Boundary
            </button>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save me-2"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- View Trip Modal -->
<div
  class="modal fade"
  id="view-trip-modal"
  tabindex="-1"
  aria-labelledby="viewTripModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <!-- Made modal larger -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewTripModalLabel">Trip Details</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="trip-info" class="mb-3">
          <!-- Trip info will be populated here -->
        </div>
        <div
          id="trip-map-container"
          class="map-container"
          style="height: 450px"
        ></div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', path='js/map-base.js') | replace('http://', '//') }}"></script>
<script src="{{ url_for('static', path='js/visits.js') | replace('http://', '//') }}"></script>

<!-- EMERGENCY MAP FIX -->
<script>
  // This script will directly initialize the map regardless of any other issues
  document.addEventListener("DOMContentLoaded", function () {
    setTimeout(function () {
      try {
        console.log("EMERGENCY MAP FIX: Starting direct map initialization");
        const mapContainer = document.getElementById("map");

        // Make sure the map container is visible and has height
        if (mapContainer) {
          mapContainer.style.height = "500px";
          mapContainer.style.width = "100%";
          mapContainer.style.display = "block";
          mapContainer.style.visibility = "visible";
          mapContainer.style.position = "relative";
          mapContainer.style.zIndex = "50";

          // Check if Leaflet map already exists on this container and remove it
          if (mapContainer._leaflet_id) {
            console.log(
              "EMERGENCY MAP FIX: Found existing map, cleaning up first",
            );
            mapContainer.innerHTML = "";
            mapContainer._leaflet_id = null;
            if (window.visitsManager && window.visitsManager.map) {
              try {
                window.visitsManager.map.remove();
                window.visitsManager.map = null;
              } catch (e) {
                console.log(
                  "EMERGENCY MAP FIX: Error cleaning up existing map:",
                  e,
                );
              }
            }
          }

          console.log("EMERGENCY MAP FIX: Container prepared");

          // Directly create a Leaflet map
          if (typeof L !== "undefined") {
            const newMapDiv = document.createElement("div");
            newMapDiv.id = "emergency-map";
            newMapDiv.style.height = "100%";
            newMapDiv.style.width = "100%";
            mapContainer.appendChild(newMapDiv);

            const emergencyMap = L.map("emergency-map", {
              center: [37.0902, -95.7129],
              zoom: 4,
            });

            // Add tile layer
            L.tileLayer(
              "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
              {
                attribution:
                  '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19,
              },
            ).addTo(emergencyMap);

            // Bind draw-created event so onPolygonCreated still works
            if (window.visitsManager) {
              emergencyMap.on(L.Draw.Event.CREATED, function (e) {
                window.visitsManager.onPolygonCreated(e);
              });
            }

            // Force redraw
            setTimeout(function () {
              emergencyMap.invalidateSize(true);
              console.log("EMERGENCY MAP FIX: Map should now be visible");
            }, 500);

            // Make this map available to the VisitsManager
            if (window.visitsManager) {
              window.visitsManager.map = emergencyMap;

              if (!window.visitsManager.customPlacesLayer) {
                window.visitsManager.customPlacesLayer =
                  L.featureGroup().addTo(emergencyMap);
              } else {
                window.visitsManager.customPlacesLayer.addTo(emergencyMap);
              }
              console.log("EMERGENCY MAP FIX: Connected to VisitsManager");
            }
          } else {
            console.error("EMERGENCY MAP FIX: Leaflet (L) is not defined");
            mapContainer.innerHTML =
              '<div class="alert alert-danger">Leaflet library not loaded. Please refresh the page.</div>';
          }
        } else {
          console.error("EMERGENCY MAP FIX: Map container #map not found");
        }
      } catch (error) {
        console.error("EMERGENCY MAP FIX: Error during emergency fix:", error);
      }
    }, 1000); // Delay to ensure DOM is fully loaded
  });
</script>
{% endblock %}
