{% extends "base.html" %}

{% block title %}

Every Street - Map Matching
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ CDN.mapbox_gl_css }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/map-matching.css') | replace('http://', '//') }}" />
{% endblock %}

{% block head_content %}
  <meta name="mapbox-access-token" content="{{ MAPBOX_ACCESS_TOKEN }}" />
  <script>
      window.MAPBOX_ACCESS_TOKEN = "{{ MAPBOX_ACCESS_TOKEN }}";
      document.dispatchEvent(
          new CustomEvent("es:mapbox-token-ready", {
              detail: {
                  token: window.MAPBOX_ACCESS_TOKEN
              },
          }),
      );
  </script>
{% endblock %}

{% block content %}
  <div class="container-fluid px-4 py-3 map-matching-page">
    <div class="bento-grid" data-stagger>
      <div class="bento-span-12 widget map-matching-hero" data-accent="mint">
        <div class="widget-header">
          <div>
            <h1 class="widget-title">
              <i class="fas fa-route" aria-hidden="true"></i>
              Map Matching
            </h1>
            <div class="widget-meta">
              Snap your trips to real roads for cleaner, more accurate routes.
            </div>
          </div>
        </div>
      </div>

      <div class="bento-span-7 widget map-matching-form" data-accent="mint">
        <div class="widget-header">
          <div>
            <h2 class="widget-title">
              <i class="fas fa-magic" aria-hidden="true"></i>
              Start Matching
            </h2>
            <div class="widget-meta">
              Pick which trips you want to process.
            </div>
          </div>
        </div>
        <div class="widget-body">
          <div class="wizard-step">
            <span class="step-pill">1</span>
            <span>What would you like to match?</span>
          </div>
          <form id="map-matching-form">
            <div class="mb-3">
              <label class="form-label" for="map-match-mode">Mode</label>
              <select id="map-match-mode" class="form-select">
                <option value="unmatched">Unmatched trips</option>
                <option value="date_range">Date range</option>
                <option value="trip_id">Specific trip</option>
              </select>
            </div>

            <div id="map-match-date-controls" class="d-none">
              <div class="mb-3">
                <label class="form-label" for="map-match-date-mode">Date input</label>
                <select id="map-match-date-mode" class="form-select">
                  <option value="date">Date range</option>
                  <option value="interval">Interval</option>
                </select>
              </div>

              <div id="map-match-date-range" class="mb-3">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label" for="map-match-start">Start date</label>
                    <input type="text" id="map-match-start" class="form-control datepicker" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label" for="map-match-end">End date</label>
                    <input type="text" id="map-match-end" class="form-control datepicker" />
                  </div>
                </div>
              </div>

              <div id="map-match-interval" class="mb-3 d-none">
                <label class="form-label" for="map-match-interval-select">Interval</label>
                <select id="map-match-interval-select" class="form-select">
                  <option value="1">Last Day</option>
                  <option value="3">Last 3 Days</option>
                  <option value="7">Last Week</option>
                  <option value="30">Last Month</option>
                  <option value="90">Last 3 Months</option>
                  <option value="180">Last 6 Months</option>
                  <option value="365">Last Year</option>
                  <option value="730">Last 2 Years</option>
                </select>
              </div>

              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="map-match-unmatched-only" checked />
                <label class="form-check-label" for="map-match-unmatched-only">
                  Only map match unmatched trips
                </label>
              </div>
            </div>

            <div id="map-match-trip-controls" class="d-none mb-3">
              <label class="form-label" for="map-match-trip-id">Trip ID</label>
              <input type="text" id="map-match-trip-id" class="form-control" placeholder="transactionId" />
            </div>

            <div class="wizard-step mt-4">
              <span class="step-pill">2</span>
              <span>Preview what will be matched</span>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
              <button type="button" class="btn btn-outline-secondary" id="map-match-preview-btn">
                <i class="fas fa-search"></i>
                Preview Trips
              </button>
              <span class="settings-status is-hidden" id="map-match-preview-status" role="status"></span>
            </div>
            <div id="map-match-preview-panel" class="preview-panel d-none">
              <div class="preview-summary" id="map-match-preview-summary"></div>
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Trip ID</th>
                      <th>Start</th>
                      <th>End</th>
                      <th>Distance</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="map-match-preview-body"></tbody>
                </table>
              </div>
            </div>

            <div class="wizard-step mt-4">
              <span class="step-pill">3</span>
              <span>Ready? Let's go!</span>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <button type="submit" class="btn btn-primary" id="map-match-submit" disabled>
                <i class="fas fa-play"></i>
                Start Map Matching
              </button>
              <span class="settings-status is-hidden" id="map-match-submit-status" role="status"></span>
            </div>
          </form>
        </div>
      </div>

      <div class="bento-span-5 widget map-matching-progress" data-accent="amber">
        <div class="widget-header">
          <div>
            <h2 class="widget-title">
              <i class="fas fa-spinner" aria-hidden="true"></i>
              Progress
            </h2>
            <div class="widget-meta">
              Watch your trips get matched in real time.
            </div>
          </div>
        </div>
        <div class="widget-body">
          <div id="map-match-current-empty" class="empty-state">
            Nothing running yet
          </div>
          <div id="map-match-current-panel" class="d-none">
            <div class="progress mb-2" style="height: 22px">
              <div id="map-match-progress-bar"
                   class="progress-bar progress-bar-striped progress-bar-animated"
                   role="progressbar"
                   style="width: 0%">
                0%
              </div>
            </div>
            <div id="map-match-progress-message" class="small mb-2"></div>
            <div id="map-match-progress-metrics" class="small text-muted"></div>
          </div>
        </div>
      </div>

      <div class="bento-span-12 widget map-matching-history" data-accent="slate">
        <div class="widget-header">
          <div>
            <h2 class="widget-title">
              <i class="fas fa-clock" aria-hidden="true"></i>
              History
            </h2>
            <div class="widget-meta">
              Your recent matching activity.
            </div>
          </div>
          <div class="map-matching-history-actions">
            <button class="btn btn-outline-secondary btn-sm" id="map-match-refresh">
              <i class="fas fa-sync"></i>
              Refresh
            </button>
            <button class="btn btn-outline-secondary btn-sm" id="map-match-history-clear">
              <i class="fas fa-broom"></i>
              Clear History
            </button>
            <span class="settings-status is-hidden" id="map-match-history-status" role="status"></span>
          </div>
        </div>
        <div class="widget-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th>Job ID</th>
                  <th>Status</th>
                  <th>Progress</th>
                  <th>Updated</th>
                  <th>Message</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="map-match-jobs-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="bento-span-12 widget map-matching-preview" data-accent="sky">
        <div class="widget-header">
          <div>
            <h2 class="widget-title">
              <i class="fas fa-map-marked-alt" aria-hidden="true"></i>
              Results Preview
            </h2>
            <div class="widget-meta">
              See your matched routes on the map.
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <button class="btn btn-outline-secondary btn-sm" id="map-match-preview-map-btn">
              <i class="fas fa-search-location"></i>
              Load Preview
            </button>
            <span class="settings-status is-hidden" id="map-match-preview-map-status" role="status"></span>
          </div>
        </div>
        <div class="widget-body">
          <div class="matched-preview-grid">
            <div class="matched-preview-map-card">
              <div class="matched-preview-map" id="map-match-preview-map" aria-label="Matched trips preview map"></div>
              <div id="map-match-preview-map-empty" class="matched-preview-empty">
                Select a completed job to see matched routes
              </div>
              <div class="matched-preview-legend">
                <span class="legend-swatch"></span>
                Matched path
              </div>
            </div>
            <div class="matched-preview-list">
              <div class="preview-summary" id="map-match-preview-map-summary">
                No results to show yet
              </div>
              <div class="matched-preview-controls">
                <div class="matched-preview-selection">
                  <label class="form-check form-check-inline matched-preview-select-all">
                    <input class="form-check-input" type="checkbox" id="map-match-preview-select-all" />
                    <span class="form-check-label">Select all</span>
                  </label>
                  <span class="matched-preview-count" id="map-match-preview-selection-count">0 selected</span>
                  <button class="btn btn-outline-secondary btn-sm" id="map-match-preview-clear-selection" disabled>
                    Clear selection
                  </button>
                </div>
                <div class="matched-preview-actions">
                  <button class="btn btn-outline-secondary btn-sm" id="map-match-preview-unmatch-selected" disabled>
                    Clear match
                  </button>
                  <button class="btn btn-outline-danger btn-sm" id="map-match-preview-delete-selected" disabled>
                    Delete trips
                  </button>
                  <span class="settings-status is-hidden" id="map-match-preview-actions-status" role="status"></span>
                </div>
                <div class="matched-preview-note">
                  Clearing a match keeps the trip but removes the snapped route.
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead>
                    <tr>
                      <th class="matched-preview-select-col"></th>
                      <th>Trip ID</th>
                      <th>Matched</th>
                      <th>Distance</th>
                      <th>Status</th>
                      <th class="matched-preview-actions-col">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="map-match-preview-map-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="{{ CDN.mapbox_gl_js }}"></script>
  <script type="module"
          src="{{ url_for('static', path='js/pages/map-matching.js') | replace('http://', '//') }}"></script>
{% endblock %}
