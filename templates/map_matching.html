{% extends "base.html" %}

{% block title %}
Every Street - Route Improvement
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ CDN.mapbox_gl_css }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', path='css/map-matching.css') | replace('http://', '//') }}" />
{% endblock %}

{% block head_content %}
  <meta name="mapbox-access-token" content="{{ MAPBOX_ACCESS_TOKEN }}" />
  <script>
      window.MAPBOX_ACCESS_TOKEN = "{{ MAPBOX_ACCESS_TOKEN }}";
      document.dispatchEvent(
          new CustomEvent("es:mapbox-token-ready", {
              detail: {
                  token: window.MAPBOX_ACCESS_TOKEN
              },
          }),
      );
  </script>
{% endblock %}

{% block content %}
  <div class="container-fluid px-4 py-3 map-matching-page">
    <div class="bento-grid" data-stagger>
      <!-- Hero Section - Friendly Introduction -->
      <div class="bento-span-12 widget map-matching-hero" data-accent="mint">
        <div class="widget-header">
          <div class="hero-content">
            <h1 class="widget-title">
              <i class="fas fa-magic" aria-hidden="true"></i>
              Improve Your Routes
            </h1>
            <p class="hero-description">
              GPS signals can be imprecise, causing your trips to appear off-road or jagged.
              Route improvement automatically snaps your trips to actual roads for cleaner,
              more accurate coverage tracking.
            </p>
          </div>
          <div class="hero-visual">
            <div class="before-after">
              <div class="visual-item">
                <span class="visual-label">Before</span>
                <svg class="route-svg" viewBox="0 0 80 50" aria-hidden="true">
                  <path class="route-jagged" d="M5,25 L15,20 L20,30 L30,22 L35,28 L45,18 L55,32 L65,24 L75,26" />
                </svg>
              </div>
              <div class="visual-arrow">
                <i class="fas fa-arrow-right"></i>
              </div>
              <div class="visual-item">
                <span class="visual-label">After</span>
                <svg class="route-svg" viewBox="0 0 80 50" aria-hidden="true">
                  <path class="route-smooth" d="M5,25 Q40,15 75,25" />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Action Card - Simplified -->
      <div class="bento-span-7 widget map-matching-form" data-accent="mint">
        <div class="widget-header">
          <div>
            <h2 class="widget-title">
              <i class="fas fa-route" aria-hidden="true"></i>
              Ready to Improve
            </h2>
            <div class="widget-meta">
              Select which trips to process
            </div>
          </div>
        </div>
        <div class="widget-body">
          <form id="map-matching-form">
            <!-- Simple Selection -->
            <div class="selection-cards" id="map-match-selection-cards">
              <label class="selection-card is-selected" data-mode="unmatched">
                <input type="radio" name="match-mode" value="unmatched" checked class="visually-hidden" />
                <div class="selection-card-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="selection-card-content">
                  <span class="selection-card-title">Pending trips</span>
                  <span class="selection-card-desc">All trips that haven't been improved yet</span>
                </div>
                <div class="selection-card-check">
                  <i class="fas fa-check"></i>
                </div>
              </label>

              <label class="selection-card" data-mode="date_range">
                <input type="radio" name="match-mode" value="date_range" class="visually-hidden" />
                <div class="selection-card-icon">
                  <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="selection-card-content">
                  <span class="selection-card-title">By date range</span>
                  <span class="selection-card-desc">Choose specific dates to process</span>
                </div>
                <div class="selection-card-check">
                  <i class="fas fa-check"></i>
                </div>
              </label>
            </div>

            <!-- Hidden select for JS compatibility -->
            <select id="map-match-mode" class="visually-hidden" aria-hidden="true">
              <option value="unmatched">Unmatched trips</option>
              <option value="date_range">Date range</option>
              <option value="trip_id">Specific trip</option>
            </select>

            <!-- Date Range Options (shown when date_range selected) -->
            <div id="map-match-date-controls" class="date-options d-none">
              <div class="date-quick-picks">
                <span class="quick-picks-label">Quick select:</span>
                <div class="quick-picks-buttons">
                  <button type="button" class="quick-pick-btn" data-days="7">Last week</button>
                  <button type="button" class="quick-pick-btn" data-days="30">Last month</button>
                  <button type="button" class="quick-pick-btn" data-days="90">Last 3 months</button>
                  <button type="button" class="quick-pick-btn" data-days="365">Last year</button>
                </div>
              </div>

              <div class="date-custom">
                <span class="date-custom-label">Or choose dates:</span>
                <div class="date-inputs">
                  <input type="text" id="map-match-start" class="form-control datepicker" placeholder="Start date" />
                  <span class="date-separator">to</span>
                  <input type="text" id="map-match-end" class="form-control datepicker" placeholder="End date" />
                </div>
              </div>

              <div class="form-check form-switch reprocess-option">
                <input class="form-check-input" type="checkbox" role="switch" id="map-match-unmatched-only" checked />
                <label class="form-check-label" for="map-match-unmatched-only">
                  Only process trips not yet improved
                </label>
              </div>
            </div>

            <!-- Hidden elements for legacy JS compatibility -->
            <select id="map-match-date-mode" class="visually-hidden" aria-hidden="true">
              <option value="interval" selected>Interval</option>
              <option value="date">Date range</option>
            </select>
            <select id="map-match-interval-select" class="visually-hidden" aria-hidden="true">
              <option value="7">Last Week</option>
              <option value="30">Last Month</option>
              <option value="90">Last 3 Months</option>
              <option value="365">Last Year</option>
            </select>
            <div id="map-match-date-range" class="d-none"></div>
            <div id="map-match-interval" class="d-none"></div>

            <!-- Advanced: Specific Trip (hidden by default) -->
            <div id="map-match-trip-controls" class="d-none">
              <label class="form-label" for="map-match-trip-id">Trip ID</label>
              <input type="text" id="map-match-trip-id" class="form-control" placeholder="Enter trip ID" />
            </div>

            <!-- Preview Section (simplified) -->
            <div id="map-match-preview-panel" class="preview-panel d-none">
              <div class="preview-header">
                <span class="preview-icon"><i class="fas fa-list-check"></i></span>
                <span class="preview-summary" id="map-match-preview-summary"></span>
              </div>
              <div class="preview-trips-mini" id="map-match-preview-body-container">
                <div class="preview-trips-scroll">
                  <table class="preview-table-mini">
                    <tbody id="map-match-preview-body"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Main Actions -->
            <div class="form-actions">
              <button type="button" class="btn btn-outline-secondary btn-preview" id="map-match-preview-btn">
                <i class="fas fa-eye"></i>
                Preview
              </button>
              <button type="submit" class="btn btn-primary btn-start" id="map-match-submit">
                <i class="fas fa-sparkles"></i>
                Improve Routes
              </button>
            </div>
            <div class="form-status">
              <span class="settings-status is-hidden" id="map-match-preview-status" role="status"></span>
              <span class="settings-status is-hidden" id="map-match-submit-status" role="status"></span>
            </div>

            <!-- Advanced Toggle -->
            <button type="button" class="advanced-toggle" id="map-match-advanced-toggle">
              <i class="fas fa-sliders"></i>
              <span>Advanced options</span>
              <i class="fas fa-chevron-down toggle-arrow"></i>
            </button>
            <div class="advanced-options d-none" id="map-match-advanced-options">
              <label class="selection-card selection-card-small" data-mode="trip_id">
                <input type="radio" name="match-mode" value="trip_id" class="visually-hidden" />
                <div class="selection-card-icon">
                  <i class="fas fa-fingerprint"></i>
                </div>
                <div class="selection-card-content">
                  <span class="selection-card-title">Specific trip</span>
                  <span class="selection-card-desc">Process a single trip by ID</span>
                </div>
                <div class="selection-card-check">
                  <i class="fas fa-check"></i>
                </div>
              </label>
            </div>
          </form>
        </div>
      </div>

      <!-- Progress Widget - Friendly -->
      <div class="bento-span-5 widget map-matching-progress" data-accent="amber">
        <div class="widget-header">
          <div>
            <h2 class="widget-title">
              <i class="fas fa-bolt" aria-hidden="true"></i>
              Progress
            </h2>
          </div>
        </div>
        <div class="widget-body">
          <div id="map-match-current-empty" class="empty-state">
            <div class="empty-icon">
              <i class="fas fa-route"></i>
            </div>
            <span class="empty-text">Ready when you are</span>
          </div>
          <div id="map-match-current-panel" class="d-none">
            <div class="progress-visual">
              <div class="progress-ring-container">
                <svg class="progress-ring" viewBox="0 0 100 100">
                  <circle class="progress-ring-bg" cx="50" cy="50" r="42" />
                  <circle class="progress-ring-fill" cx="50" cy="50" r="42" id="map-match-progress-ring" />
                </svg>
                <div class="progress-ring-text">
                  <span class="progress-percent" id="map-match-progress-percent">0%</span>
                </div>
              </div>
            </div>
            <div class="progress-info">
              <div id="map-match-progress-message" class="progress-message">Starting...</div>
              <div id="map-match-progress-metrics" class="progress-metrics"></div>
            </div>
            <!-- Hidden legacy progress bar for JS compatibility -->
            <div class="progress d-none" style="height: 22px">
              <div id="map-match-progress-bar"
                   class="progress-bar progress-bar-striped progress-bar-animated"
                   role="progressbar"
                   style="width: 0%">
                0%
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity (collapsed history) -->
      <div class="bento-span-12 widget map-matching-history" data-accent="slate">
        <div class="widget-header widget-header-collapsible" id="map-match-history-toggle">
          <div class="history-header-content">
            <h2 class="widget-title">
              <i class="fas fa-history" aria-hidden="true"></i>
              Recent Activity
            </h2>
            <span class="history-badge" id="map-match-history-count">0</span>
          </div>
          <div class="history-header-actions">
            <button class="btn btn-ghost btn-sm" id="map-match-refresh" title="Refresh">
              <i class="fas fa-sync"></i>
            </button>
            <button class="btn btn-ghost btn-sm" id="map-match-history-clear" title="Clear completed">
              <i class="fas fa-trash-alt"></i>
            </button>
            <i class="fas fa-chevron-down history-chevron"></i>
            <span class="settings-status is-hidden" id="map-match-history-status" role="status"></span>
          </div>
        </div>
        <div class="widget-body history-body" id="map-match-history-body">
          <div class="history-list" id="map-match-jobs-list">
            <!-- Jobs will be rendered here as cards, not a table -->
          </div>
          <!-- Hidden table for JS compatibility -->
          <table class="d-none">
            <tbody id="map-match-jobs-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Results Preview - Map Focused -->
      <div class="bento-span-12 widget map-matching-preview" data-accent="sky">
        <div class="widget-header">
          <div>
            <h2 class="widget-title">
              <i class="fas fa-map" aria-hidden="true"></i>
              Improved Routes
            </h2>
            <div class="widget-meta" id="map-match-preview-map-summary">
              Complete a job above to see your improved routes
            </div>
          </div>
          <div class="results-actions">
            <button class="btn btn-outline-secondary btn-sm" id="map-match-preview-map-btn">
              <i class="fas fa-sync"></i>
              Refresh
            </button>
            <span class="settings-status is-hidden" id="map-match-preview-map-status" role="status"></span>
          </div>
        </div>
        <div class="widget-body">
          <div class="results-layout">
            <!-- Map Side -->
            <div class="results-map-container">
              <div class="results-map" id="map-match-preview-map" aria-label="Improved routes map"></div>
              <div id="map-match-preview-map-empty" class="results-map-empty">
                <div class="empty-map-content">
                  <i class="fas fa-map-marked-alt"></i>
                  <span>Your improved routes will appear here</span>
                </div>
              </div>
              <div class="results-map-legend">
                <span class="legend-dot"></span>
                <span>Improved route</span>
              </div>
            </div>

            <!-- Trips List Side -->
            <div class="results-list-container">
              <div class="results-list-header">
                <span class="results-count" id="map-match-results-count">No trips yet</span>
                <div class="results-bulk-actions d-none" id="map-match-bulk-actions">
                  <span class="bulk-count" id="map-match-preview-selection-count">0 selected</span>
                  <button class="btn btn-ghost btn-sm" id="map-match-preview-clear-selection" disabled title="Clear selection">
                    <i class="fas fa-times"></i>
                  </button>
                  <button class="btn btn-ghost btn-sm" id="map-match-preview-unmatch-selected" disabled title="Remove improvement">
                    <i class="fas fa-undo"></i>
                  </button>
                  <button class="btn btn-ghost btn-sm text-danger" id="map-match-preview-delete-selected" disabled title="Delete trips">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="results-list-scroll">
                <div class="results-trips" id="map-match-results-trips">
                  <!-- Trip cards will be rendered here -->
                </div>
                <!-- Hidden table for JS compatibility -->
                <table class="d-none">
                  <thead>
                    <tr>
                      <th class="matched-preview-select-col"></th>
                      <th>Trip ID</th>
                      <th>Matched</th>
                      <th>Distance</th>
                      <th>Status</th>
                      <th class="matched-preview-actions-col">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="map-match-preview-map-body"></tbody>
                </table>
              </div>
              <div class="results-list-footer" id="map-match-results-footer">
                <label class="select-all-toggle">
                  <input type="checkbox" id="map-match-preview-select-all" class="form-check-input" />
                  <span>Select all</span>
                </label>
                <span class="settings-status is-hidden" id="map-match-preview-actions-status" role="status"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="{{ CDN.mapbox_gl_js }}"></script>
  <script type="module"
          src="{{ url_for('static', path='js/pages/map-matching.js') | replace('http://', '//') }}"></script>
{% endblock %}
