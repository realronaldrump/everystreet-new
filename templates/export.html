{% extends "base.html" %}

{% block title %}

Every Street - Export Data
{% endblock %}


{% block extra_css %}

  <link rel="stylesheet"
        href="{{ url_for('static', path='css/export.css') | replace('http://', '//') }}" />
{% endblock %}



{% block content %}

  <div class="export-page">
    <div class="bento-grid" data-stagger>
      <!-- Header Widget -->
      <div class="bento-span-12 widget" data-accent="mint">
        <div class="widget-header">
          <div>
            <h1 class="widget-title">
              <i class="fas fa-file-export" aria-hidden="true"></i>
              Export Data
            </h1>
            <div class="widget-meta">
              Export trips, coverage data, and boundaries in multiple formats.
            </div>
          </div>
          <div class="export-hero-meta">
            <div class="meta-label">
Output Format
            </div>
            <div class="meta-value">
Zip bundle with manifest.json
            </div>
          </div>
        </div>
      </div>

      <!-- Main Configuration Panel -->
      <div class="bento-span-8 widget" data-accent="purple">
        <div class="widget-header">
          <h2 class="widget-title">
            <i class="fas fa-sliders-h" aria-hidden="true"></i>
            Export Configuration
          </h2>
        </div>
        <div class="widget-body">
          <form id="export-form">
            <!-- Trip Data Section -->
            <div class="export-section-card">
              <div class="export-section-title">
                <i class="fas fa-route"></i>
                Trip Data
              </div>

              <div class="export-options-grid">
                <label class="export-option-card" id="trips-option">
                  <input type="checkbox" id="export-trips" checked />
                  <div class="export-option-check">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="export-option-header">
                    <div class="export-option-icon">
                      <i class="fas fa-car"></i>
                    </div>
                    <div class="export-option-title">
Trips
                    </div>
                  </div>
                  <div class="export-option-desc">
                    Raw GPS trips as stored in database.
                  </div>
                </label>

                <label class="export-option-card" id="matched-trips-option">
                  <input type="checkbox" id="export-matched-trips" />
                  <div class="export-option-check">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="export-option-header">
                    <div class="export-option-icon">
                      <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <div class="export-option-title">
Matched Trips
                    </div>
                  </div>
                  <div class="export-option-desc">
                    Trips with map-matched geometry.
                  </div>
                </label>
              </div>

              <div class="export-toggle-row" style="margin-top: var(--space-4);">
                <div class="export-toggle-label">
                  <div class="export-toggle-title">
Export Format
                  </div>
                </div>
                <div class="format-selector">
                  <label class="format-pill">
                    <input type="radio" name="trip-format-radio" value="json" checked />
                    JSON
                  </label>
                  <label class="format-pill">
                    <input type="radio" name="trip-format-radio" value="csv" />
                    CSV
                  </label>
                  <label class="format-pill">
                    <input type="radio" name="trip-format-radio" value="geojson" />
                    GeoJSON
                  </label>
                  <label class="format-pill">
                    <input type="radio" name="trip-format-radio" value="gpx" />
                    GPX
                  </label>
                </div>
                <!-- Hidden select for JS compatibility -->
                <select class="d-none" id="trip-format">
                  <option value="json" selected>
JSON
                  </option>
                  <option value="csv">
CSV
                  </option>
                  <option value="geojson">
GeoJSON
                  </option>
                  <option value="gpx">
GPX
                  </option>
                </select>
              </div>

              <div class="export-toggle-row">
                <div class="export-toggle-label">
                  <div class="export-toggle-title">
Include Geometry
                  </div>
                  <div class="export-toggle-desc">
Include coordinates in JSON/CSV exports
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="include-trip-geometry" checked />
                </div>
              </div>
            </div>

            <!-- Trip Filters Section -->
            <div class="export-section-card">
              <div class="export-section-title">
                <i class="fas fa-filter"></i>
                Trip Filters
              </div>

              <div class="export-filters">
                <div class="export-filter-group">
                  <label class="export-filter-label" for="trip-start-date">
Start Date
                  </label>
                  <input type="date" class="export-filter-control" id="trip-start-date" />
                </div>
                <div class="export-filter-group">
                  <label class="export-filter-label" for="trip-end-date">
End Date
                  </label>
                  <input type="date" class="export-filter-control" id="trip-end-date" />
                </div>
                <div class="export-filter-group">
                  <label class="export-filter-label" for="trip-status">
Status
                  </label>
                  <select class="export-filter-control" id="trip-status">
                    <option value="">
All statuses
                    </option>
                    <option value="processed">
Processed
                    </option>
                    <option value="completed">
Completed
                    </option>
                    <option value="active">
Active
                    </option>
                  </select>
                </div>
                <div class="export-filter-group">
                  <label class="export-filter-label" for="trip-vehicle">
Vehicle
                  </label>
                  <input class="export-filter-control"
                         id="trip-vehicle"
                         list="vehicle-options"
                         placeholder="All vehicles" />
                  <datalist id="vehicle-options"></datalist>
                </div>
              </div>

              <div class="export-toggle-row">
                <div class="export-toggle-label">
                  <div class="export-toggle-title">
All Time
                  </div>
                  <div class="export-toggle-desc">
Ignore date range filters
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="trip-all-time" />
                </div>
              </div>

              <div class="export-toggle-row">
                <div class="export-toggle-label">
                  <div class="export-toggle-title">
Include Invalid Trips
                  </div>
                  <div class="export-toggle-desc">
Include trips marked as invalid
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="trip-include-invalid" />
                </div>
              </div>
            </div>

            <!-- Coverage Data Section -->
            <div class="export-section-card">
              <div class="export-section-title">
                <i class="fas fa-map"></i>
                Coverage Data
              </div>

              <div class="export-options-grid">
                <label class="export-option-card" id="streets-option">
                  <input type="checkbox" id="export-streets" />
                  <div class="export-option-check">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="export-option-header">
                    <div class="export-option-icon">
                      <i class="fas fa-road"></i>
                    </div>
                    <div class="export-option-title">
Streets
                    </div>
                  </div>
                  <div class="export-option-desc">
                    All street segments with status.
                  </div>
                </label>

                <label class="export-option-card" id="boundaries-option">
                  <input type="checkbox" id="export-boundaries" />
                  <div class="export-option-check">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="export-option-header">
                    <div class="export-option-icon">
                      <i class="fas fa-draw-polygon"></i>
                    </div>
                    <div class="export-option-title">
Boundary
                    </div>
                  </div>
                  <div class="export-option-desc">
                    Area polygon boundary.
                  </div>
                </label>

                <label class="export-option-card" id="undriven-option">
                  <input type="checkbox" id="export-undriven" />
                  <div class="export-option-check">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="export-option-header">
                    <div class="export-option-icon">
                      <i class="fas fa-route"></i>
                    </div>
                    <div class="export-option-title">
Undriven Streets
                    </div>
                  </div>
                  <div class="export-option-desc">
                    Only undriven segments.
                  </div>
                </label>
              </div>

              <div class="export-toggle-row" style="margin-top: var(--space-4);">
                <div class="export-toggle-label">
                  <div class="export-toggle-title">
Coverage Area
                  </div>
                  <div class="export-toggle-desc">
Required for coverage exports
                  </div>
                </div>
                <select class="export-filter-control" id="coverage-area" style="min-width: 200px;">
                  <option value="">
Select an area
                  </option>
                </select>
              </div>

              <div class="text-secondary small" style="margin-top: var(--space-3);">
                <i class="fas fa-info-circle me-1"></i>
                Coverage exports are always in GeoJSON format.
              </div>
            </div>

            <!-- Actions -->
            <div class="export-actions">
              <div class="export-error hidden" role="alert" id="export-error">
                <i class="fas fa-exclamation-circle"></i>
                <span id="export-error-text"></span>
              </div>
              <div class="export-actions-primary">
                <button type="submit" class="export-btn export-btn-primary" id="export-submit">
                  <i class="fas fa-download"></i>
                  Create Export
                </button>
                <button type="button" class="export-btn export-btn-secondary" id="export-reset">
                  <i class="fas fa-undo"></i>
                  Reset
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Status Panel -->
      <div class="bento-span-4 widget" data-accent="sky">
        <div class="widget-header">
          <h2 class="widget-title">
            <i class="fas fa-signal" aria-hidden="true"></i>
            Export Status
          </h2>
        </div>
        <div class="widget-body">
          <div class="export-summary">
            <div class="export-summary-title">
Selected Items
            </div>
            <ul class="export-summary-list" id="export-summary-list">
              <li class="empty">
No items selected yet.
              </li>
            </ul>
          </div>

          <div class="export-progress" id="export-progress">
            <div class="export-progress-header">
              <span class="export-progress-text" id="export-status-text">No export running</span>
              <span class="export-progress-percent" id="export-progress-percent">0%</span>
            </div>
            <div class="export-progress-bar-container">
              <div class="export-progress-bar" id="export-progress-bar" style="width: 0%">
              </div>
            </div>
          </div>

          <div class="export-result" id="export-result">
            <div class="export-result-title">
Latest Export
            </div>
            <div class="export-result-details" id="export-result-details">
              No export generated yet.
            </div>
            <a class="export-download-btn d-none" id="export-download" href="#">
              <i class="fas fa-file-archive"></i>
              Download Zip
            </a>
          </div>
        </div>
      </div>

      </div>
    </div>
  </div>
{% endblock %}



{% block extra_js %}

  <script type="module"
          src="{{ url_for('static', path='js/modules/export/index.js') | replace('http://', '//') }}"></script>
  <script>
      // Sync radio buttons to hidden select for JS compatibility
      document.querySelectorAll('input[name="trip-format-radio"]').forEach(radio => {
          radio.addEventListener('change', () => {
              document.getElementById('trip-format').value = radio.value;
              document.getElementById('trip-format').dispatchEvent(new Event('change'));
          });
      });

      // Toggle selected state on option cards
      document.querySelectorAll('.export-option-card input[type="checkbox"]').forEach(checkbox => {
          const card = checkbox.closest('.export-option-card');
          const updateState = () => {
              card.classList.toggle('selected', checkbox.checked);
          };
          checkbox.addEventListener('change', updateState);
          updateState();
      });

      // Update format pill active states
      document.querySelectorAll('.format-pill input').forEach(radio => {
          const pill = radio.closest('.format-pill');
          const updateState = () => {
              document.querySelectorAll('.format-pill').forEach(p => p.classList.remove('active'));
              if (radio.checked) pill.classList.add('active');
          };
          radio.addEventListener('change', updateState);
          updateState();
      });
  </script>
{% endblock %}
