{% extends "base.html" %} {% block title %}Every Street - Map{% endblock %} {%
block extra_css %} {% endblock %} {% block content %}
<div class="map-wrapper d-flex flex-column flex-grow-1">
  <!-- Map Container -->
  <div
    id="map"
    class="flex-grow-1 position-relative"
    role="application"
    aria-label="Interactive map"
  >
    <!-- Loading indicator -->
    <div id="map-loading-indicator" class="map-loading d-none">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading map...</span>
      </div>
      <span class="map-loading-text ms-2">Loading map...</span>
    </div>

    <!-- Modern floating control panel -->
    <div
      id="map-controls"
      class="control-panel shadow-lg position-absolute"
      role="region"
      aria-label="Map controls"
    >
      <!-- Panel Header -->
      <div class="control-panel-header">
        <h2 class="control-panel-title">
          <i class="fas fa-layer-group me-2" aria-hidden="true"></i>
          Map Controls
        </h2>
        <button
          id="controls-toggle"
          class="btn btn-sm btn-icon-only"
          aria-label="Toggle Controls"
          aria-expanded="true"
          aria-controls="controls-content"
          title="Collapse panel"
        >
          <i class="fas fa-chevron-down" aria-hidden="true"></i>
        </button>
      </div>

      <div id="controls-content" class="collapse show control-panel-body">
        <!-- Quick Actions Bar -->
        <div class="quick-actions-bar">
          <button
            type="button"
            class="btn-quick-action"
            id="center-on-location"
            title="Center on my location"
            aria-label="Center map on current location"
          >
            <i class="fas fa-location-crosshairs" aria-hidden="true"></i>
          </button>
          <button
            type="button"
            class="btn-quick-action"
            id="fit-bounds"
            title="Fit all trips"
            aria-label="Fit all trips in view"
          >
            <i class="fas fa-expand-arrows-alt" aria-hidden="true"></i>
          </button>
          <button
            type="button"
            class="btn-quick-action"
            id="refresh-map"
            title="Refresh map data"
            aria-label="Refresh map data"
          >
            <i class="fas fa-sync-alt" aria-hidden="true"></i>
          </button>
          <button
            type="button"
            class="btn-quick-action"
            id="download-view"
            title="Download current view"
            aria-label="Download current map view"
          >
            <i class="fas fa-download" aria-hidden="true"></i>
          </button>
        </div>

        <div class="control-sections">
          <!-- Search Section -->
          <div class="control-section">
            <div class="search-container">
              <div class="position-relative">
                <i class="fas fa-search search-icon" aria-hidden="true"></i>
                <input
                  type="text"
                  id="map-search-input"
                  class="form-control search-input"
                  placeholder="Search places, addresses..."
                  autocomplete="off"
                  aria-label="Search map"
                />
                <button
                  id="clear-search-btn"
                  class="btn btn-sm btn-link btn-clear-search d-none"
                  aria-label="Clear search"
                  title="Clear search"
                >
                  <i class="fas fa-times" aria-hidden="true"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Live Tracking Section -->
          <div class="control-section" id="live-tracking-panel">
            <button
              class="section-header"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#live-tracking-content"
              aria-expanded="false"
              aria-controls="live-tracking-content"
            >
              <div class="section-header-left">
                <i
                  class="fas fa-broadcast-tower section-icon"
                  aria-hidden="true"
                ></i>
                <h3 class="section-title">Live Tracking</h3>
              </div>
              <div class="section-header-right">
                <div class="connection-status">
                  <div
                    class="status-indicator"
                    role="status"
                    aria-live="polite"
                  ></div>
                  <span class="live-status-text">Connecting...</span>
                </div>
                <i
                  class="fas fa-chevron-down section-chevron"
                  aria-hidden="true"
                ></i>
              </div>
            </button>
            <div id="live-tracking-content" class="collapse section-body">
              <div class="live-tracking-info">
                <div
                  class="d-flex align-items-center justify-content-between mb-2"
                >
                  <span class="text-secondary">Active Trips</span>
                  <span
                    id="active-trips-count"
                    class="badge bg-primary rounded-pill"
                    aria-live="polite"
                    >0</span
                  >
                </div>
                <div class="live-trip-metrics">
                  <!-- Trip metrics will be inserted here dynamically -->
                </div>
                <div
                  class="error-message alert alert-danger d-none mt-2 p-2"
                  role="alert"
                  aria-live="assertive"
                >
                  <!-- Error messages will be shown here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Layers & Display Section -->
          <div class="control-section">
            <button
              class="section-header"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#layers-content"
              aria-expanded="true"
              aria-controls="layers-content"
            >
              <div class="section-header-left">
                <i class="fas fa-layers section-icon" aria-hidden="true"></i>
                <h3 class="section-title">Layers & Display</h3>
              </div>
              <i
                class="fas fa-chevron-down section-chevron"
                aria-hidden="true"
              ></i>
            </button>
            <div id="layers-content" class="collapse show section-body">
              <!-- Layer Toggles -->
              <div class="layer-group mb-3">
                <h4 class="layer-group-title">Visible Layers</h4>
                <div
                  id="layer-toggles"
                  class="layer-toggles-grid"
                  role="group"
                  aria-label="Layer toggles"
                >
                  <!-- Layer toggles inserted by JavaScript -->
                </div>
              </div>

              <!-- Street Coverage -->
              <div class="layer-group mb-3" id="location-selector-container">
                <h4 class="layer-group-title">Street Coverage</h4>
                <select
                  id="streets-location"
                  class="form-select form-select-sm mb-2"
                  aria-label="Select coverage location"
                >
                  <option value="">Select a location...</option>
                  <!-- Coverage areas will be loaded here -->
                </select>

                <!-- Street View Mode Selector -->
                <div
                  class="street-mode-buttons"
                  role="group"
                  aria-label="Street view mode"
                >
                  <button
                    type="button"
                    class="street-mode-btn"
                    data-street-mode="undriven"
                    title="Show undriven streets (dashed blue lines)"
                  >
                    <i class="fas fa-road" aria-hidden="true"></i>
                    <span>Undriven</span>
                  </button>
                  <button
                    type="button"
                    class="street-mode-btn"
                    data-street-mode="driven"
                    title="Show driven streets (solid green lines)"
                  >
                    <i class="fas fa-check-circle" aria-hidden="true"></i>
                    <span>Driven</span>
                  </button>
                  <button
                    type="button"
                    class="street-mode-btn"
                    data-street-mode="all"
                    title="Show all streets (single overlay)"
                  >
                    <i class="fas fa-layer-group" aria-hidden="true"></i>
                    <span>All</span>
                  </button>
                </div>

                <!-- Color legend -->
                <div class="street-legend">
                  <div class="legend-item">
                    <span
                      class="legend-indicator legend-indicator--undriven"
                    ></span>
                    <span>Undriven</span>
                  </div>
                  <div class="legend-item">
                    <span
                      class="legend-indicator legend-indicator--driven"
                    ></span>
                    <span>Driven</span>
                  </div>
                  <div class="legend-item">
                    <span class="legend-indicator legend-indicator--all"></span>
                    <span>All</span>
                  </div>
                </div>
              </div>

              <!-- Display Options -->
              <div class="layer-group">
                <div class="mb-3">
                  <label
                    for="map-type-select"
                    class="form-label small text-secondary mb-1"
                  >
                    Map Style
                  </label>
                  <select
                    id="map-type-select"
                    class="form-select form-select-sm"
                    aria-label="Select map style"
                  >
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="satellite">Satellite</option>
                    <option value="streets">Streets</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label
                    for="basemap-opacity-range"
                    class="form-label small text-secondary mb-1"
                  >
                    Basemap Opacity
                  </label>
                  <input
                    type="range"
                    class="form-range"
                    id="basemap-opacity-range"
                    min="0"
                    max="1"
                    step="0.05"
                    value="0.75"
                    aria-label="Basemap opacity"
                  />
                  <div
                    class="d-flex justify-content-between small text-secondary"
                  >
                    <span>Transparent</span>
                    <span>Opaque</span>
                  </div>
                </div>
                <div class="custom-switch">
                  <input
                    class="custom-switch-input"
                    type="checkbox"
                    role="switch"
                    id="highlight-recent-trips"
                    checked
                  />
                  <label
                    class="custom-switch-label"
                    for="highlight-recent-trips"
                  >
                    <span class="switch-text">Highlight Recent Trips</span>
                    <span class="switch-help">Last 6 hours</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Statistics Section -->
          <div class="control-section">
            <button
              class="section-header"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#metrics-content"
              aria-expanded="false"
              aria-controls="metrics-content"
            >
              <div class="section-header-left">
                <i class="fas fa-chart-bar section-icon" aria-hidden="true"></i>
                <h3 class="section-title">Trip Statistics</h3>
              </div>
              <i
                class="fas fa-chevron-down section-chevron"
                aria-hidden="true"
              ></i>
            </button>
            <div id="metrics-content" class="collapse section-body">
              <div class="metrics-grid">
                <div class="metric-item">
                  <div class="metric-label">Total Trips</div>
                  <div class="metric-value" id="total-trips" aria-live="polite">
                    0
                  </div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Total Distance</div>
                  <div class="metric-value" aria-live="polite">
                    <span id="total-distance">0</span>
                    <span class="metric-unit">mi</span>
                  </div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Avg Distance</div>
                  <div class="metric-value" aria-live="polite">
                    <span id="avg-distance">0</span>
                    <span class="metric-unit">mi</span>
                  </div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Avg Start Time</div>
                  <div
                    class="metric-value"
                    id="avg-start-time"
                    aria-live="polite"
                  >
                    --:--
                  </div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Avg Driving Time</div>
                  <div
                    class="metric-value"
                    id="avg-driving-time"
                    aria-live="polite"
                  >
                    --:--
                  </div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Avg Speed</div>
                  <div class="metric-value" aria-live="polite">
                    <span id="avg-speed">0</span>
                    <span class="metric-unit">mph</span>
                  </div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Max Speed</div>
                  <div class="metric-value" aria-live="polite">
                    <span id="max-speed">0</span>
                    <span class="metric-unit">mph</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Results Dropdown (positioned outside control panel to avoid clipping) -->
    <div
      id="search-results"
      class="search-results-dropdown d-none"
      role="listbox"
      aria-label="Search results"
    ></div>

    <!-- Mobile-specific UI -->
    <!-- Floating Action Buttons -->
    <div class="mobile-fab-container">
      <button
        class="mobile-fab secondary"
        id="mobile-center-location"
        aria-label="Center on location"
      >
        <i class="fas fa-location-arrow"></i>
      </button>
      <button
        class="mobile-fab secondary"
        id="mobile-fit-bounds"
        aria-label="Fit all trips"
      >
        <i class="fas fa-expand-arrows-alt"></i>
      </button>
      <button class="mobile-fab" id="mobile-refresh" aria-label="Refresh map">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>

    <!-- Mobile Bottom Sheet -->
    <div class="mobile-sheet-backdrop"></div>
    <div class="mobile-bottom-sheet collapsed">
      <div class="mobile-sheet-handle-container">
        <div class="mobile-sheet-handle"></div>
      </div>

      <div class="mobile-sheet-header">
        <h2 class="mobile-sheet-title">Map Controls</h2>
        <div class="mobile-sheet-actions">
          <span class="mobile-live-badge" id="mobile-live-status">
            <span class="pulse-dot"></span>
            <span>Live</span>
          </span>
        </div>
      </div>

      <!-- Quick preview in collapsed state -->
      <div class="mobile-sheet-expand-hint">
        <i class="fas fa-chevron-up"></i>
        <span>Tap to expand controls</span>
      </div>

      <div class="mobile-sheet-content">
        <!-- Quick Stats - Visible in collapsed state -->
        <div class="mobile-section">
          <div class="mobile-compact-metrics">
            <div class="mobile-compact-metric">
              <div class="mobile-compact-metric-value" id="mobile-quick-trips">
                0
              </div>
              <div class="mobile-compact-metric-label">Trips</div>
            </div>
            <div class="mobile-compact-metric">
              <div
                class="mobile-compact-metric-value"
                id="mobile-quick-distance"
              >
                0
              </div>
              <div class="mobile-compact-metric-label">Miles</div>
            </div>
            <div class="mobile-compact-metric">
              <div class="mobile-compact-metric-value" id="mobile-quick-speed">
                0
              </div>
              <div class="mobile-compact-metric-label">Avg MPH</div>
            </div>
          </div>
        </div>

        <!-- Search Section -->
        <div class="mobile-section">
          <div class="mobile-search">
            <i class="fas fa-search"></i>
            <input
              type="text"
              id="mobile-map-search"
              placeholder="Search places..."
              autocomplete="off"
            />
            <button
              id="mobile-clear-search"
              class="btn btn-sm btn-link d-none btn-clear-mobile"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Full Stats -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">Quick Stats</h3>
            <a href="/insights" class="mobile-section-action">View All</a>
          </div>
          <div class="mobile-metrics-grid">
            <div class="mobile-metric-card">
              <div class="mobile-metric-value" id="mobile-total-trips">0</div>
              <div class="mobile-metric-label">Trips</div>
            </div>
            <div class="mobile-metric-card">
              <div class="mobile-metric-value" id="mobile-total-distance">
                0
              </div>
              <div class="mobile-metric-label">Miles</div>
            </div>
            <div class="mobile-metric-card">
              <div class="mobile-metric-value" id="mobile-avg-speed">0</div>
              <div class="mobile-metric-label">Avg MPH</div>
            </div>
            <div class="mobile-metric-card">
              <div class="mobile-metric-value" id="mobile-max-speed">0</div>
              <div class="mobile-metric-label">Max MPH</div>
            </div>
          </div>
        </div>

        <!-- Live Tracking -->
        <div class="mobile-section" id="mobile-live-tracking">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">Active Trips</h3>
            <span class="badge bg-primary rounded-pill" id="mobile-active-count"
              >0</span
            >
          </div>
          <div id="mobile-trip-metrics" class="live-trip-metrics small">
            <!-- Metrics populated by JS -->
          </div>
        </div>

        <!-- Layer Controls -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">Map Layers</h3>
          </div>

          <!-- Map Style Selector -->
          <select
            id="mobile-map-type-select"
            class="mobile-select mb-3"
            aria-label="Select map style"
          >
            <option value="dark">Dark</option>
            <option value="light">Light</option>
            <option value="satellite">Satellite</option>
            <option value="streets">Streets</option>
          </select>

          <div class="mobile-layer-buttons" id="mobile-layer-toggles">
            <!-- Layer buttons populated by JS -->
          </div>

          <div class="mobile-toggle">
            <span class="mobile-toggle-label">Highlight Recent</span>
            <input type="checkbox" id="mobile-highlight-recent" checked />
          </div>
        </div>

        <!-- Street Coverage -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">Street Coverage</h3>
          </div>
          <select id="mobile-streets-location" class="mobile-select mb-3">
            <option value="">Select location...</option>
            <!-- Options populated by JS -->
          </select>

          <div class="mobile-street-modes">
            <button class="mobile-street-mode-btn" data-mode="undriven">
              <i class="fas fa-road"></i>
              <span>Undriven</span>
            </button>
            <button class="mobile-street-mode-btn" data-mode="driven">
              <i class="fas fa-check-circle"></i>
              <span>Driven</span>
            </button>
            <button class="mobile-street-mode-btn" data-mode="all">
              <i class="fas fa-layer-group"></i>
              <span>All</span>
            </button>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">Actions</h3>
          </div>
          <div class="mobile-action-grid">
            <button class="mobile-action-btn" id="mobile-download-view">
              <i class="fas fa-download"></i>
              <span>Download</span>
            </button>
            <button class="mobile-action-btn" id="mobile-view-trips">
              <i class="fas fa-list"></i>
              <span>View Trips</span>
            </button>
          </div>
        </div>

        <div class="mobile-pull-hint">Swipe down to close</div>
      </div>
    </div>
  </div>
</div>

<!-- Accessibility announcements -->
<div
  class="visually-hidden"
  aria-live="polite"
  aria-atomic="true"
  id="map-announcements"
></div>
{% endblock %} {% block head_content %}
<!-- Removed map-enhancements.css link from here as it's in base.html -->
<!-- Removed inline styles as they are now in external CSS files -->
{% endblock %} {% block extra_js %}
<script>
  // Make Mapbox access token available globally
  window.MAPBOX_ACCESS_TOKEN = "{{ MAPBOX_ACCESS_TOKEN }}";

  // Performance monitoring
  if ("PerformanceObserver" in window) {
    const observer = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        if (entry.entryType === "largest-contentful-paint") {
          console.log("LCP:", entry.startTime);
        }
      }
    });
    observer.observe({ entryTypes: ["largest-contentful-paint"] });
  }

  // Script for toggling chevron in metrics collapse
  document.addEventListener("DOMContentLoaded", function () {
    const metricsButton = document.querySelector(
      '[data-bs-target="#metrics-content"]',
    );
    if (metricsButton) {
      const chevron = metricsButton.querySelector(".fa-chevron-down");
      metricsButton.addEventListener("click", function () {
        const isExpanded =
          metricsButton.getAttribute("aria-expanded") === "true";
        if (chevron) {
          chevron.style.transform = isExpanded
            ? "rotate(0deg)"
            : "rotate(180deg)";
        }
      });
      // Initial state check for chevron if panel is collapsed by default
      if (metricsButton.getAttribute("aria-expanded") === "false" && chevron) {
        chevron.style.transform = "rotate(0deg)";
      } else if (chevron) {
        chevron.style.transform = "rotate(180deg)";
      }

      // Toggle Live Tracking Panel visibility based on user setting
      const liveTrackingPanel = document.getElementById("live-tracking-panel");
      function updateLiveTrackingVisibility() {
        if (!liveTrackingPanel) return;
        const showLiveTracking =
          window.localStorage.getItem("showLiveTracking");
        // Default: show panel unless setting exists and is explicitly "false"
        const shouldShow = showLiveTracking !== "false";
        liveTrackingPanel.classList.toggle("d-none", !shouldShow);
      }

      // Initial state
      updateLiveTrackingVisibility();

      // Fetch server-side setting once and reconcile localStorage
      (async () => {
        try {
          const res = await fetch("/api/app_settings");
          if (res.ok) {
            const data = await res.json();
            if (typeof data.showLiveTracking !== "undefined") {
              window.localStorage.setItem(
                "showLiveTracking",
                data.showLiveTracking,
              );
              updateLiveTrackingVisibility();
            }
          }
        } catch (err) {
          console.warn("Unable to sync showLiveTracking setting:", err);
        }
      })();

      // Respond to changes from other tabs/windows or settings page
      window.addEventListener("storage", (e) => {
        if (e.key === "showLiveTracking") {
          updateLiveTrackingVisibility();
        }
      });
    }
  });
</script>
<script src="{{ url_for('static', path='js/map-mobile.js') | replace('http://', '//') }}"></script>
{% endblock %}
